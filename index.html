<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ADHD ÌäπÏàòÍµêÏÇ¨ ÌÜµÌï© Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú Pro v2.0</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body { 
      margin: 0; 
      padding: 0; 
      background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #0a0e27 100%);
      font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      color: #e2e8f0;
      min-height: 100vh;
    }

    .app-container {
      width: min(100%, 1680px);
      margin: 0 auto;
      padding: clamp(14px, 2vw, 28px);
      min-height: 100vh;
    }

    .app-title {
      font-size: clamp(22px, 2.8vw, 36px);
    }

    .section-title {
      font-size: clamp(18px, 2vw, 24px);
      flex-wrap: wrap;
    }
    
    .scrollable {
      -webkit-overflow-scrolling: touch;
      overflow-y: auto;
    }
    
    button, input[type="checkbox"] {
      min-height: 44px;
      min-width: 44px;
    }
    
    #root {
      min-height: 100vh;
      min-height: -webkit-fill-available;
    }

    .editable-input {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.1);
      color: white;
      font-size: inherit;
      font-weight: inherit;
      width: 100%;
      outline: none;
      padding: 4px 8px;
      border-radius: 6px;
      transition: all 0.2s;
      font-family: inherit;
    }
    
    .editable-input:focus {
      border-color: #3b82f6;
      background: rgba(59, 130, 246, 0.1);
    }

    .draggable-task {
      cursor: move;
      transition: transform 0.2s, opacity 0.2s;
    }

    .draggable-task:active {
      opacity: 0.5;
      cursor: grabbing;
    }

    .stat-card {
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.1), transparent);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .stat-card:hover::before {
      opacity: 1;
    }

    .stat-card:hover {
      transform: translateY(-4px) scale(1.02);
      box-shadow: 0 20px 40px rgba(0,0,0,0.4);
    }

    /* Ï†ëÍ∏∞/ÌéºÏπòÍ∏∞ Ïï†ÎãàÎ©îÏù¥ÏÖò */
    .collapsible {
      overflow: hidden;
      transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s;
    }

    .collapsed {
      max-height: 0 !important;
      opacity: 0;
    }

    .collapse-toggle {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 8px 12px;
      background: rgba(139, 92, 246, 0.2);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 8px;
      color: #a78bfa;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
    }

    .collapse-toggle:hover {
      background: rgba(139, 92, 246, 0.3);
      transform: scale(1.05);
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-in {
      animation: slideInUp 0.4s ease-out;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.2s;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px;
      max-width: 900px;
      width: 95%;
      max-height: 90vh;
      overflow-y: auto;
      padding: 24px;
      animation: slideInUp 0.3s;
    }

    .progress-ring {
      transform: rotate(-90deg);
    }

    .progress-ring-circle {
      transition: stroke-dashoffset 0.5s;
    }

    input[type="range"] {
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: rgba(255,255,255,0.1);
      outline: none;
      -webkit-appearance: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #3b82f6;
      cursor: pointer;
    }

    input[type="range"]::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #3b82f6;
      cursor: pointer;
      border: none;
    }

    .token-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.2));
      border: 1px solid rgba(251, 191, 36, 0.3);
      border-radius: 20px;
      font-size: 14px;
      font-weight: 700;
      color: #fbbf24;
    }

    .level-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(124, 58, 237, 0.2));
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 20px;
      font-size: 14px;
      font-weight: 700;
      color: #a78bfa;
    }

    /* ÏãúÍ∞ÑÌëú Ïä§ÌÉÄÏùº */
    .timetable {
      display: grid;
      grid-template-columns: 80px repeat(5, 1fr);
      gap: 2px;
      background: rgba(0,0,0,0.3);
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    .timetable-cell {
      padding: 12px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      min-height: 100px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .timetable-cell:hover {
      background: rgba(59, 130, 246, 0.1);
      border-color: rgba(59, 130, 246, 0.3);
      transform: scale(1.02);
    }

    .timetable-header {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(99, 102, 241, 0.3));
      border: 1px solid rgba(59, 130, 246, 0.4);
      font-weight: 900;
      text-align: center;
      padding: 14px;
      font-size: 14px;
      color: #60a5fa;
    }

    .lesson-card {
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(168, 85, 247, 0.3));
      border: 1px solid rgba(139, 92, 246, 0.4);
      border-radius: 8px;
      padding: 10px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 6px;
    }

    .lesson-card:hover {
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.4), rgba(168, 85, 247, 0.4));
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
    }

    .lesson-card-title {
      font-weight: 700;
      color: #c4b5fd;
      margin-bottom: 4px;
      font-size: 13px;
    }

    .lesson-card-subtitle {
      font-size: 10px;
      color: rgba(255,255,255,0.7);
    }

    /* ÌïôÏÉù ÌèâÍ∞Ä Í∑∏Î¶¨Îìú */
    .student-eval-grid {
      display: grid;
      grid-template-columns: 120px repeat(6, 1fr);
      gap: 8px;
      margin-top: 16px;
    }

    .eval-cell {
      padding: 12px 8px;
      background: rgba(0,0,0,0.2);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 13px;
      font-weight: 600;
    }

    .eval-cell:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .eval-cell.selected {
      border-color: #3b82f6;
      background: rgba(59, 130, 246, 0.3);
      border-width: 2px;
      font-weight: 900;
    }

    .eval-score-0 { 
      background: linear-gradient(135deg, rgba(107, 114, 128, 0.3), rgba(75, 85, 99, 0.3)); 
      border-color: rgba(107, 114, 128, 0.5);
    }
    .eval-score-0.selected { background: rgba(107, 114, 128, 0.5); }
    
    .eval-score-1 { 
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.3), rgba(220, 38, 38, 0.3)); 
      border-color: rgba(239, 68, 68, 0.5);
    }
    .eval-score-1.selected { background: rgba(239, 68, 68, 0.5); }
    
    .eval-score-2 { 
      background: linear-gradient(135deg, rgba(251, 191, 36, 0.3), rgba(245, 158, 11, 0.3)); 
      border-color: rgba(251, 191, 36, 0.5);
    }
    .eval-score-2.selected { background: rgba(251, 191, 36, 0.5); }
    
    .eval-score-3 { 
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(37, 99, 235, 0.3)); 
      border-color: rgba(59, 130, 246, 0.5);
    }
    .eval-score-3.selected { background: rgba(59, 130, 246, 0.5); }
    
    .eval-score-4 { 
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.3), rgba(22, 163, 74, 0.3)); 
      border-color: rgba(34, 197, 94, 0.5);
    }
    .eval-score-4.selected { background: rgba(34, 197, 94, 0.5); }
    
    .eval-score-5 { 
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(5, 150, 105, 0.3)); 
      border-color: rgba(16, 185, 129, 0.5);
    }
    .eval-score-5.selected { background: rgba(16, 185, 129, 0.5); }

    /* ÌååÏùº ÏóÖÎ°úÎìú Î≤ÑÌäº Ïä§ÌÉÄÏùº */
    .file-input-label {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      border: none;
      border-radius: 10px;
      color: white;
      fontSize: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .file-input-label:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }

    input[type="file"] {
      display: none;
    }

    /* ÏïåÎ¶º Î∞∞ÎÑà */
    .alert-banner {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 12px;
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      font-weight: 700;
      font-size: 16px;
      box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
      z-index: 2000;
      animation: slideInRight 0.3s, pulse 1s infinite;
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(100px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    @keyframes pulse {
      0%, 100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.05);
      }
    }

    /* Ï∞®Ìä∏ Ïª®ÌÖåÏù¥ÎÑà */
    .chart-container {
      position: relative;
      height: clamp(240px, 30vw, 360px);
      margin: 20px 0;
      padding: 20px;
      background: rgba(0,0,0,0.2);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .chart-container canvas {
      width: 100% !important;
      height: 100% !important;
    }

    .chart-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .chart-actions .form-select {
      min-width: 140px;
      flex: 1 1 160px;
    }

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 16px;
    }

    .chart-container canvas {
      width: 100% !important;
      height: 100% !important;
    }

    .chart-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .chart-actions .form-select {
      min-width: 140px;
      flex: 1 1 160px;
    }

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 16px;
    }

    /* ÏßÑÌñâÎ•† ÏûêÎèô ÌëúÏãú */
    .auto-progress-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2));
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      color: #10b981;
    }

    /* Î∞òÏùëÌòï ÎîîÏûêÏù∏ - Î™®Î∞îÏùº ÏµúÏ†ÅÌôî */

    /* ÌñÑÎ≤ÑÍ±∞ Î©îÎâ¥ */
    .hamburger-menu {
      display: none;
      flex-direction: column;
      gap: 4px;
      padding: 10px;
      background: rgba(99, 102, 241, 0.3);
      border: 1px solid rgba(99, 102, 241, 0.5);
      border-radius: 8px;
      cursor: pointer;
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1001;
      min-height: 44px;
      min-width: 44px;
    }

    .hamburger-line {
      width: 25px;
      height: 3px;
      background: white;
      border-radius: 2px;
      transition: all 0.3s;
    }

    .mobile-nav-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.9);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      padding: 80px 20px calc(20px + env(safe-area-inset-bottom));
      overflow-y: auto;
    }

    .mobile-nav-close {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 32px;
      color: white;
      cursor: pointer;
      padding: 10px;
      min-height: 44px;
      min-width: 44px;
    }

    /* Í≤ÄÏÉâÎ∞î Ïä§ÌÉÄÏùº */
    .search-container {
      position: sticky;
      top: 0;
      z-index: 999;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(10px);
      padding: 12px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .search-input {
      width: 100%;
      padding: 12px 40px 12px 16px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      color: white;
      font-size: 14px;
      outline: none;
      transition: all 0.3s;
    }

    .search-input:focus {
      background: rgba(255, 255, 255, 0.15);
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .search-results {
      position: absolute;
      top: 100%;
      left: 20px;
      right: 20px;
      background: rgba(15, 23, 42, 0.98);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      margin-top: 8px;
      max-height: 400px;
      overflow-y: auto;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }

    .search-result-item {
      padding: 12px 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      cursor: pointer;
      transition: all 0.2s;
    }

    .search-result-item:hover {
      background: rgba(59, 130, 246, 0.2);
    }

    /* ÌïòÎã® ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò (Î™®Î∞îÏùº) */
    .bottom-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      padding: 8px 8px calc(8px + env(safe-area-inset-bottom));
      z-index: 100;
      box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.4);
    }

    .bottom-nav-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 4px;
    }

    .bottom-nav-btn {
      padding: 8px;
      min-height: 52px;
      min-width: 60px;
      background: transparent;
      border: none;
      border-radius: 8px;
      color: rgba(255, 255, 255, 0.7);
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      transition: all 0.2s;
    }

    .form-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 16px;
    }

    .form-control,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 12px 14px;
      border-radius: 10px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      font-size: 16px;
      line-height: 1.4;
    }

    .form-textarea {
      resize: vertical;
      min-height: 120px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 4px;
    }

    .form-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 16px;
    }

    .form-control,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 12px 14px;
      border-radius: 10px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      font-size: 16px;
      line-height: 1.4;
    }

    .form-textarea {
      resize: vertical;
      min-height: 120px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 4px;
    }

    .bottom-nav-btn.active {
      background: rgba(99, 102, 241, 0.3);
      color: white;
    }

    .bottom-nav-btn span {
      font-size: 20px;
    }

    /* ÌÉúÎ∏îÎ¶ø (768px - 1024px) */
    @media (max-width: 1024px) and (min-width: 768px) {
      .timetable {
        grid-template-columns: 70px repeat(5, 1fr);
        font-size: 12px;
      }

      .student-eval-grid {
        grid-template-columns: 100px repeat(6, 1fr);
        gap: 6px;
        font-size: 12px;
      }

      .modal-content {
        max-width: 700px;
        padding: 20px;
      }
    }

    /* Î™®Î∞îÏùº (<768px) */
    @media (max-width: 768px) {
      body {
        padding-bottom: 70px;
      }

      .app-container {
        padding: 16px 12px 80px;
      }

      .hamburger-menu {
        display: flex;
        top: 12px;
        right: 12px;
      }

      .bottom-nav {
        display: block;
      }

      .timetable {
        grid-template-columns: 50px repeat(5, 1fr);
        font-size: 10px;
        gap: 1px;
      }

      .student-eval-grid {
        grid-template-columns: 70px repeat(6, 1fr);
        gap: 3px;
        font-size: 10px;
      }

      .timetable-cell {
        min-height: 70px;
        padding: 6px;
      }

      .lesson-card {
        padding: 6px;
        font-size: 10px;
        margin-bottom: 4px;
      }

      .modal-content {
        max-width: 100%;
        width: 100%;
        max-height: 100vh;
        border-radius: 0;
        padding: 16px;
      }

      .chart-container {
        height: 240px;
        padding: 12px;
      }

      /* Ïπ¥Îìú Î∑∞Î°ú Î≥ÄÌôò */
      .mobile-card-view {
        display: block !important;
      }

      .mobile-card-item {
        padding: 16px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        margin-bottom: 12px;
      }

      /* ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Ïà®ÍπÄ (ÌïòÎã® ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò ÏÇ¨Ïö©) */
      .desktop-nav {
        display: none !important;
      }

      /* Í≤ÄÏÉâÎ∞î Î™®Î∞îÏùº ÏµúÏ†ÅÌôî */
      .search-container {
        padding: 10px 15px;
      }

      .search-input {
        font-size: 16px; /* iOS Ï§å Î∞©ÏßÄ */
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .calendar-grid {
        gap: 2px;
      }
    }

    /* Í∞ÄÎ°ú Î™®Îìú */
    @media (max-width: 768px) and (orientation: landscape) {
      .bottom-nav {
        padding: 4px;
      }

      .bottom-nav-btn {
        padding: 6px;
        font-size: 10px;
      }

      .bottom-nav-btn span {
        font-size: 16px;
      }
    }

    /* Ïä§ÏôÄÏù¥ÌîÑ Ï†úÏä§Ï≤ò ÏßÄÏõê */
    .swipeable {
      touch-action: pan-y;
      user-select: none;
    }

    .calendar-swipe {
      touch-action: pan-y;
    }

    .calendar-swipe {
      touch-action: pan-y;
    }

    /* ÌÑ∞Ïπò ÌîºÎìúÎ∞± */
    @media (hover: none) and (pointer: coarse) {
      button:active, .clickable:active {
        transform: scale(0.95);
        opacity: 0.8;
      }
    }

    /* Ïä§ÌÅ¨Î°§Î∞î Ïä§ÌÉÄÏùº */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(0,0,0,0.2);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #6366f1, #4f46e5);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, #4f46e5, #4338ca);
    }
  </style>
</head>
<body>
  <div id="root">
    <div style="display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #0a0e27 100%); color: white; font-family: sans-serif;">
      <div style="text-align: center;">
        <h1 style="font-size: 36px; margin-bottom: 20px;">‚è≥ Î°úÎî© Ï§ë...</h1>
        <p style="color: rgba(255,255,255,0.7);">ÏãúÏä§ÌÖúÏùÑ Î∂àÎü¨Ïò§Í≥† ÏûàÏäµÎãàÎã§.</p>
      </div>
    </div>
  </div>
<script type="text/babel">
    console.log('üöÄ Script started loading...');

    const { useEffect, useMemo, useRef, useState, useCallback } = React;
    console.log('‚úì React hooks imported');

    const LS_KEY = "adhd_pro_manager_v2_upgraded";

    function nowMs() { return Date.now(); }
    function uuid() {
      return Math.random().toString(16).slice(2) + "-" + Math.random().toString(16).slice(2);
    }

    function toLocalDatetimeValue(ts) {
      if (!ts) return "";
      const d = new Date(ts);
      const pad = (n) => String(n).padStart(2, "0");
      return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    }

    function fromLocalDatetimeValue(v) {
      if (!v) return null;
      const t = new Date(v).getTime();
      return Number.isFinite(t) ? t : null;
    }

    function toLocalDateValue(ts) {
      if (!ts) return "";
      const d = new Date(ts);
      const pad = (n) => String(n).padStart(2, "0");
      return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
    }

    function clamp01(x) { return Math.min(1, Math.max(0, x)); }

    function formatDateTime(timestamp) {
      if (!timestamp) return '';
      const date = new Date(timestamp);
      return date.toLocaleString('ko-KR', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
      });
    }

    function startOfWeek(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = (day === 0 ? -6 : 1) - day;
      d.setDate(d.getDate() + diff);
      d.setHours(0, 0, 0, 0);
      return d;
    }

    function addDays(date, days) {
      const d = new Date(date);
      d.setDate(d.getDate() + days);
      return d;
    }

    function isSameDay(a, b) {
      if (!a || !b) return false;
      const da = new Date(a);
      const db = new Date(b);
      return da.getFullYear() === db.getFullYear() &&
        da.getMonth() === db.getMonth() &&
        da.getDate() === db.getDate();
    }

    function getDayLabel(date) {
      const day = new Date(date).getDay();
      if (day === 0) return 'Ïùº';
      if (day === 6) return 'ÌÜ†';
      return DAYS_OF_WEEK[day - 1];
    }

    // Ï£ºÍ∞Ñ Ïù¥Î¶Ñ Í∞ÄÏ†∏Ïò§Í∏∞ (Î™©ÏöîÏùº Í∏∞Ï§Ä 0Ïõî 0Ï£ºÏ∞®)
    function getWeekLabel(weekStartDate) {
      // Ìï¥Îãπ Ï£ºÏùò Î™©ÏöîÏùº Ï∞æÍ∏∞ (ÏõîÏöîÏùº Í∏∞Ï§Ä ÏãúÏûëÏù¥ÎØÄÎ°ú +3Ïùº)
      const thursday = addDays(weekStartDate, 3);
      const month = thursday.getMonth() + 1; // 0-basedÏù¥ÎØÄÎ°ú +1

      // Í∑∏ Îã¨Ïùò Ï≤´ Î≤àÏß∏ Î™©ÏöîÏùº Ï∞æÍ∏∞
      const firstDayOfMonth = new Date(thursday.getFullYear(), thursday.getMonth(), 1);
      let firstThursday = new Date(firstDayOfMonth);
      const dayOfWeek = firstDayOfMonth.getDay();
      // Î™©ÏöîÏùºÏùÄ 4 (Ïùº=0, Ïõî=1, ... Î™©=4)
      const daysUntilThursday = (4 - dayOfWeek + 7) % 7;
      firstThursday.setDate(1 + daysUntilThursday);

      // Ï£ºÏ∞® Í≥ÑÏÇ∞
      const weekNumber = Math.floor((thursday.getDate() - firstThursday.getDate()) / 7) + 1;

      return `${month}Ïõî ${weekNumber}Ï£ºÏ∞®`;
    }

    // ÏïåÎ¶º Í∂åÌïú ÏöîÏ≤≠
    function requestNotificationPermission() {
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
      }
    }

    // ÏïåÎ¶º ÌëúÏãú (ÏÜåÎ¶¨ + ÏßÑÎèô + ÏãúÍ∞ÅÏ†Å ÏïåÎ¶º)
    function showNotification(title, body, options = {}) {
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(title, {
          body,
          icon: 'üöó',
          badge: '‚è∞',
          vibrate: [200, 100, 200, 100, 200],
          requireInteraction: true,
          tag: options.tag || 'default',
          ...options
        });
      }
      
      // ÏïåÎ¶ºÏùå Ïû¨ÏÉù
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
      } catch (e) {
        console.log('Audio notification failed:', e);
      }
    }

    const CATEGORIES = {
      IEP: { label: 'IEP ÌèâÍ∞Ä', icon: 'üìã', color: '#3b82f6' },
      PBS: { label: 'PBS ÏûëÏóÖ', icon: 'üéØ', color: '#8b5cf6' },
      SUPERVISION: { label: 'ÏàòÌçºÎπÑÏ†Ñ', icon: 'üë•', color: '#ec4899' },
      PLATFORM: { label: 'ÌîåÎû´Ìèº Í∞úÎ∞ú', icon: 'üíª', color: '#10b981' },
      BEHAVIOR: { label: 'ÌñâÎèôÏ§ëÏû¨', icon: 'üìä', color: '#f59e0b' },
      ADMIN: { label: 'ÌñâÏ†ïÏóÖÎ¨¥', icon: 'üìÅ', color: '#6366f1' },
      STUDENT: { label: 'ÌïôÏÉù ÏßÄÏõê', icon: 'üéì', color: '#06b6d4' },
      RESEARCH: { label: 'Ïó∞Íµ¨/ÏûêÎ£å', icon: 'üî¨', color: '#84cc16' },
      TEACHING: { label: 'ÏàòÏóÖ Ï§ÄÎπÑ', icon: 'üë®‚Äçüè´', color: '#f43f5e' },
      LECTURE: { label: 'Í∞ïÏùò ÌôúÎèô', icon: 'üé§', color: '#14b8a6' },
      PERSONAL: { label: 'Í∞úÏù∏ ÏÉùÌôú', icon: 'üè†', color: '#a855f7' },
    };

    const PRIORITIES = {
      URGENT: { label: 'Í∏¥Í∏â', icon: 'üî¥', value: 4 },
      HIGH: { label: 'ÎÜíÏùå', icon: 'üü†', value: 3 },
      MEDIUM: { label: 'Î≥¥ÌÜµ', icon: 'üü°', value: 2 },
      LOW: { label: 'ÎÇÆÏùå', icon: 'üü¢', value: 1 },
    };

    const DAYS_OF_WEEK = ['Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à'];
    const PERIODS = ['1ÍµêÏãú', '2ÍµêÏãú', '3ÍµêÏãú', '4ÍµêÏãú', '5ÍµêÏãú', '6ÍµêÏãú', '7ÍµêÏãú'];

    // Í≥ºÎ™© Î™©Î°ù Î∞è ÏÉâÏÉÅ
    const SUBJECTS = {
      'ÏùòÏÇ¨ÏÜåÌÜµ': { color: '#ef4444', label: 'ÏùòÏÇ¨ÏÜåÌÜµ' },
      'ÏûêÎ¶ΩÏÉùÌôú': { color: '#f97316', label: 'ÏûêÎ¶ΩÏÉùÌôú' },
      'Ïã†Ï≤¥ÌôúÎèô': { color: '#f59e0b', label: 'Ïã†Ï≤¥ÌôúÎèô' },
      'Ïó¨Í∞ÄÌôúÎèô': { color: '#eab308', label: 'Ïó¨Í∞ÄÌôúÎèô' },
      'ÏûêÏú®': { color: '#84cc16', label: 'ÏûêÏú®' },
      'ÎèôÏïÑÎ¶¨': { color: '#22c55e', label: 'ÎèôÏïÑÎ¶¨' },
      'Î¥âÏÇ¨': { color: '#10b981', label: 'Î¥âÏÇ¨' },
      'ÏßÑÎ°ú': { color: '#14b8a6', label: 'ÏßÑÎ°ú' },
      'Î∞îÎ•∏ÏÉùÌôú': { color: '#06b6d4', label: 'Î∞îÎ•∏ÏÉùÌôú' },
      'Ïä¨Í∏∞Î°úÏö¥ÏÉùÌôú': { color: '#0ea5e9', label: 'Ïä¨Í∏∞Î°úÏö¥ÏÉùÌôú' },
      'Ï¶êÍ±∞Ïö¥ ÏÉùÌôú': { color: '#3b82f6', label: 'Ï¶êÍ±∞Ïö¥ ÏÉùÌôú' },
      'Ïã§Í≥º': { color: '#6366f1', label: 'Ïã§Í≥º' },
      'Íµ≠Ïñ¥': { color: '#8b5cf6', label: 'Íµ≠Ïñ¥' },
      'ÏÇ¨Ìöå': { color: '#a855f7', label: 'ÏÇ¨Ìöå' },
      'ÏàòÌïô': { color: '#c026d3', label: 'ÏàòÌïô' },
      'Í≥ºÌïô': { color: '#d946ef', label: 'Í≥ºÌïô' },
      'ÏßÑÏßÅ': { color: '#e879f9', label: 'ÏßÑÏßÅ' },
      'Ï≤¥Ïú°': { color: '#ec4899', label: 'Ï≤¥Ïú°' },
      'ÏùåÏïÖ': { color: '#f43f5e', label: 'ÏùåÏïÖ' },
      'ÎØ∏Ïà†': { color: '#fb7185', label: 'ÎØ∏Ïà†' },
      'Ïû¨Ìôú': { color: '#f87171', label: 'Ïû¨Ìôú' },
      'Ïó¨Í∞Ä': { color: '#fbbf24', label: 'Ïó¨Í∞Ä' },
      'Ï†ïÎ≥¥': { color: '#facc15', label: 'Ï†ïÎ≥¥' },
      'ÏÉùÌôúÏòÅÏñ¥': { color: '#a3e635', label: 'ÏÉùÌôúÏòÅÏñ¥' },
      'Î≥¥Í±¥': { color: '#4ade80', label: 'Î≥¥Í±¥' },
      'Ïä§Ìè¨Ï∏†': { color: '#34d399', label: 'Ïä§Ìè¨Ï∏†' },
      'Ï£ºÏ†úÏÑ†ÌÉù': { color: '#2dd4bf', label: 'Ï£ºÏ†úÏÑ†ÌÉù' },
      'ÏßÑÎ°úÌÉêÏÉâ': { color: '#22d3ee', label: 'ÏßÑÎ°úÌÉêÏÉâ' },
      'ÏòàÏà†Ï≤¥Ïú°': { color: '#38bdf8', label: 'ÏòàÏà†Ï≤¥Ïú°' },
      'ÏßÅÏóÖ': { color: '#60a5fa', label: 'ÏßÅÏóÖ' },
      'Í∏∞Ï¥àÏûëÏóÖ': { color: '#818cf8', label: 'Í∏∞Ï¥àÏûëÏóÖ' },
      'ÏßÅÏóÖÏ§ÄÎπÑ': { color: '#a78bfa', label: 'ÏßÅÏóÖÏ§ÄÎπÑ' },
      'ÏÇ¨Î¨¥ÏßÄÏõê': { color: '#c4b5fd', label: 'ÏÇ¨Î¨¥ÏßÄÏõê' },
      'Ïô∏ÏãùÏÑúÎπÑÏä§': { color: '#d8b4fe', label: 'Ïô∏ÏãùÏÑúÎπÑÏä§' },
      'ÎåÄÏù∏ÏÑúÎπÑÏä§': { color: '#e9d5ff', label: 'ÎåÄÏù∏ÏÑúÎπÑÏä§' },
      'Ï†ïÎ≥¥Ï≤òÎ¶¨': { color: '#f0abfc', label: 'Ï†ïÎ≥¥Ï≤òÎ¶¨' },
      'Î∞©Í≥ºÌõÑ': { color: '#f9a8d4', label: 'Î∞©Í≥ºÌõÑ' },
    };

    const EVAL_SCORES = {
      0: { label: 'Í≤∞ÏÑù', color: '#6b7280', description: 'ÏàòÏóÖ Î∂àÏ∞∏' },
      1: { label: 'ÎØ∏Ï∞∏Ïó¨', color: '#ef4444', description: 'ÏàòÏóÖ Ï∞∏Ïó¨ÌïòÏßÄ ÏïäÏùå' },
      2: { label: 'ÎØ∏ÎèÑÎã¨', color: '#fbbf24', description: 'Î™©Ìëú ÎØ∏Îã¨ÏÑ±' },
      3: { label: 'ÏµúÎåÄÏ¥âÍµ¨', color: '#3b82f6', description: 'Ï†ÑÏ†ÅÏù∏ ÎèÑÏõÄ ÌïÑÏöî' },
      4: { label: 'ÏùºÎ∂ÄÏ¥âÍµ¨', color: '#22c55e', description: 'Î∂ÄÎ∂ÑÏ†Å ÎèÑÏõÄ ÌïÑÏöî' },
      5: { label: 'Î™©ÌëúÎã¨ÏÑ±', color: '#10b981', description: 'ÎèÖÎ¶ΩÏ†Å ÏàòÌñâ' },
    };

    // ÌñâÎèô Ïú†Ìòï (PBS/ÌñâÎèôÏßÄÏõê)
    const BEHAVIOR_TYPES = {
      TARGET: { label: 'ÌëúÏ†ÅÌñâÎèô', color: '#ef4444', icon: 'üéØ' },
      REPLACEMENT: { label: 'ÎåÄÏ≤¥ÌñâÎèô', color: '#10b981', icon: '‚ú®' },
      POSITIVE: { label: 'Í∏çÏ†ïÌñâÎèô', color: '#3b82f6', icon: 'üëç' },
    };

    // ÏùºÎ∞òÏ†ÅÏù∏ ÌñâÎèô Î™©Î°ù (Îπ†Î•∏ Ï∂îÍ∞ÄÏö©)
    const COMMON_BEHAVIORS = [
      'ÏÜåÎ¶¨ÏßÄÎ•¥Í∏∞', 'ÏûêÎ¶¨Ïù¥ÌÉà', 'Î¨ºÍ±¥ÎçòÏßÄÍ∏∞', 'ÏûêÌï¥ÌñâÎèô', 'Í≥µÍ≤©ÌñâÎèô',
      'Í≥ºÏ†úÍ±∞Î∂Ä', 'Ï£ºÏùòÏßëÏ§ë', 'Í∏çÏ†ïÏ†Å ÏÉÅÌò∏ÏûëÏö©', 'ÏßÄÏãúÎî∞Î•¥Í∏∞', 'ÏûêÍ∏∞Ï°∞Ï†à'
    ];

    // ÏùºÎ∞òÏ†ÅÏù∏ ÏÑ†ÌñâÏÇ¨Í±¥
    const COMMON_ANTECEDENTS = [
      'Í≥ºÏ†úÏ†úÏãú', 'ÎòêÎûòÏÉÅÌò∏ÏûëÏö©', 'Ï†ÑÌôòÏÉÅÌô©', 'ÏöîÍµ¨Í±∞Î∂Ä', 'Í∞êÍ∞ÅÏûêÍ∑π',
      'Í¥ÄÏã¨ÏöîÍµ¨', 'ÌöåÌîº', 'ÏòàÏ∏°Î∂àÍ∞ÄÎä•Ìïú ÏÉÅÌô©'
    ];

    // ÏùºÎ∞òÏ†ÅÏù∏ ÌõÑÏÜçÍ≤∞Í≥º
    const COMMON_CONSEQUENCES = [
      'Í¥ÄÏã¨Ï†úÍ≥µ', 'Í≥ºÏ†úÏ§ëÎã®', 'ÌÜ†ÌÅ∞Ï†úÍ≥µ', 'Íµ¨ÎëêÏπ≠Ï∞¨', 'Î¨¥Ïãú',
      'ÏßÑÏ†ïÏãúÍ∞Ñ', 'ÏÑ†ÌÉùÍ∂åÏ†úÍ≥µ', 'ÎåÄÏ≤¥ÌñâÎèôÏ¥âÍµ¨'
    ];

    const DEFAULT_STATE = {
      points: 0,
      level: 1,
      tasks: [],
      focus: {
        running: false,
        paused: false,
        durationSec: 120,
        startedTs: null,
        pausedAt: null,
        elapsedBeforePause: 0,
        taskId: null,
        note: "",
      },
      schedules: [],
      filters: {
        category: 'ALL',
        priority: 'ALL',
        searchText: '',
      },
      completedSprints: [],
      focusHistory: [], // ÏßëÏ§ë ÏÑ∏ÏÖò Ïù¥Î†• (Ï†ÄÏû•/ÏàòÏ†ï/ÏÇ≠Ï†ú Í∞ÄÎä•)
      scheduleHistory: [], // ÏùºÏ†ï Ïù¥Î†• (Ï†ÄÏû•/ÏàòÏ†ï/ÏÇ≠Ï†ú Í∞ÄÎä•)
      behaviorLog: [],
      lessons: [], // ÏàòÏóÖ Îç∞Ïù¥ÌÑ∞
      studentEvals: {}, // ÌïôÏÉùÎ≥Ñ ÌèâÍ∞Ä Îç∞Ïù¥ÌÑ∞ { lessonId: { studentId: score } }
      collapsedItems: {},
      alertedSchedules: {},
      recentSearches: [], // ÏµúÍ∑º Í≤ÄÏÉâ Í∏∞Î°ù (ÏµúÎåÄ 10Í∞ú)
      taskSortBy: 'deadline', // Í≥ºÏ†ú Ï†ïÎ†¨ Í∏∞Ï§Ä (deadline, priority, name, createdAt)
    };

    function loadState() {
      try {
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return DEFAULT_STATE;
        const parsed = JSON.parse(raw);
        if (!parsed || typeof parsed !== "object") return DEFAULT_STATE;
        
        return {
          ...DEFAULT_STATE,
          ...parsed,
          tasks: Array.isArray(parsed.tasks) ? parsed.tasks : DEFAULT_STATE.tasks,
          focus: { ...DEFAULT_STATE.focus, ...(parsed.focus || {}) },
          schedules: Array.isArray(parsed.schedules) ? parsed.schedules : DEFAULT_STATE.schedules,
          filters: { ...DEFAULT_STATE.filters, ...(parsed.filters || {}) },
          completedSprints: Array.isArray(parsed.completedSprints) ? parsed.completedSprints : [],
          focusHistory: Array.isArray(parsed.focusHistory) ? parsed.focusHistory : [],
          scheduleHistory: Array.isArray(parsed.scheduleHistory) ? parsed.scheduleHistory : [],
          behaviorLog: Array.isArray(parsed.behaviorLog) ? parsed.behaviorLog : [],
          lessons: Array.isArray(parsed.lessons) ? parsed.lessons : [],
          studentEvals: parsed.studentEvals || {},
          collapsedItems: parsed.collapsedItems || {},
          alertedSchedules: parsed.alertedSchedules || {},
          recentSearches: Array.isArray(parsed.recentSearches) ? parsed.recentSearches : [],
          taskSortBy: parsed.taskSortBy || DEFAULT_STATE.taskSortBy,
        };
      } catch {
        return DEFAULT_STATE;
      }
    }

    function saveState(st) {
      localStorage.setItem(LS_KEY, JSON.stringify(st));
    }

    // CSV ÎÇ¥Î≥¥ÎÇ¥Í∏∞/Í∞ÄÏ†∏Ïò§Í∏∞ Ìï®Ïàò
    function exportToCSV(data, filename) {
      const csvContent = data.map(row => row.map(cell => {
        const cellStr = String(cell || '');
        return cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')
          ? `"${cellStr.replace(/"/g, '""')}"`
          : cellStr;
      }).join(',')).join('\n');

      const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
    }

    function parseCSV(text) {
      // ÏûÖÎ†• Í≤ÄÏ¶ù
      if (!text || typeof text !== 'string') {
        throw new Error('Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ CSV ÌÖçÏä§Ìä∏ÏûÖÎãàÎã§.');
      }

      // BOM (Byte Order Mark) Ï†úÍ±∞
      if (text.charCodeAt(0) === 0xFEFF) {
        text = text.slice(1);
      }

      // Îπà ÌÖçÏä§Ìä∏ Ï≤òÎ¶¨
      if (text.trim().length === 0) {
        return [];
      }

      const rows = [];
      let currentRow = [];
      let currentCell = '';
      let inQuotes = false;
      let quoteStarted = false; // ÏÖÄÏù¥ Îî∞Ïò¥ÌëúÎ°ú ÏãúÏûëÌñàÎäîÏßÄ Ï∂îÏ†Å

      for (let i = 0; i < text.length; i++) {
        const char = text[i];
        const nextChar = text[i + 1];

        if (char === '"') {
          if (!inQuotes && currentCell === '') {
            // ÏÖÄÏùò ÏãúÏûë Î∂ÄÎ∂ÑÏóêÏÑú Îî∞Ïò¥Ìëú Î∞úÍ≤¨
            inQuotes = true;
            quoteStarted = true;
          } else if (inQuotes && nextChar === '"') {
            // Ïù¥Ïä§ÏºÄÏù¥ÌîÑÎêú Îî∞Ïò¥Ìëú ("" -> ")
            currentCell += '"';
            i++;
          } else if (inQuotes) {
            // Îî∞Ïò¥Ìëú Ï¢ÖÎ£å
            inQuotes = false;
          } else {
            // Îî∞Ïò¥ÌëúÎ°ú ÏãúÏûëÌïòÏßÄ ÏïäÏùÄ ÏÖÄ ÎÇ¥Î∂ÄÏùò Îî∞Ïò¥ÌëúÎäî Î¶¨ÌÑ∞Îü¥Î°ú Ï≤òÎ¶¨
            currentCell += char;
          }
        } else if (char === ',' && !inQuotes) {
          // ÌïÑÎìú Íµ¨Î∂ÑÏûê
          currentRow.push(currentCell);
          currentCell = '';
          quoteStarted = false;
        } else if ((char === '\n' || char === '\r') && !inQuotes) {
          // Ìñâ Ï¢ÖÎ£å
          currentRow.push(currentCell);

          // Îπà ÌñâÏù¥ ÏïÑÎãå Í≤ΩÏö∞Îßå Ï∂îÍ∞Ä (Î™®Îì† ÏÖÄÏù¥ ÎπÑÏñ¥ÏûàÏßÄ ÏïäÏùÄ Í≤ΩÏö∞)
          if (currentRow.some(cell => cell.trim() !== '')) {
            rows.push(currentRow);
          }

          currentRow = [];
          currentCell = '';
          quoteStarted = false;

          // CRLF Ï≤òÎ¶¨
          if (char === '\r' && nextChar === '\n') {
            i++;
          }
        } else {
          currentCell += char;
        }
      }

      // ÎßàÏßÄÎßâ ÏÖÄÍ≥º Ìñâ Ï≤òÎ¶¨
      if (currentCell || currentRow.length > 0) {
        currentRow.push(currentCell);
        // Îπà ÌñâÏù¥ ÏïÑÎãå Í≤ΩÏö∞Îßå Ï∂îÍ∞Ä
        if (currentRow.some(cell => cell.trim() !== '')) {
          rows.push(currentRow);
        }
      }

      // Îî∞Ïò¥ÌëúÍ∞Ä Ï†úÎåÄÎ°ú Îã´ÌûàÏßÄ ÏïäÏùÄ Í≤ΩÏö∞ Í≤ΩÍ≥†
      if (inQuotes) {
        console.warn('CSV ÌååÏã± Í≤ΩÍ≥†: Îã´ÌûàÏßÄ ÏïäÏùÄ Îî∞Ïò¥ÌëúÍ∞Ä Î∞úÍ≤¨ÎêòÏóàÏäµÎãàÎã§.');
      }

      // Ìñâ Í∏∏Ïù¥ Ï†ïÍ∑úÌôî (Í∞ÄÏû• Í∏¥ ÌñâÏùÑ Í∏∞Ï§ÄÏúºÎ°ú Îπà ÏÖÄ Ï∂îÍ∞Ä)
      const maxLength = Math.max(...rows.map(row => row.length));
      rows.forEach(row => {
        while (row.length < maxLength) {
          row.push('');
        }
      });

      return rows;
    }

    // ÏßÑÌñâÎ•† ÏûêÎèô Í≥ÑÏÇ∞ (ÏÑ∏Î∂Ä Îã®Í≥Ñ Í∏∞Î∞ò)
    function calculateAutoProgress(task) {
      if (!task.steps || task.steps.length === 0) return task.progress || 0;
      const completed = task.steps.filter(s => s.done).length;
      return Math.round((completed / task.steps.length) * 100);
    }

    // ÌñâÎèô Î°úÍ∑∏ CSV ÎÇ¥Î≥¥ÎÇ¥Í∏∞
    function exportBehaviorLogCSV(behaviorLog) {
      const headers = ['ID', 'ÎÇ†ÏßúÏãúÍ∞Ñ', 'ÌïôÏÉùÏù¥Î¶Ñ', 'ÌñâÎèôÏú†Ìòï', 'ÏÑ†ÌñâÏÇ¨Í±¥', 'ÌñâÎèô', 'ÌõÑÏÜçÍ≤∞Í≥º', 'ÎπàÎèÑ', 'Í∞ïÎèÑ', 'ÏßÄÏÜçÏãúÍ∞Ñ(Î∂Ñ)', 'Ï§ëÏû¨ÎÖ∏Ìä∏'];
      const rows = [headers];

      behaviorLog.forEach(log => {
        rows.push([
          log.id,
          new Date(log.timestamp).toLocaleString('ko-KR'),
          log.studentName || '',
          BEHAVIOR_TYPES[log.behaviorType]?.label || log.behaviorType,
          log.antecedent || '',
          log.behavior || '',
          log.consequence || '',
          log.frequency || 1,
          log.intensity || 1,
          log.duration || 0,
          log.interventionNote || ''
        ]);
      });

      exportToCSV(rows, `ÌñâÎèôÎ°úÍ∑∏_${new Date().toISOString().slice(0,10)}.csv`);
    }

    // Ï∞®Ìä∏Î•º PNGÎ°ú ÎÇ¥Î≥¥ÎÇ¥Í∏∞
    function exportChartAsPNG(chartId, filename) {
      const canvas = document.getElementById(chartId);
      if (canvas) {
        const link = document.createElement('a');
        link.download = filename;
        link.href = canvas.toDataURL('image/png');
        link.click();
      }
    }

    // ÏõêÌòï ÌÉÄÏù¥Î®∏ Ïª¥Ìè¨ÎÑåÌä∏
    function CircularTimer({ remainingMs, totalMs, size = 200 }) {
      const progress = totalMs > 0 ? clamp01(remainingMs / totalMs) : 1;
      const radius = (size - 20) / 2;
      const circumference = 2 * Math.PI * radius;
      const offset = circumference * (1 - progress);
      
      const minutes = Math.floor(remainingMs / 60000);
      const seconds = Math.floor((remainingMs % 60000) / 1000);

      return (
        <div style={{ position: 'relative', width: size, height: size, margin: '0 auto' }}>
          <svg width={size} height={size} style={{ transform: 'rotate(-90deg)' }}>
            <circle
              cx={size / 2}
              cy={size / 2}
              r={radius}
              fill="none"
              stroke="rgba(255,255,255,0.1)"
              strokeWidth="10"
            />
            <circle
              cx={size / 2}
              cy={size / 2}
              r={radius}
              fill="none"
              stroke={progress > 0.5 ? '#10b981' : progress > 0.2 ? '#f59e0b' : '#ef4444'}
              strokeWidth="10"
              strokeDasharray={circumference}
              strokeDashoffset={offset}
              style={{ transition: 'stroke-dashoffset 0.3s linear, stroke 0.3s' }}
            />
          </svg>
          <div style={{
            position: 'absolute',
            top: '50%',
            left: '50%',
            transform: 'translate(-50%, -50%)',
            textAlign: 'center',
          }}>
            <div style={{ fontSize: 48, fontWeight: 900, color: 'white' }}>
              {String(minutes).padStart(2, '0')}:{String(seconds).padStart(2, '0')}
            </div>
            <div style={{ fontSize: 14, color: 'rgba(255,255,255,0.7)', marginTop: 8 }}>
              {progress > 0.5 ? 'ÏßëÏ§ë Ï§ë!' : progress > 0.2 ? 'Ï°∞Í∏àÎßå Îçî!' : 'Í±∞Ïùò Îã§ ÏôîÏñ¥Ïöî!'}
            </div>
          </div>
        </div>
      );
    }

    // Ï∂úÎ∞ú ÏïåÎûå Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ Î∞î (ÏàòÏ†ï: ÏïåÎûå Í∏∞Îä• Í∞ïÌôî)
    function CountdownBar({ schedule, now, onAlert }) {
      if (!schedule.arrivalTs) return null;

      const departTs = schedule.arrivalTs - schedule.departBeforeMin * 60 * 1000;
      const remaining = departTs - now;
      const totalTime = schedule.departBeforeMin * 60 * 1000;
      const progress = Math.max(0, Math.min(1, remaining / totalTime));

      const isPast = remaining < 0;
      const isUrgent = remaining > 0 && remaining < 15 * 60 * 1000;
      const isDepartTime = remaining <= 0 && remaining > -2000; // ÏïåÎûå ÏúàÎèÑÏö∞: Ï∂úÎ∞ú ÏãúÍ∞Ñ Ï†ÑÌõÑ 2Ï¥à

      useEffect(() => {
        if (isDepartTime && onAlert) {
          onAlert(schedule.id);
        }
      }, [isDepartTime, schedule.id, onAlert]);

      const hrs = Math.floor(Math.abs(remaining) / (1000 * 60 * 60));
      const mins = Math.floor((Math.abs(remaining) % (1000 * 60 * 60)) / (1000 * 60));

      return (
        <div style={{
          padding: 16,
          borderRadius: 12,
          background: isPast ? 'rgba(239, 68, 68, 0.2)' : isUrgent ? 'rgba(251, 191, 36, 0.2)' : 'rgba(16, 185, 129, 0.2)',
          border: `2px solid ${isPast ? '#ef4444' : isUrgent ? '#fbbf24' : '#10b981'}`,
          marginBottom: 12,
          animation: isUrgent ? 'pulse 1s infinite' : 'none',
        }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 8 }}>
            <div style={{ fontSize: 16, fontWeight: 700, color: 'white' }}>
              {schedule.name}
            </div>
            <div style={{ fontSize: 13, color: 'rgba(255,255,255,0.8)' }}>
              {new Date(schedule.arrivalTs).toLocaleString('ko-KR', { 
                month: 'long', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
              })}
            </div>
          </div>

          <div style={{
            height: 10,
            borderRadius: 5,
            background: 'rgba(0,0,0,0.3)',
            overflow: 'hidden',
            marginBottom: 10,
          }}>
            <div style={{
              height: '100%',
              width: `${progress * 100}%`,
              background: isPast ? 'linear-gradient(90deg, #ef4444, #dc2626)' : 
                         isUrgent ? 'linear-gradient(90deg, #fbbf24, #f59e0b)' : 
                         'linear-gradient(90deg, #10b981, #059669)',
              transition: 'width 1s linear',
            }} />
          </div>

          <div style={{ fontSize: 14, color: 'rgba(255,255,255,0.95)', fontWeight: 700 }}>
            {isPast ? (
              <span>‚ö†Ô∏è Ï∂úÎ∞ú ÏãúÍ∞Ñ {hrs > 0 ? `${hrs}ÏãúÍ∞Ñ ` : ''}{mins}Î∂Ñ ÏßÄÎÇ®</span>
            ) : (
              <span>
                {isUrgent && '‚è∞ '}
                Ï∂úÎ∞úÍπåÏßÄ {hrs > 0 ? `${hrs}ÏãúÍ∞Ñ ` : ''}{mins}Î∂Ñ ÎÇ®Ïùå
              </span>
            )}
          </div>
        </div>
      );
    }

    // Ï∫òÎ¶∞Îçî Ïª¥Ìè¨ÎÑåÌä∏
    function Calendar({ tasks, schedules, lessons }) {
      const [currentMonth, setCurrentMonth] = useState(new Date());
      const touchStartXRef = useRef(null);
      const touchStartYRef = useRef(null);

      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth();

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDay = firstDay.getDay();
      const daysInMonth = lastDay.getDate();

      const prevMonth = () => setCurrentMonth(new Date(year, month - 1, 1));
      const nextMonth = () => setCurrentMonth(new Date(year, month + 1, 1));

      const handleTouchStart = (event) => {
        if (!event.touches || event.touches.length === 0) return;
        const touch = event.touches[0];
        touchStartXRef.current = touch.clientX;
        touchStartYRef.current = touch.clientY;
      };

      const handleTouchEnd = (event) => {
        if (touchStartXRef.current === null || touchStartYRef.current === null) return;
        if (!event.changedTouches || event.changedTouches.length === 0) return;
        const touch = event.changedTouches[0];
        const deltaX = touch.clientX - touchStartXRef.current;
        const deltaY = touch.clientY - touchStartYRef.current;
        if (Math.abs(deltaX) > 50 && Math.abs(deltaX) > Math.abs(deltaY)) {
          if (deltaX > 0) {
            prevMonth();
          } else {
            nextMonth();
          }
        }
        touchStartXRef.current = null;
        touchStartYRef.current = null;
      };

      const days = [];
      for (let i = 0; i < startDay; i++) {
        days.push(<div key={`empty-${i}`} style={{ padding: 8 }} />);
      }

      for (let day = 1; day <= daysInMonth; day++) {
        const dayTasks = tasks.filter(t => {
          if (!t.deadline) return false;
          const d = new Date(t.deadline);
          return d.getFullYear() === year && d.getMonth() === month && d.getDate() === day;
        });

        const daySchedules = schedules.filter(s => {
          if (!s.arrivalTs) return false;
          const d = new Date(s.arrivalTs);
          return d.getFullYear() === year && d.getMonth() === month && d.getDate() === day;
        });

        const dayLessons = lessons.filter(l => {
          if (!l.date) return false;
          const d = new Date(l.date);
          return d.getFullYear() === year && d.getMonth() === month && d.getDate() === day;
        });

        const isToday = new Date().toDateString() === new Date(year, month, day).toDateString();

        days.push(
          <div
            key={day}
            style={{
              padding: 8,
              borderRadius: 8,
              background: isToday ? 'rgba(59, 130, 246, 0.2)' : 'rgba(255,255,255,0.02)',
              border: isToday ? '2px solid #3b82f6' : '1px solid rgba(255,255,255,0.05)',
              minHeight: 100,
            }}
          >
            <div style={{ 
              fontSize: 14, 
              fontWeight: isToday ? 900 : 700, 
              color: isToday ? '#3b82f6' : 'white',
              marginBottom: 6,
            }}>
              {day}
            </div>

            {dayTasks.map(t => (
              <div
                key={t.id}
                style={{
                  fontSize: 10,
                  padding: '3px 6px',
                  borderRadius: 4,
                  background: CATEGORIES[t.category]?.color || '#6b7280',
                  color: 'white',
                  marginBottom: 2,
                  overflow: 'hidden',
                  textOverflow: 'ellipsis',
                  whiteSpace: 'nowrap',
                }}
                title={t.title}
              >
                {t.title}
              </div>
            ))}

            {daySchedules.map(s => (
              <div
                key={s.id}
                style={{
                  fontSize: 10,
                  padding: '3px 6px',
                  borderRadius: 4,
                  background: '#10b981',
                  color: 'white',
                  marginBottom: 2,
                  overflow: 'hidden',
                  textOverflow: 'ellipsis',
                  whiteSpace: 'nowrap',
                }}
                title={s.name}
              >
                üöó {s.name}
              </div>
            ))}

            {dayLessons.map(l => (
              <div
                key={l.id}
                style={{
                  fontSize: 10,
                  padding: '3px 6px',
                  borderRadius: 4,
                  background: '#8b5cf6',
                  color: 'white',
                  marginBottom: 2,
                  overflow: 'hidden',
                  textOverflow: 'ellipsis',
                  whiteSpace: 'nowrap',
                }}
                title={l.subject}
              >
                üë®‚Äçüè´ {l.subject}
              </div>
            ))}
          </div>
        );
      }

      return (
        <div className="swipeable calendar-swipe" onTouchStart={handleTouchStart} onTouchEnd={handleTouchEnd}>
          <div className="calendar-header" style={{ marginBottom: 16 }}>
            <button
              style={{
                padding: '10px 18px',
                background: 'rgba(255,255,255,0.1)',
                border: '1px solid rgba(255,255,255,0.2)',
                borderRadius: 10,
                color: 'white',
                cursor: 'pointer',
                fontSize: 14,
                fontWeight: 700,
              }}
              onClick={prevMonth}
            >
              ‚óÄ Ïù¥Ï†Ñ
            </button>
            <div style={{ fontSize: 20, fontWeight: 900, color: 'white' }}>
              {year}ÎÖÑ {month + 1}Ïõî
            </div>
            <button
              style={{
                padding: '10px 18px',
                background: 'rgba(255,255,255,0.1)',
                border: '1px solid rgba(255,255,255,0.2)',
                borderRadius: 10,
                color: 'white',
                cursor: 'pointer',
                fontSize: 14,
                fontWeight: 700,
              }}
              onClick={nextMonth}
            >
              Îã§Ïùå ‚ñ∂
            </button>
          </div>

          <div className="calendar-grid">
            {['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†'].map(d => (
              <div key={d} style={{ 
                textAlign: 'center', 
                fontSize: 13, 
                fontWeight: 700, 
                color: 'rgba(255,255,255,0.7)',
                padding: 8,
              }}>
                {d}
              </div>
            ))}
            {days}
          </div>
        </div>
      );
    }

    console.log('‚úì All helper components defined');

    // Î©îÏù∏ App Ïª¥Ìè¨ÎÑåÌä∏
    function App() {
      console.log('üéØ App component rendering...');
      const [state, setState] = useState(() => {
        console.log('üì¶ Loading state from localStorage...');
        const loadedState = loadState();
        console.log('‚úì State loaded:', {
          tasks: loadedState.tasks?.length,
          lessons: loadedState.lessons?.length,
          points: loadedState.points
        });
        return loadedState;
      });
      const [view, setView] = useState('dashboard');
      const [tick, setTick] = useState(0);
      const [editingLesson, setEditingLesson] = useState(null);
      const [showAlert, setShowAlert] = useState(null);
      const [selectedStudent, setSelectedStudent] = useState(null);
      const [searchQuery, setSearchQuery] = useState('');
      const [searchResults, setSearchResults] = useState([]);
      const [showSearch, setShowSearch] = useState(false);
      const [editingBehavior, setEditingBehavior] = useState(null);
      const [showMobileMenu, setShowMobileMenu] = useState(false);
      const [behaviorFilter, setBehaviorFilter] = useState({ dateRange: 30, student: 'ALL', chartType: 'daily' });
      const [reportType, setReportType] = useState('weekly');
      const [lessonWeekStart, setLessonWeekStart] = useState(() => startOfWeek(new Date()));
      const [behaviorWeekStart, setBehaviorWeekStart] = useState(() => startOfWeek(new Date()));
      const [behaviorWeekStudent, setBehaviorWeekStudent] = useState('ALL');
      const [scheduleDraft, setScheduleDraft] = useState({
        name: '',
        arrivalTs: '',
        departBeforeMin: 30,
        location: '',
        note: '',
      });
      const [focusDraft, setFocusDraft] = useState({
        durationMin: 25,
        note: '',
      });
      const [editingFocusHistory, setEditingFocusHistory] = useState(null);
      const [editingScheduleHistory, setEditingScheduleHistory] = useState(null);
      const [showFocusComplete, setShowFocusComplete] = useState(false);
      const searchInputRef = useRef(null);
      const lineChartRef = useRef(null);

      useEffect(() => {
        saveState(state);
      }, [state]);

      // 1Ï¥àÎßàÎã§ Ìã± ÏóÖÎç∞Ïù¥Ìä∏ (ÏïåÎûå Ï≤¥ÌÅ¨Ïö©)
      useEffect(() => {
        const iv = setInterval(() => setTick(t => t + 1), 1000);
        return () => clearInterval(iv);
      }, []);

      useEffect(() => {
        requestNotificationPermission();
      }, []);

      // ÌÇ§Î≥¥Îìú Îã®Ï∂ïÌÇ§ (Ctrl/Cmd + KÎ°ú Í≤ÄÏÉâ Ïó¥Í∏∞)
      useEffect(() => {
        const handleKeyDown = (e) => {
          if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
            e.preventDefault();
            setShowSearch(true);
            setTimeout(() => searchInputRef.current?.focus(), 100);
          }
          if (e.key === 'Escape' && showSearch) {
            setShowSearch(false);
            setSearchQuery('');
            setSearchResults([]);
          }
        };
        window.addEventListener('keydown', handleKeyDown);
        return () => window.removeEventListener('keydown', handleKeyDown);
      }, [showSearch]);

      // Ïã§ÏãúÍ∞Ñ Í≤ÄÏÉâ Í∏∞Îä•
      useEffect(() => {
        if (!searchQuery.trim()) {
          setSearchResults([]);
          return;
        }

        const query = searchQuery.toLowerCase();
        const results = [];

        // ÏàòÏóÖ Í≤ÄÏÉâ
        state.lessons.forEach(lesson => {
          if (lesson.subject?.toLowerCase().includes(query) ||
              lesson.topic?.toLowerCase().includes(query) ||
              lesson.goal?.toLowerCase().includes(query)) {
            results.push({
              type: 'ÏàòÏóÖ',
              title: lesson.subject,
              subtitle: `${lesson.dayOfWeek}ÏöîÏùº ${lesson.period} - ${lesson.topic || ''}`,
              data: lesson,
              action: () => { setEditingLesson(lesson); setShowSearch(false); }
            });
          }
        });

        // Í≥ºÏ†ú Í≤ÄÏÉâ
        state.tasks.forEach(task => {
          if (task.title?.toLowerCase().includes(query)) {
            results.push({
              type: 'Í≥ºÏ†ú',
              title: task.title,
              subtitle: `${CATEGORIES[task.category]?.label} - ${PRIORITIES[task.priority]?.label}`,
              data: task,
              action: () => { setView('tasks'); setShowSearch(false); }
            });
          }
        });

        // ÏùºÏ†ï Í≤ÄÏÉâ
        state.schedules.forEach(schedule => {
          if (schedule.name?.toLowerCase().includes(query)) {
            results.push({
              type: 'ÏùºÏ†ï',
              title: schedule.name,
              subtitle: new Date(schedule.arrivalTs).toLocaleString('ko-KR'),
              data: schedule,
              action: () => { setView('schedule'); setShowSearch(false); }
            });
          }
        });

        // ÌñâÎèô Î°úÍ∑∏ Í≤ÄÏÉâ
        state.behaviorLog.forEach(log => {
          if (log.behavior?.toLowerCase().includes(query) ||
              log.studentName?.toLowerCase().includes(query) ||
              log.interventionNote?.toLowerCase().includes(query)) {
            results.push({
              type: 'ÌñâÎèô',
              title: `${log.studentName} - ${log.behavior}`,
              subtitle: new Date(log.timestamp).toLocaleString('ko-KR'),
              data: log,
              action: () => { setView('behavior'); setEditingBehavior(log); setShowSearch(false); }
            });
          }
        });

        setSearchResults(results.slice(0, 20)); // ÏµúÎåÄ 20Í∞úÎßå ÌëúÏãú
      }, [searchQuery, state.lessons, state.tasks, state.schedules, state.behaviorLog]);

      useEffect(() => {
        if (view !== 'behaviorAnalytics') return;
        const canvas = document.getElementById('behaviorLineChart');
        if (!canvas || !window.Chart) return;

        if (!state.behaviorLog.length) {
          if (lineChartRef.current) {
            lineChartRef.current.destroy();
            lineChartRef.current = null;
          }
          return;
        }

        // Define student list and colors
        const students = ['ÌïôÏÉù1', 'ÌïôÏÉù2', 'ÌïôÏÉù3', 'ÌïôÏÉù4', 'ÌïôÏÉù5', 'ÌïôÏÉù6', 'ÌïôÏÉù7'];
        const studentColors = {
          'ÌïôÏÉù1': '#ef4444',
          'ÌïôÏÉù2': '#f59e0b',
          'ÌïôÏÉù3': '#eab308',
          'ÌïôÏÉù4': '#22c55e',
          'ÌïôÏÉù5': '#3b82f6',
          'ÌïôÏÉù6': '#8b5cf6',
          'ÌïôÏÉù7': '#ec4899',
          'ÌïôÍ∏â Ìï©Í≥Ñ': '#ffffff'
        };

        // Filter data by date range, student, and behavior type
        const now = Date.now();
        let startDate;
        if (behaviorFilter.dateRange === 'march1') {
          // March 1st of current year
          const march1 = new Date(new Date().getFullYear(), 2, 1); // Month is 0-indexed
          startDate = march1.getTime();
        } else {
          const rangeMs = behaviorFilter.dateRange * 24 * 60 * 60 * 1000;
          startDate = now - rangeMs;
        }
        const filteredData = state.behaviorLog.filter(b => {
          if (b.timestamp < startDate) return false;
          if (behaviorFilter.student !== 'ALL' && b.studentName !== behaviorFilter.student) return false;
          return true;
        });

        let labels = [];
        let datasets = [];

        // Process data based on chart type
        if (behaviorFilter.chartType === 'daily') {
          // Daily frequency
          const dailyData = {};
          const dayCount = behaviorFilter.dateRange === 'march1'
            ? Math.ceil((now - startDate) / (24 * 60 * 60 * 1000))
            : behaviorFilter.dateRange;
          for (let i = 0; i < dayCount; i++) {
            const date = new Date(now - i * 24 * 60 * 60 * 1000);
            const dateStr = date.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' });
            dailyData[dateStr] = {};
            students.forEach(s => dailyData[dateStr][s] = 0);
            dailyData[dateStr]['ÌïôÍ∏â Ìï©Í≥Ñ'] = 0;
          }

          filteredData.forEach(b => {
            const dateStr = new Date(b.timestamp).toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' });
            if (dailyData[dateStr]) {
              if (students.includes(b.studentName)) {
                dailyData[dateStr][b.studentName]++;
              }
              dailyData[dateStr]['ÌïôÍ∏â Ìï©Í≥Ñ']++;
            }
          });

          labels = Object.keys(dailyData).reverse();
          students.forEach(student => {
            datasets.push({
              label: student,
              data: labels.map(label => dailyData[label][student]),
              borderColor: studentColors[student],
              backgroundColor: 'transparent',
              tension: 0.4,
              borderWidth: 2,
            });
          });
          datasets.push({
            label: 'ÌïôÍ∏â Ìï©Í≥Ñ',
            data: labels.map(label => dailyData[label]['ÌïôÍ∏â Ìï©Í≥Ñ']),
            borderColor: studentColors['ÌïôÍ∏â Ìï©Í≥Ñ'],
            backgroundColor: 'transparent',
            tension: 0.4,
            borderWidth: 3,
          });

        } else if (behaviorFilter.chartType === 'weekly') {
          // Weekly frequency
          const weeks = Math.ceil(behaviorFilter.dateRange / 7);
          const weeklyData = {};

          for (let i = 0; i < weeks; i++) {
            const weekEnd = new Date(now - i * 7 * 24 * 60 * 60 * 1000);
            const weekStart = new Date(weekEnd - 6 * 24 * 60 * 60 * 1000);
            const weekLabel = `${weekStart.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' })} - ${weekEnd.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' })}`;
            weeklyData[weekLabel] = { start: weekStart.getTime(), end: weekEnd.getTime() };
            students.forEach(s => weeklyData[weekLabel][s] = 0);
            weeklyData[weekLabel]['ÌïôÍ∏â Ìï©Í≥Ñ'] = 0;
          }

          filteredData.forEach(b => {
            Object.keys(weeklyData).forEach(weekLabel => {
              const week = weeklyData[weekLabel];
              if (b.timestamp >= week.start && b.timestamp <= week.end) {
                if (students.includes(b.studentName)) {
                  weeklyData[weekLabel][b.studentName]++;
                }
                weeklyData[weekLabel]['ÌïôÍ∏â Ìï©Í≥Ñ']++;
              }
            });
          });

          labels = Object.keys(weeklyData).reverse();
          students.forEach(student => {
            datasets.push({
              label: student,
              data: labels.map(label => weeklyData[label][student]),
              borderColor: studentColors[student],
              backgroundColor: 'transparent',
              tension: 0.4,
              borderWidth: 2,
            });
          });
          datasets.push({
            label: 'ÌïôÍ∏â Ìï©Í≥Ñ',
            data: labels.map(label => weeklyData[label]['ÌïôÍ∏â Ìï©Í≥Ñ']),
            borderColor: studentColors['ÌïôÍ∏â Ìï©Í≥Ñ'],
            backgroundColor: 'transparent',
            tension: 0.4,
            borderWidth: 3,
          });

        } else if (behaviorFilter.chartType === 'dayOfWeek') {
          // Day of week distribution (Mon-Fri only)
          const daysOfWeek = ['Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à'];
          const dayData = {};
          daysOfWeek.forEach(day => {
            dayData[day] = {};
            students.forEach(s => dayData[day][s] = 0);
            dayData[day]['ÌïôÍ∏â Ìï©Í≥Ñ'] = 0;
          });

          filteredData.forEach(b => {
            const dayOfWeek = new Date(b.timestamp).getDay();
            // Only include weekdays (Mon=1 to Fri=5)
            if (dayOfWeek >= 1 && dayOfWeek <= 5) {
              const day = daysOfWeek[dayOfWeek - 1];
              if (students.includes(b.studentName)) {
                dayData[day][b.studentName]++;
              }
              dayData[day]['ÌïôÍ∏â Ìï©Í≥Ñ']++;
            }
          });

          labels = daysOfWeek;
          students.forEach(student => {
            datasets.push({
              label: student,
              data: labels.map(label => dayData[label][student]),
              borderColor: studentColors[student],
              backgroundColor: 'transparent',
              tension: 0.4,
              borderWidth: 2,
            });
          });
          datasets.push({
            label: 'ÌïôÍ∏â Ìï©Í≥Ñ',
            data: labels.map(label => dayData[label]['ÌïôÍ∏â Ìï©Í≥Ñ']),
            borderColor: studentColors['ÌïôÍ∏â Ìï©Í≥Ñ'],
            backgroundColor: 'transparent',
            tension: 0.4,
            borderWidth: 3,
          });

        } else if (behaviorFilter.chartType === 'period') {
          // Period distribution (ÍµêÏãúÎ≥Ñ - periods 1-7 only)
          const periods = ['1ÍµêÏãú', '2ÍµêÏãú', '3ÍµêÏãú', '4ÍµêÏãú', '5ÍµêÏãú', '6ÍµêÏãú', '7ÍµêÏãú'];
          const periodData = {};
          periods.forEach(period => {
            periodData[period] = {};
            students.forEach(s => periodData[period][s] = 0);
            periodData[period]['ÌïôÍ∏â Ìï©Í≥Ñ'] = 0;
          });

          filteredData.forEach(b => {
            const hour = new Date(b.timestamp).getHours();
            let period = null;
            if (hour >= 9 && hour < 10) period = '1ÍµêÏãú';
            else if (hour >= 10 && hour < 11) period = '2ÍµêÏãú';
            else if (hour >= 11 && hour < 12) period = '3ÍµêÏãú';
            else if (hour >= 12 && hour < 13) period = '4ÍµêÏãú';
            else if (hour >= 13 && hour < 14) period = '5ÍµêÏãú';
            else if (hour >= 14 && hour < 15) period = '6ÍµêÏãú';
            else if (hour >= 15 && hour < 16) period = '7ÍµêÏãú';

            if (period && periodData[period]) {
              if (students.includes(b.studentName)) {
                periodData[period][b.studentName]++;
              }
              periodData[period]['ÌïôÍ∏â Ìï©Í≥Ñ']++;
            }
          });

          labels = periods;
          students.forEach(student => {
            datasets.push({
              label: student,
              data: labels.map(label => periodData[label][student]),
              borderColor: studentColors[student],
              backgroundColor: 'transparent',
              tension: 0.4,
              borderWidth: 2,
            });
          });
          datasets.push({
            label: 'ÌïôÍ∏â Ìï©Í≥Ñ',
            data: labels.map(label => periodData[label]['ÌïôÍ∏â Ìï©Í≥Ñ']),
            borderColor: studentColors['ÌïôÍ∏â Ìï©Í≥Ñ'],
            backgroundColor: 'transparent',
            tension: 0.4,
            borderWidth: 3,
          });

        } else if (behaviorFilter.chartType === 'weeklyGoalAchievement') {
          // Weekly goal achievement (scores 3, 4, 5)
          const weeklyData = {};
          const weekCount = behaviorFilter.dateRange === 'march1'
            ? Math.ceil((now - startDate) / (7 * 24 * 60 * 60 * 1000))
            : Math.ceil(behaviorFilter.dateRange / 7);

          for (let i = 0; i < weekCount; i++) {
            const weekStart = new Date(now - i * 7 * 24 * 60 * 60 * 1000);
            const weekLabel = `${weekStart.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' })}Ï£º`;
            weeklyData[weekLabel] = {};
            students.forEach(s => weeklyData[weekLabel][s] = 0);
            weeklyData[weekLabel]['ÌïôÍ∏â Ìï©Í≥Ñ'] = 0;
          }

          // Count student evaluations with scores 3, 4, 5
          Object.entries(state.studentEvals).forEach(([key, eval]) => {
            if (eval.score >= 3 && eval.score <= 5 && eval.timestamp >= startDate) {
              const weekStart = new Date(eval.timestamp);
              weekStart.setDate(weekStart.getDate() - weekStart.getDay());
              const weekLabel = `${weekStart.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' })}Ï£º`;

              if (weeklyData[weekLabel]) {
                const studentId = key.split('-')[1];
                if (students.includes(studentId)) {
                  weeklyData[weekLabel][studentId]++;
                }
                weeklyData[weekLabel]['ÌïôÍ∏â Ìï©Í≥Ñ']++;
              }
            }
          });

          labels = Object.keys(weeklyData).reverse();
          students.forEach(student => {
            datasets.push({
              label: student,
              data: labels.map(label => weeklyData[label][student]),
              borderColor: studentColors[student],
              backgroundColor: 'transparent',
              tension: 0.4,
              borderWidth: 2,
            });
          });
          datasets.push({
            label: 'ÌïôÍ∏â Ìï©Í≥Ñ',
            data: labels.map(label => weeklyData[label]['ÌïôÍ∏â Ìï©Í≥Ñ']),
            borderColor: studentColors['ÌïôÍ∏â Ìï©Í≥Ñ'],
            backgroundColor: 'transparent',
            tension: 0.4,
            borderWidth: 3,
          });

        } else if (behaviorFilter.chartType === 'weeklyEvalFreq') {
          // Weekly evaluation frequency (scores 1-5, excluding 0)
          const weeklyData = {};
          const weekCount = behaviorFilter.dateRange === 'march1'
            ? Math.ceil((now - startDate) / (7 * 24 * 60 * 60 * 1000))
            : Math.ceil(behaviorFilter.dateRange / 7);

          for (let i = 0; i < weekCount; i++) {
            const weekStart = new Date(now - i * 7 * 24 * 60 * 60 * 1000);
            const weekLabel = `${weekStart.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' })}Ï£º`;
            weeklyData[weekLabel] = {};
            students.forEach(s => weeklyData[weekLabel][s] = 0);
            weeklyData[weekLabel]['ÌïôÍ∏â Ìï©Í≥Ñ'] = 0;
          }

          // Count student evaluations with scores 1-5 (excluding 0)
          Object.entries(state.studentEvals).forEach(([key, eval]) => {
            if (eval.score >= 1 && eval.score <= 5 && eval.timestamp >= startDate) {
              const weekStart = new Date(eval.timestamp);
              weekStart.setDate(weekStart.getDate() - weekStart.getDay());
              const weekLabel = `${weekStart.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' })}Ï£º`;

              if (weeklyData[weekLabel]) {
                const studentId = key.split('-')[1];
                if (students.includes(studentId)) {
                  weeklyData[weekLabel][studentId]++;
                }
                weeklyData[weekLabel]['ÌïôÍ∏â Ìï©Í≥Ñ']++;
              }
            }
          });

          labels = Object.keys(weeklyData).reverse();
          students.forEach(student => {
            datasets.push({
              label: student,
              data: labels.map(label => weeklyData[label][student]),
              borderColor: studentColors[student],
              backgroundColor: 'transparent',
              tension: 0.4,
              borderWidth: 2,
            });
          });
          datasets.push({
            label: 'ÌïôÍ∏â Ìï©Í≥Ñ',
            data: labels.map(label => weeklyData[label]['ÌïôÍ∏â Ìï©Í≥Ñ']),
            borderColor: studentColors['ÌïôÍ∏â Ìï©Í≥Ñ'],
            backgroundColor: 'transparent',
            tension: 0.4,
            borderWidth: 3,
          });

        } else if (behaviorFilter.chartType === 'dailyEvalFreq') {
          // Daily evaluation frequency (scores 1-5, excluding 0)
          const dailyData = {};
          const dayCount = behaviorFilter.dateRange === 'march1'
            ? Math.ceil((now - startDate) / (24 * 60 * 60 * 1000))
            : behaviorFilter.dateRange;

          for (let i = 0; i < dayCount; i++) {
            const date = new Date(now - i * 24 * 60 * 60 * 1000);
            const dateStr = date.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' });
            dailyData[dateStr] = {};
            students.forEach(s => dailyData[dateStr][s] = 0);
            dailyData[dateStr]['ÌïôÍ∏â Ìï©Í≥Ñ'] = 0;
          }

          // Count student evaluations with scores 1-5 (excluding 0)
          Object.entries(state.studentEvals).forEach(([key, eval]) => {
            if (eval.score >= 1 && eval.score <= 5 && eval.timestamp >= startDate) {
              const dateStr = new Date(eval.timestamp).toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' });

              if (dailyData[dateStr]) {
                const studentId = key.split('-')[1];
                if (students.includes(studentId)) {
                  dailyData[dateStr][studentId]++;
                }
                dailyData[dateStr]['ÌïôÍ∏â Ìï©Í≥Ñ']++;
              }
            }
          });

          labels = Object.keys(dailyData).reverse();
          students.forEach(student => {
            datasets.push({
              label: student,
              data: labels.map(label => dailyData[label][student]),
              borderColor: studentColors[student],
              backgroundColor: 'transparent',
              tension: 0.4,
              borderWidth: 2,
            });
          });
          datasets.push({
            label: 'ÌïôÍ∏â Ìï©Í≥Ñ',
            data: labels.map(label => dailyData[label]['ÌïôÍ∏â Ìï©Í≥Ñ']),
            borderColor: studentColors['ÌïôÍ∏â Ìï©Í≥Ñ'],
            backgroundColor: 'transparent',
            tension: 0.4,
            borderWidth: 3,
          });
        }

        // Create or update chart
        if (lineChartRef.current) {
          lineChartRef.current.destroy();
        }
        lineChartRef.current = new Chart(canvas, {
          type: 'line',
          data: {
            labels: labels,
            datasets: datasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 300 },
            interaction: { mode: 'nearest', intersect: false },
            elements: {
              point: {
                radius: 3,
                hoverRadius: 5,
                hitRadius: 10,
              }
            },
            plugins: {
              legend: {
                labels: { color: 'white', font: { size: 11 } },
                position: 'top',
              }
            },
            scales: {
              y: {
                ticks: { color: 'white', stepSize: 1 },
                grid: { color: 'rgba(255,255,255,0.1)' },
                beginAtZero: true
              },
              x: {
                ticks: { color: 'white', font: { size: 10 } },
                grid: { color: 'rgba(255,255,255,0.1)' }
              }
            }
          }
        });
      }, [view, state.behaviorLog, behaviorFilter]);

      // Í≤ÄÏÉâ Í∏∞Î°ù Ï†ÄÏû•
      const saveSearchHistory = (query) => {
        if (!query.trim()) return;
        setState(p => ({
          ...p,
          recentSearches: [query, ...p.recentSearches.filter(s => s !== query)].slice(0, 10)
        }));
      };

      // Ï∂úÎ∞ú ÏïåÎûå Ìï∏Îì§Îü¨ (ÏàòÏ†ï: Ï†úÎåÄÎ°ú Ïö∏Î¶¨ÎèÑÎ°ù)
      const handleScheduleAlert = useCallback((scheduleId) => {
        // setState Ìï®ÏàòÌòï ÏóÖÎç∞Ïù¥Ìä∏Î•º ÏÇ¨Ïö©ÌïòÏó¨ ÏµúÏã† stateÏóê Ï†ëÍ∑ºÌïòÍ≥† stale closure Î∞©ÏßÄ
        setState(prevState => {
          // Ïù¥ÎØ∏ ÏïåÎ¶ºÏùÑ Î≥¥ÎÇ∏ Í≤ΩÏö∞ ÏÉÅÌÉú Î≥ÄÍ≤Ω ÏóÜÏù¥ Î¶¨ÌÑ¥
          if (prevState.alertedSchedules[scheduleId]) {
            return prevState;
          }

          // ÏµúÏã† stateÏóêÏÑú Ïä§ÏºÄÏ§Ñ Ï∞æÍ∏∞
          const schedule = prevState.schedules.find(s => s.id === scheduleId);
          if (!schedule) {
            return prevState;
          }

          // ÏïåÎ¶º ÌëúÏãú
          showNotification(
            'üöó Ï∂úÎ∞ú ÏãúÍ∞ÑÏûÖÎãàÎã§!',
            `${schedule.name} - ÏßÄÍ∏à Î∞îÎ°ú Ï∂úÎ∞úÌïòÏÑ∏Ïöî!`,
            { tag: scheduleId, requireInteraction: true }
          );

          setShowAlert({
            title: 'üöó Ï∂úÎ∞ú ÏãúÍ∞Ñ!',
            message: `${schedule.name}\nÏßÄÍ∏à Ï∂úÎ∞úÌïòÏÑ∏Ïöî!`,
            schedule: schedule
          });

          // 5Ï¥à ÌõÑ ÏïåÎ¶º Î∞∞ÎÑà ÏûêÎèô Ï†úÍ±∞
          setTimeout(() => setShowAlert(null), 5000);

          // ÏïåÎ¶º ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
          return {
            ...prevState,
            alertedSchedules: { ...prevState.alertedSchedules, [scheduleId]: true },
          };
        });
      }, []); // Îπà ÏùòÏ°¥ÏÑ± Î∞∞Ïó¥Î°ú Ìï®Ïàò Ïû¨ÏÉùÏÑ± Î∞©ÏßÄ, setState Ìï®ÏàòÌòï ÏóÖÎç∞Ïù¥Ìä∏Î°ú ÏµúÏã† state Î≥¥Ïû•

      // Ï†ëÍ∏∞/ÌéºÏπòÍ∏∞ ÌÜ†Í∏Ä
      const toggleCollapse = (id) => {
        setState(p => ({
          ...p,
          collapsedItems: {
            ...p.collapsedItems,
            [id]: !p.collapsedItems[id],
          },
        }));
      };

      // Í≥ºÏ†ú Ï∂îÍ∞Ä
      const addTask = () => {
        const newTask = {
          id: uuid(),
          title: 'ÏÉà Í≥ºÏ†ú',
          category: 'TEACHING',
          priority: 'MEDIUM',
          progress: 0,
          steps: [],
          tags: [],
          createdAt: nowMs(),
          deadline: null, // ÎßàÍ∞êÏùºÏãú
          description: '', // ÏÑ§Î™Ö
          assignee: '', // Îã¥ÎãπÏûê
        };
        setState(p => ({ ...p, tasks: [...p.tasks, newTask] }));
      };

      // Í≥ºÏ†ú ÏÇ≠Ï†ú
      const deleteTask = (taskId) => {
        if (confirm('Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
          setState(p => ({ ...p, tasks: p.tasks.filter(t => t.id !== taskId) }));
        }
      };

      // Í≥ºÏ†ú ÏàòÏ†ï
      const updateTask = (taskId, updates) => {
        setState(p => ({
          ...p,
          tasks: p.tasks.map(t => t.id === taskId ? { ...t, ...updates } : t)
        }));
      };

      // ÏÑ∏Î∂Ä Îã®Í≥Ñ ÌÜ†Í∏Ä
      const toggleStep = (taskId, stepId) => {
        setState(p => ({
          ...p,
          tasks: p.tasks.map(t => {
            if (t.id !== taskId) return t;
            return {
              ...t,
              steps: t.steps.map(s => s.id === stepId ? { ...s, done: !s.done } : s)
            };
          })
        }));
      };

      // ÏÑ∏Î∂Ä Îã®Í≥Ñ Ï∂îÍ∞Ä
      const addStep = (taskId) => {
        const stepText = prompt('ÏÑ∏Î∂Ä Îã®Í≥ÑÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî:');
        if (!stepText) return;

        setState(p => ({
          ...p,
          tasks: p.tasks.map(t => {
            if (t.id !== taskId) return t;
            return {
              ...t,
              steps: [...(t.steps || []), { id: uuid(), text: stepText, done: false }]
            };
          })
        }));
      };

      // ÏÑ∏Î∂Ä Îã®Í≥Ñ ÏàòÏ†ï
      const editStep = (taskId, stepId) => {
        const task = state.tasks.find(t => t.id === taskId);
        if (!task) return;
        const step = task.steps.find(s => s.id === stepId);
        if (!step) return;

        const newText = prompt('ÏÑ∏Î∂Ä Îã®Í≥Ñ ÏàòÏ†ï:', step.text);
        if (!newText || newText === step.text) return;

        setState(p => ({
          ...p,
          tasks: p.tasks.map(t => {
            if (t.id !== taskId) return t;
            return {
              ...t,
              steps: t.steps.map(s => s.id === stepId ? { ...s, text: newText } : s)
            };
          })
        }));
      };

      // ÏÑ∏Î∂Ä Îã®Í≥Ñ ÏÇ≠Ï†ú
      const deleteStep = (taskId, stepId) => {
        if (!confirm('Ïù¥ Îã®Í≥ÑÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;

        setState(p => ({
          ...p,
          tasks: p.tasks.map(t => {
            if (t.id !== taskId) return t;
            return {
              ...t,
              steps: t.steps.filter(s => s.id !== stepId)
            };
          })
        }));
      };

      // ÏÑ∏Î∂Ä Îã®Í≥Ñ ÏúÑÎ°ú Ïù¥Îèô
      const moveStepUp = (taskId, stepId) => {
        setState(p => ({
          ...p,
          tasks: p.tasks.map(t => {
            if (t.id !== taskId) return t;
            const idx = t.steps.findIndex(s => s.id === stepId);
            if (idx <= 0) return t;
            const newSteps = [...t.steps];
            [newSteps[idx - 1], newSteps[idx]] = [newSteps[idx], newSteps[idx - 1]];
            return { ...t, steps: newSteps };
          })
        }));
      };

      // ÏÑ∏Î∂Ä Îã®Í≥Ñ ÏïÑÎûòÎ°ú Ïù¥Îèô
      const moveStepDown = (taskId, stepId) => {
        setState(p => ({
          ...p,
          tasks: p.tasks.map(t => {
            if (t.id !== taskId) return t;
            const idx = t.steps.findIndex(s => s.id === stepId);
            if (idx < 0 || idx >= t.steps.length - 1) return t;
            const newSteps = [...t.steps];
            [newSteps[idx], newSteps[idx + 1]] = [newSteps[idx + 1], newSteps[idx]];
            return { ...t, steps: newSteps };
          })
        }));
      };

      // Í≥ºÏ†ú ÏôÑÎ£å Ïãú Ìè¨Ïù∏Ìä∏ ÏßÄÍ∏â (ÎßàÍ∞êÏùº Ï†Ñ ÏôÑÎ£å Ïãú 100Ï†ê)
      const completeTask = (taskId) => {
        const task = state.tasks.find(t => t.id === taskId);
        if (!task) return;

        const autoProgress = calculateAutoProgress(task);
        if (autoProgress === 100) {
          const isBeforeDeadline = task.deadline && nowMs() < task.deadline;
          if (isBeforeDeadline) {
            setState(p => ({
              ...p,
              points: p.points + 100,
            }));
            alert('üéâ ÎßàÍ∞êÏùº Ï†Ñ Í≥ºÏ†ú ÏôÑÎ£å! +100Ï†ê ÌöçÎìù!');
          }
        }
      };

      // ÏàòÏóÖ Ï∂îÍ∞Ä/ÏàòÏ†ï
      const saveLesson = (lesson) => {
        if (lesson.id) {
          // ÏàòÏ†ï
          setState(p => ({
            ...p,
            lessons: p.lessons.map(l => l.id === lesson.id ? { ...lesson } : l)
          }));
        } else {
          // Ï∂îÍ∞Ä
          if (lesson.repeatWeekly && (!lesson.date || !lesson.repeatUntil)) {
            alert('Î∞òÎ≥µ ÏàòÏóÖÏùÄ ÎÇ†ÏßúÏôÄ Ï¢ÖÎ£åÏùºÏùÑ Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
            return;
          }
          const baseLesson = {
            ...lesson,
            date: lesson.date ? new Date(lesson.date).getTime() : null,
            dayOfWeek: lesson.date ? getDayLabel(lesson.date) : lesson.dayOfWeek,
          };
          if (lesson.repeatWeekly && lesson.repeatUntil && baseLesson.date) {
            const repeatUntil = new Date(lesson.repeatUntil).getTime();
            const newLessons = [];
            let cursor = baseLesson.date;
            while (cursor <= repeatUntil) {
              newLessons.push({
                ...baseLesson,
                id: uuid(),
                date: cursor,
                dayOfWeek: getDayLabel(cursor),
              });
              cursor += 7 * 24 * 60 * 60 * 1000;
            }
            setState(p => ({
              ...p,
              lessons: [...p.lessons, ...newLessons],
            }));
          } else {
            setState(p => ({
              ...p,
              lessons: [...p.lessons, { ...baseLesson, id: uuid() }]
            }));
          }
        }
        setEditingLesson(null);
      };

      // ÏàòÏóÖ ÏÇ≠Ï†ú
      const deleteLesson = (lessonId) => {
        if (confirm('Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
          setState(p => ({
            ...p,
            lessons: p.lessons.filter(l => l.id !== lessonId),
            studentEvals: Object.fromEntries(
              Object.entries(p.studentEvals).filter(([key]) => !key.startsWith(lessonId))
            )
          }));
        }
      };

      // ÌïôÏÉù ÌèâÍ∞Ä Ï†ÄÏû•
      const saveStudentEval = (lessonId, studentId, score, memo = '') => {
        setState(p => ({
          ...p,
          studentEvals: {
            ...p.studentEvals,
            [`${lessonId}-${studentId}`]: { score, memo, updatedAt: nowMs() }
          }
        }));
      };

      // ÏàòÏóÖ Î∞è ÌèâÍ∞Ä ÌÜµÌï© CSV ÎÇ¥Î≥¥ÎÇ¥Í∏∞
      const exportLessonsAndEvalsCSV = () => {
        // Enhanced CSV export for AI analysis with comprehensive data
        const headers = [
          'ID',
          'ÎÇ†Ïßú',
          'ISO_ÎÇ†Ïßú',
          'ÏöîÏùº',
          'ÍµêÏãú',
          'Í≥ºÎ™©',
          'Ï†úÏû¨',
          'Î™©Ìëú',
          'ÌôúÎèô',
          'ÌïôÏÉù1_Ï†êÏàò',
          'ÌïôÏÉù1_ÌèâÍ∞Ä',
          'ÌïôÏÉù2_Ï†êÏàò',
          'ÌïôÏÉù2_ÌèâÍ∞Ä',
          'ÌïôÏÉù3_Ï†êÏàò',
          'ÌïôÏÉù3_ÌèâÍ∞Ä',
          'ÌïôÏÉù4_Ï†êÏàò',
          'ÌïôÏÉù4_ÌèâÍ∞Ä',
          'ÌïôÏÉù5_Ï†êÏàò',
          'ÌïôÏÉù5_ÌèâÍ∞Ä',
          'ÌïôÏÉù6_Ï†êÏàò',
          'ÌïôÏÉù6_ÌèâÍ∞Ä',
          'ÌïôÏÉù7_Ï†êÏàò',
          'ÌïôÏÉù7_ÌèâÍ∞Ä',
          'ÌèâÍ∑†_Ï†êÏàò',
          'Î™©ÌëúÎã¨ÏÑ±_ÌïôÏÉùÏàò_3Ï†êÏù¥ÏÉÅ',
          'Ï†ÑÏ≤¥_ÌèâÍ∞Ä_ÌïôÏÉùÏàò'
        ];
        const rows = [headers];

        state.lessons.forEach(lesson => {
          const scores = [];
          let totalScore = 0;
          let evaluatedCount = 0;
          let achievedCount = 0;

          // Collect student evaluation data
          for (let i = 1; i <= 7; i++) {
            const studentId = `ÌïôÏÉù${i}`;
            const evalKey = `${lesson.id}-${studentId}`;
            const evalData = state.studentEvals[evalKey];
            const score = evalData?.score;

            if (score !== undefined && score !== null) {
              scores.push(score);
              totalScore += score;
              evaluatedCount++;
              if (score >= 3) achievedCount++;
            }
          }

          const avgScore = evaluatedCount > 0 ? (totalScore / evaluatedCount).toFixed(2) : '';

          const row = [
            lesson.id,
            lesson.date ? new Date(lesson.date).toLocaleDateString('ko-KR') : '',
            lesson.date ? new Date(lesson.date).toISOString() : '',
            lesson.dayOfWeek || '',
            lesson.period || '',
            lesson.subject || '',
            lesson.topic || '',
            `"${(lesson.goal || '').replace(/"/g, '""')}"`,
            `"${(lesson.activity || '').replace(/"/g, '""')}"`,
          ];

          // Add student scores and labels
          for (let i = 1; i <= 7; i++) {
            const studentId = `ÌïôÏÉù${i}`;
            const evalKey = `${lesson.id}-${studentId}`;
            const evalData = state.studentEvals[evalKey];
            const score = evalData?.score;
            const label = score !== undefined && score !== null
              ? ['Í≤∞ÏÑù', 'ÎØ∏Ï∞∏Ïó¨', 'ÎØ∏ÎèÑÎã¨', 'ÏµúÎåÄÏ¥âÍµ¨', 'ÏùºÎ∂ÄÏ¥âÍµ¨', 'Î™©ÌëúÎã¨ÏÑ±'][score]
              : '';

            row.push(score !== undefined && score !== null ? score : '');
            row.push(label);
          }

          row.push(avgScore);
          row.push(achievedCount);
          row.push(evaluatedCount);

          rows.push(row);
        });

        exportToCSV(rows, `ÏàòÏóÖÎ∞èÌèâÍ∞Ä_AIÎ∂ÑÏÑùÏö©_${new Date().toISOString().slice(0,10)}.csv`);
      };

      // CSV Í∞ÄÏ†∏Ïò§Í∏∞
      const importLessonsCSV = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        // ÌååÏùº ÌÅ¨Í∏∞ Í≤ÄÏ¶ù (10MB Ï†úÌïú)
        if (file.size > 10 * 1024 * 1024) {
          alert('ÌååÏùº ÌÅ¨Í∏∞Í∞Ä ÎÑàÎ¨¥ ÌÅΩÎãàÎã§. 10MB Ïù¥ÌïòÏùò ÌååÏùºÎßå ÏóÖÎ°úÎìú Í∞ÄÎä•Ìï©ÎãàÎã§.');
          e.target.value = '';
          return;
        }

        const reader = new FileReader();

        reader.onload = (evt) => {
          try {
            const text = evt.target.result;

            if (!text || typeof text !== 'string') {
              throw new Error('ÌååÏùº ÎÇ¥Ïö©ÏùÑ ÏùΩÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
            }

            const rows = parseCSV(text);

            if (!Array.isArray(rows) || rows.length < 2) {
              alert('Ïò¨Î∞îÎ•∏ CSV ÌååÏùºÏù¥ ÏïÑÎãôÎãàÎã§. ÏµúÏÜå 2Ï§Ñ(Ìó§Îçî + Îç∞Ïù¥ÌÑ∞) Ïù¥ÏÉÅ ÌïÑÏöîÌï©ÎãàÎã§.');
              return;
            }

            const newLessons = [];
            const errors = [];

            for (let i = 1; i < rows.length; i++) {
              try {
                const [id, date, dayOfWeek, period, subject, topic, goal, activity] = rows[i];
                if (subject) {
                  newLessons.push({
                    id: id || uuid(),
                    date: date ? new Date(date).getTime() : null,
                    dayOfWeek,
                    period,
                    subject,
                    topic,
                    goal,
                    activity
                  });
                }
              } catch (rowError) {
                errors.push(`${i + 1}Î≤àÏß∏ Ìñâ Ï≤òÎ¶¨ Ïã§Ìå®: ${rowError.message}`);
              }
            }

            if (errors.length > 0) {
              console.warn('CSV Í∞ÄÏ†∏Ïò§Í∏∞ Ï§ë ÏùºÎ∂Ä Ïò§Î•ò Î∞úÏÉù:', errors);
              if (!confirm(`${errors.length}Í∞úÏùò ÌñâÏùÑ Ï≤òÎ¶¨ÌïòÏßÄ Î™ªÌñàÏäµÎãàÎã§.\n${newLessons.length}Í∞úÏùò ÏàòÏóÖÏùÑ Í∞ÄÏ†∏Ïò§ÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                return;
              }
            }

            if (newLessons.length === 0) {
              alert('Í∞ÄÏ†∏Ïò¨ Ïàò ÏûàÎäî Ïú†Ìö®Ìïú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
              return;
            }

            if (confirm(`${newLessons.length}Í∞úÏùò ÏàòÏóÖÏùÑ Í∞ÄÏ†∏Ïò§ÏãúÍ≤†ÏäµÎãàÍπå?`)) {
              setState(p => ({
                ...p,
                lessons: [...p.lessons, ...newLessons]
              }));
              alert(`${newLessons.length}Í∞úÏùò ÏàòÏóÖÏùÑ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Í∞ÄÏ†∏ÏôîÏäµÎãàÎã§.`);
            }
          } catch (error) {
            console.error('CSV ÌååÏùº Ï≤òÎ¶¨ Ïò§Î•ò:', error);
            alert(`CSV ÌååÏùº Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§:\n${error.message}\n\nÌååÏùº ÌòïÏãùÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.`);
          }
        };

        reader.onerror = (error) => {
          console.error('ÌååÏùº ÏùΩÍ∏∞ Ïò§Î•ò:', error);
          alert('ÌååÏùºÏùÑ ÏùΩÎäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. ÌååÏùºÏù¥ ÏÜêÏÉÅÎêòÏóàÍ±∞ÎÇò Ï†ëÍ∑º Í∂åÌïúÏù¥ ÏóÜÏùÑ Ïàò ÏûàÏäµÎãàÎã§.');
        };

        reader.onabort = () => {
          console.warn('ÌååÏùº ÏùΩÍ∏∞Í∞Ä Ï§ëÎã®ÎêòÏóàÏäµÎãàÎã§.');
          alert('ÌååÏùº ÏùΩÍ∏∞Í∞Ä Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§.');
        };

        try {
          reader.readAsText(file, 'UTF-8');
        } catch (error) {
          console.error('FileReader ÏãúÏûë Ïò§Î•ò:', error);
          alert(`ÌååÏùº ÏùΩÍ∏∞Î•º ÏãúÏûëÌï† Ïàò ÏóÜÏäµÎãàÎã§:\n${error.message}`);
        }

        e.target.value = '';
      };

      // ÌñâÎèô Î°úÍ∑∏ Ï∂îÍ∞Ä/ÏàòÏ†ï
      const saveBehaviorLog = (behaviorLog) => {
        if (behaviorLog.id) {
          // ÏàòÏ†ï
          setState(p => ({
            ...p,
            behaviorLog: p.behaviorLog.map(b => b.id === behaviorLog.id ? behaviorLog : b)
          }));
        } else {
          // Ï∂îÍ∞Ä
          setState(p => ({
            ...p,
            behaviorLog: [...p.behaviorLog, { ...behaviorLog, id: uuid(), timestamp: nowMs() }]
          }));
        }
        setEditingBehavior(null);
      };

      // ÌñâÎèô Î°úÍ∑∏ ÏÇ≠Ï†ú
      const deleteBehaviorLog = (logId) => {
        if (confirm('Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
          setState(p => ({
            ...p,
            behaviorLog: p.behaviorLog.filter(b => b.id !== logId)
          }));
        }
      };

      // Ï£ºÍ∞Ñ ÏàòÏóÖ Î≥¥Í≥†ÏÑú ÏÉùÏÑ±
      const generateWeeklyLessonReport = () => {
        const now = Date.now();
        const weekAgo = now - 7 * 24 * 60 * 60 * 1000;
        const recentLessons = state.lessons.filter(l => l.date && l.date >= weekAgo);

        const headers = ['Ï£ºÍ∞Ñ ÏàòÏóÖ Î≥¥Í≥†ÏÑú', '', '', ''];
        const rows = [
          headers,
          ['ÎÇ†Ïßú', 'Í≥ºÎ™©', 'Ï†úÏû¨', 'Î™©Ìëú'],
          ...recentLessons.map(l => [
            l.date ? new Date(l.date).toLocaleDateString('ko-KR') : '',
            l.subject || '',
            l.topic || '',
            l.goal || ''
          ])
        ];

        exportToCSV(rows, `Ï£ºÍ∞ÑÏàòÏóÖÎ≥¥Í≥†ÏÑú_${new Date().toISOString().slice(0,10)}.csv`);
      };

      // ÏõîÍ∞Ñ ÌñâÎèô Î≥¥Í≥†ÏÑú ÏÉùÏÑ±
      const generateMonthlyBehaviorReport = () => {
        const now = Date.now();
        const monthAgo = now - 30 * 24 * 60 * 60 * 1000;
        const recentBehaviors = state.behaviorLog.filter(b => b.timestamp >= monthAgo);

        // ÌñâÎèô Ïú†ÌòïÎ≥Ñ ÏßëÍ≥Ñ
        const behaviorCounts = {};
        recentBehaviors.forEach(b => {
          const type = BEHAVIOR_TYPES[b.behaviorType]?.label || b.behaviorType;
          behaviorCounts[type] = (behaviorCounts[type] || 0) + 1;
        });

        const headers = ['ÏõîÍ∞Ñ ÌñâÎèô Î≥¥Í≥†ÏÑú', '', ''];
        const rows = [
          headers,
          ['Í∏∞Í∞Ñ', `${new Date(monthAgo).toLocaleDateString('ko-KR')} ~ ${new Date(now).toLocaleDateString('ko-KR')}`, ''],
          ['Ï¥ù Í∏∞Î°ù Ïàò', recentBehaviors.length, ''],
          [],
          ['ÌñâÎèô Ïú†Ìòï', 'Î∞úÏÉù ÌöüÏàò', 'ÎπÑÏú®(%)'],
          ...Object.entries(behaviorCounts).map(([type, count]) => [
            type,
            count,
            ((count / recentBehaviors.length) * 100).toFixed(1)
          ])
        ];

        exportToCSV(rows, `ÏõîÍ∞ÑÌñâÎèôÎ≥¥Í≥†ÏÑú_${new Date().toISOString().slice(0,10)}.csv`);
      };

      // PDF Î≥¥Í≥†ÏÑú ÏÉùÏÑ±
      const generatePDFReport = async (reportType) => {
        try {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();

          // ÌïúÍ∏Ä Ìè∞Ìä∏ ÏÑ§Ï†ï (Í∏∞Î≥∏ Ìè∞Ìä∏ ÏÇ¨Ïö©)
          doc.setFont('helvetica');

          let yPos = 20;

          if (reportType === 'weekly') {
            doc.setFontSize(18);
            doc.text('Weekly Lesson Report', 20, yPos);
            yPos += 15;

            doc.setFontSize(12);
            const weekAgo = Date.now() - 7 * 24 * 60 * 60 * 1000;
            const recentLessons = state.lessons.filter(l => l.date && l.date >= weekAgo);

            doc.text(`Period: ${new Date(weekAgo).toLocaleDateString()} - ${new Date().toLocaleDateString()}`, 20, yPos);
            yPos += 10;
            doc.text(`Total Lessons: ${recentLessons.length}`, 20, yPos);
            yPos += 15;

            recentLessons.forEach(lesson => {
              if (yPos > 270) {
                doc.addPage();
                yPos = 20;
              }
              doc.text(`Subject: ${lesson.subject || ''}`, 20, yPos);
              yPos += 7;
              doc.text(`Topic: ${lesson.topic || ''}`, 20, yPos);
              yPos += 7;
              doc.text(`Goal: ${lesson.goal || ''}`, 20, yPos);
              yPos += 12;
            });
          } else if (reportType === 'monthly') {
            doc.setFontSize(18);
            doc.text('Monthly Behavior Report', 20, yPos);
            yPos += 15;

            doc.setFontSize(12);
            const monthAgo = Date.now() - 30 * 24 * 60 * 60 * 1000;
            const recentBehaviors = state.behaviorLog.filter(b => b.timestamp >= monthAgo);

            doc.text(`Period: ${new Date(monthAgo).toLocaleDateString()} - ${new Date().toLocaleDateString()}`, 20, yPos);
            yPos += 10;
            doc.text(`Total Incidents: ${recentBehaviors.length}`, 20, yPos);
            yPos += 15;

            const behaviorCounts = {};
            recentBehaviors.forEach(b => {
              const type = BEHAVIOR_TYPES[b.behaviorType]?.label || b.behaviorType;
              behaviorCounts[type] = (behaviorCounts[type] || 0) + 1;
            });

            Object.entries(behaviorCounts).forEach(([type, count]) => {
              if (yPos > 270) {
                doc.addPage();
                yPos = 20;
              }
              doc.text(`${type}: ${count} incidents (${((count/recentBehaviors.length)*100).toFixed(1)}%)`, 20, yPos);
              yPos += 10;
            });
          }

          doc.save(`${reportType}_report_${new Date().toISOString().slice(0,10)}.pdf`);
          alert('PDF Î≥¥Í≥†ÏÑúÍ∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!');
        } catch (error) {
          console.error('PDF ÏÉùÏÑ± Ïò§Î•ò:', error);
          alert('PDF ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
        }
      };

      const styles = {
        container: {
          minHeight: '100vh',
        },
        card: {
          background: 'rgba(30, 41, 59, 0.4)',
          backdropFilter: 'blur(20px)',
          borderRadius: 20,
          padding: 24,
          marginBottom: 20,
          border: '1px solid rgba(255, 255, 255, 0.1)',
          boxShadow: '0 8px 32px rgba(0, 0, 0, 0.4)',
        },
        h1: {
          fontWeight: 900,
          background: 'linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%)',
          WebkitBackgroundClip: 'text',
          WebkitTextFillColor: 'transparent',
          margin: '0 0 12px 0',
          textAlign: 'center',
        },
        h2: {
          fontSize: 22,
          fontWeight: 800,
          color: 'white',
          margin: '0 0 16px 0',
          display: 'flex',
          alignItems: 'center',
          gap: 8,
        },
        btn: {
          padding: '12px 20px',
          background: 'linear-gradient(135deg, #6366f1 0%, #4f46e5 100%)',
          border: 'none',
          borderRadius: 10,
          color: 'white',
          fontSize: 14,
          fontWeight: 700,
          cursor: 'pointer',
          transition: 'all 0.3s',
          boxShadow: '0 4px 12px rgba(99, 102, 241, 0.3)',
        },
        btn2: {
          padding: '10px 16px',
          background: 'rgba(255, 255, 255, 0.1)',
          border: '1px solid rgba(255, 255, 255, 0.2)',
          borderRadius: 8,
          color: 'white',
          fontSize: 13,
          fontWeight: 600,
          cursor: 'pointer',
          transition: 'all 0.2s',
        },
        nav: {
          display: 'grid',
          gridTemplateColumns: 'repeat(auto-fit, minmax(120px, 1fr))',
          gap: 10,
          marginBottom: 20,
        },
        navBtn: {
          padding: 14,
          background: 'rgba(255, 255, 255, 0.05)',
          border: '1px solid rgba(255, 255, 255, 0.1)',
          borderRadius: 12,
          color: 'white',
          fontSize: 13,
          fontWeight: 700,
          cursor: 'pointer',
          transition: 'all 0.2s',
          textAlign: 'center',
        },
      };

      const filteredTasks = useMemo(() => {
        const filtered = state.tasks.filter(t => {
          if (state.filters.category !== 'ALL' && t.category !== state.filters.category) return false;
          if (state.filters.priority !== 'ALL' && t.priority !== state.filters.priority) return false;
          if (state.filters.searchText) {
            const search = state.filters.searchText.toLowerCase();
            if (!t.title.toLowerCase().includes(search) &&
                !(t.tags || []).some(tag => tag.toLowerCase().includes(search))) {
              return false;
            }
          }
          return true;
        });

        // Ï†ïÎ†¨
        const sorted = [...filtered];
        switch (state.taskSortBy) {
          case 'deadline':
            sorted.sort((a, b) => {
              if (!a.deadline && !b.deadline) return 0;
              if (!a.deadline) return 1;
              if (!b.deadline) return -1;
              return a.deadline - b.deadline;
            });
            break;
          case 'priority':
            sorted.sort((a, b) => {
              const aPri = PRIORITIES[a.priority]?.value || 0;
              const bPri = PRIORITIES[b.priority]?.value || 0;
              return bPri - aPri;
            });
            break;
          case 'name':
            sorted.sort((a, b) => a.title.localeCompare(b.title));
            break;
          case 'createdAt':
            sorted.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
            break;
          default:
            break;
        }
        return sorted;
      }, [state.tasks, state.filters, state.taskSortBy]);

      const stats = useMemo(() => {
        const total = state.tasks.length;
        const completed = state.tasks.filter(t => calculateAutoProgress(t) === 100).length;
        const urgent = state.tasks.filter(t => t.priority === 'URGENT').length;
        const avgProgress = total > 0 ? state.tasks.reduce((sum, t) => sum + calculateAutoProgress(t), 0) / total : 0;
        const level = Math.floor(state.points / 100) + 1;
        
        return { total, completed, urgent, points: state.points, level, avgProgress };
      }, [state.tasks, state.points]);

      const behaviorStudents = useMemo(() => {
        return Array.from(new Set(state.behaviorLog.map(b => b.studentName).filter(Boolean))).sort();
      }, [state.behaviorLog]);

      const filteredBehaviorLog = useMemo(() => {
        const now = Date.now();
        let startDate;
        if (behaviorFilter.dateRange === 'march1') {
          const march1 = new Date(new Date().getFullYear(), 2, 1);
          startDate = march1.getTime();
        } else {
          const rangeMs = behaviorFilter.dateRange * 24 * 60 * 60 * 1000;
          startDate = now - rangeMs;
        }
        return state.behaviorLog.filter(b => {
          if (b.timestamp < startDate) return false;
          if (behaviorFilter.student !== 'ALL' && b.studentName !== behaviorFilter.student) return false;
          return true;
        });
      }, [state.behaviorLog, behaviorFilter]);

      const lessonWeekDates = useMemo(() => {
        return Array.from({ length: 5 }, (_, i) => addDays(lessonWeekStart, i));
      }, [lessonWeekStart]);

      const behaviorWeekDates = useMemo(() => {
        return Array.from({ length: 5 }, (_, i) => addDays(behaviorWeekStart, i));
      }, [behaviorWeekStart]);

      const weeklyBehaviorLogs = useMemo(() => {
        const start = new Date(behaviorWeekStart);
        const end = addDays(start, 5);
        return state.behaviorLog.filter(log => {
          if (!log.timestamp) return false;
          if (behaviorWeekStudent !== 'ALL' && log.studentName !== behaviorWeekStudent) return false;
          const ts = new Date(log.timestamp);
          return ts >= start && ts < end;
        });
      }, [state.behaviorLog, behaviorWeekStart, behaviorWeekStudent]);

      const focusStatus = useMemo(() => {
        const focus = state.focus;
        if (!focus.startedTs) {
          return {
            remainingMs: focus.durationSec * 1000,
            elapsedMs: 0,
          };
        }
        const now = nowMs();
        const elapsed = focus.paused
          ? focus.elapsedBeforePause
          : focus.elapsedBeforePause + (now - focus.startedTs);
        const remaining = Math.max(0, focus.durationSec * 1000 - elapsed);
        return {
          remainingMs: remaining,
          elapsedMs: elapsed,
        };
      }, [state.focus, tick]);

      useEffect(() => {
        if (!state.focus.running || state.focus.paused) return;
        if (focusStatus.remainingMs > 0) return;

        // Timer completed - show success/failure selection
        setShowFocusComplete(true);

        // Stop the timer
        setState(p => ({
          ...p,
          focus: {
            ...p.focus,
            running: false,
            paused: false,
          },
        }));
      }, [focusStatus.remainingMs, state.focus.running, state.focus.paused]);

      const startFocus = () => {
        setState(p => ({
          ...p,
          focus: {
            ...p.focus,
            running: true,
            paused: false,
            durationSec: focusDraft.durationMin * 60,
            startedTs: nowMs(),
            pausedAt: null,
            elapsedBeforePause: 0,
            note: focusDraft.note,
          },
        }));
      };

      const pauseFocus = () => {
        setState(p => ({
          ...p,
          focus: {
            ...p.focus,
            paused: true,
            pausedAt: nowMs(),
            elapsedBeforePause: focusStatus.elapsedMs,
          },
        }));
      };

      const resumeFocus = () => {
        setState(p => ({
          ...p,
          focus: {
            ...p.focus,
            paused: false,
            startedTs: nowMs(),
            pausedAt: null,
          },
        }));
      };

      const resetFocus = () => {
        setState(p => ({
          ...p,
          focus: {
            ...p.focus,
            running: false,
            paused: false,
            startedTs: null,
            pausedAt: null,
            elapsedBeforePause: 0,
          },
        }));
      };

      const editFocusHistory = (id) => {
        const record = state.focusHistory.find(r => r.id === id);
        if (record) {
          setEditingFocusHistory({
            ...record,
            durationMin: Math.round(record.duration / 60),
          });
        }
      };

      const saveFocusHistory = () => {
        if (!editingFocusHistory) return;
        setState(p => ({
          ...p,
          focusHistory: p.focusHistory.map(r =>
            r.id === editingFocusHistory.id
              ? {
                  ...r,
                  note: editingFocusHistory.note,
                  duration: editingFocusHistory.durationMin * 60,
                }
              : r
          ),
        }));
        setEditingFocusHistory(null);
        setShowAlert({ title: '‚úÖ ÏàòÏ†ï ÏôÑÎ£å', message: 'ÏßëÏ§ë Í∏∞Î°ùÏù¥ ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.' });
        setTimeout(() => setShowAlert(null), 3000);
      };

      const deleteFocusHistory = (id) => {
        if (!confirm('Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
        setState(p => ({
          ...p,
          focusHistory: p.focusHistory.filter(r => r.id !== id),
        }));
        setShowAlert({ title: 'üóëÔ∏è ÏÇ≠Ï†ú ÏôÑÎ£å', message: 'ÏßëÏ§ë Í∏∞Î°ùÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.' });
        setTimeout(() => setShowAlert(null), 3000);
      };

      const completeFocusSession = (success) => {
        // Save focus session to history
        const focusRecord = {
          id: Date.now(),
          startTime: state.focus.startedTs,
          duration: state.focus.durationSec,
          completedAt: nowMs(),
          note: state.focus.note || '',
          taskId: state.focus.taskId || null,
          success: success,
        };

        setState(p => ({
          ...p,
          points: success ? p.points + 100 : p.points,
          focusHistory: [focusRecord, ...(p.focusHistory || [])],
          focus: {
            ...p.focus,
            startedTs: null,
            pausedAt: null,
            elapsedBeforePause: 0,
          },
        }));

        setShowFocusComplete(false);

        if (success) {
          setShowAlert({ title: '‚úÖ ÏßëÏ§ë ÏÑ±Í≥µ!', message: 'ÏßëÏ§ë ÏãúÍ∞ÑÏùÑ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏôÑÎ£åÌñàÏäµÎãàÎã§! üéâ +100 Ìè¨Ïù∏Ìä∏' });
        } else {
          setShowAlert({ title: 'üí™ Îã§ÏùåÏóî ÏÑ±Í≥µ!', message: 'ÏßëÏ§ë Í∏∞Î°ùÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§. Îã§ÏùåÎ≤àÏóî ÏÑ±Í≥µÌï¥Î¥êÏöî!' });
        }
        setTimeout(() => setShowAlert(null), 4000);
      };

      const addSchedule = () => {
        if (!scheduleDraft.name || !scheduleDraft.arrivalTs) {
          alert('ÏùºÏ†ï Ïù¥Î¶ÑÍ≥º ÎèÑÏ∞© ÏãúÍ∞ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
          return;
        }
        const arrival = fromLocalDatetimeValue(scheduleDraft.arrivalTs);
        if (!arrival) {
          alert('Ïò¨Î∞îÎ•∏ ÎèÑÏ∞© ÏãúÍ∞ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
          return;
        }
        setState(p => ({
          ...p,
          schedules: [
            ...p.schedules,
            {
              id: uuid(),
              name: scheduleDraft.name,
              arrivalTs: arrival,
              departBeforeMin: parseInt(scheduleDraft.departBeforeMin) || 0,
              location: scheduleDraft.location,
              note: scheduleDraft.note,
            }
          ]
        }));
        setScheduleDraft({ name: '', arrivalTs: '', departBeforeMin: 30, location: '', note: '' });
      };

      const deleteSchedule = (scheduleId) => {
        if (!confirm('Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
        setState(p => ({
          ...p,
          schedules: p.schedules.filter(s => s.id !== scheduleId),
        }));
      };

      const completeScheduleArrival = (schedule) => {
        const now = nowMs();
        const departTime = schedule.arrivalTs - (schedule.departBeforeMin * 60 * 1000);
        const onTime = now <= schedule.arrivalTs;
        const points = onTime ? 100 : 0;

        const historyRecord = {
          id: Date.now(),
          scheduleId: schedule.id,
          scheduleName: schedule.name,
          arrivalTime: now,
          plannedArrivalTime: schedule.arrivalTs,
          onTime: onTime,
          points: points,
          location: schedule.location || '',
        };

        setState(p => ({
          ...p,
          points: p.points + points,
          scheduleHistory: [historyRecord, ...(p.scheduleHistory || [])],
        }));

        if (onTime) {
          setShowAlert({ title: '‚úÖ Ï†ïÏãú ÎèÑÏ∞©!', message: `${schedule.name}Ïóê Ï†ïÏãú ÎèÑÏ∞©ÌñàÏäµÎãàÎã§! üéâ +100 Ìè¨Ïù∏Ìä∏` });
        } else {
          const lateMinutes = Math.round((now - schedule.arrivalTs) / 60000);
          setShowAlert({ title: '‚è∞ Îä¶ÏùÄ ÎèÑÏ∞©', message: `${schedule.name}Ïóê ${lateMinutes}Î∂Ñ Îä¶Í≤å ÎèÑÏ∞©ÌñàÏäµÎãàÎã§.` });
        }
        setTimeout(() => setShowAlert(null), 4000);
      };

      const editScheduleHistory = (id) => {
        const record = state.scheduleHistory.find(r => r.id === id);
        if (record) {
          setEditingScheduleHistory({
            ...record,
            arrivalTimeLocal: toLocalDatetimeValue(record.arrivalTime),
          });
        }
      };

      const saveScheduleHistory = () => {
        if (!editingScheduleHistory) return;
        const newArrivalTime = fromLocalDatetimeValue(editingScheduleHistory.arrivalTimeLocal);
        if (!newArrivalTime) {
          alert('Ïò¨Î∞îÎ•∏ ÎèÑÏ∞© ÏãúÍ∞ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
          return;
        }

        const onTime = newArrivalTime <= editingScheduleHistory.plannedArrivalTime;
        const oldPoints = editingScheduleHistory.points;
        const newPoints = onTime ? 100 : 0;
        const pointsDiff = newPoints - oldPoints;

        setState(p => ({
          ...p,
          points: p.points + pointsDiff,
          scheduleHistory: p.scheduleHistory.map(r =>
            r.id === editingScheduleHistory.id
              ? {
                  ...r,
                  arrivalTime: newArrivalTime,
                  onTime: onTime,
                  points: newPoints,
                }
              : r
          ),
        }));
        setEditingScheduleHistory(null);
        setShowAlert({ title: '‚úÖ ÏàòÏ†ï ÏôÑÎ£å', message: 'ÏùºÏ†ï Í∏∞Î°ùÏù¥ ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.' });
        setTimeout(() => setShowAlert(null), 3000);
      };

      const deleteScheduleHistory = (id) => {
        if (!confirm('Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
        const record = state.scheduleHistory.find(r => r.id === id);
        if (record) {
          setState(p => ({
            ...p,
            points: Math.max(0, p.points - record.points),
            scheduleHistory: p.scheduleHistory.filter(r => r.id !== id),
          }));
          setShowAlert({ title: 'üóëÔ∏è ÏÇ≠Ï†ú ÏôÑÎ£å', message: 'ÏùºÏ†ï Í∏∞Î°ùÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.' });
          setTimeout(() => setShowAlert(null), 3000);
        }
      };

      return (
        <div style={styles.container} className="app-container">
          {/* ÏïåÎ¶º Î∞∞ÎÑà */}
          {showAlert && (
            <div className="alert-banner">
              <div style={{ fontSize: 20, marginBottom: 8 }}>{showAlert.title}</div>
              <div style={{ fontSize: 14 }}>{showAlert.message}</div>
              <button
                style={{ marginTop: 10, padding: '6px 12px', background: 'white', color: '#ef4444', border: 'none', borderRadius: 6, cursor: 'pointer', fontWeight: 700 }}
                onClick={() => setShowAlert(null)}
              >
                ÌôïÏù∏
              </button>
            </div>
          )}

          <h1 style={styles.h1} className="app-title">üéØ ADHD ÌäπÏàòÍµêÏÇ¨ ÌÜµÌï© Í¥ÄÎ¶¨ Pro v2.0</h1>
          
          <div style={{ display: 'flex', gap: 12, justifyContent: 'center', marginBottom: 20 }}>
            <div className="token-badge">
              üíé {state.points} Ìè¨Ïù∏Ìä∏
            </div>
            <div className="level-badge">
              ‚≠ê Level {stats.level}
            </div>
          </div>

          {/* Í≤ÄÏÉâ Î∞î */}
          {showSearch && (
            <div className="search-container" style={{ position: 'relative', marginBottom: 20 }}>
              <input
                ref={searchInputRef}
                type="text"
                className="search-input"
                placeholder="üîç Í≤ÄÏÉâ... (Ctrl/Cmd + K)"
                value={searchQuery}
                onChange={(e) => { setSearchQuery(e.target.value); saveSearchHistory(e.target.value); }}
              />
              {searchResults.length > 0 && (
                <div className="search-results">
                  {searchResults.map((result, idx) => (
                    <div
                      key={idx}
                      className="search-result-item"
                      onClick={result.action}
                    >
                      <div style={{ fontSize: 12, color: '#8b5cf6', fontWeight: 700, marginBottom: 4 }}>
                        {result.type}
                      </div>
                      <div style={{ fontSize: 14, color: 'white', fontWeight: 600, marginBottom: 2 }}>
                        {result.title}
                      </div>
                      <div style={{ fontSize: 12, color: 'rgba(255,255,255,0.6)' }}>
                        {result.subtitle}
                      </div>
                    </div>
                  ))}
                </div>
              )}
              {state.recentSearches.length > 0 && searchQuery === '' && (
                <div className="search-results">
                  <div style={{ padding: '12px 16px', fontSize: 12, color: 'rgba(255,255,255,0.5)', fontWeight: 700 }}>
                    ÏµúÍ∑º Í≤ÄÏÉâ
                  </div>
                  {state.recentSearches.map((search, idx) => (
                    <div
                      key={idx}
                      className="search-result-item"
                      onClick={() => setSearchQuery(search)}
                    >
                      <div style={{ fontSize: 14, color: 'white' }}>
                        üïí {search}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}

          {/* ÌñÑÎ≤ÑÍ±∞ Î©îÎâ¥ (Î™®Î∞îÏùº) */}
          <div className="hamburger-menu" onClick={() => setShowMobileMenu(true)}>
            <div className="hamburger-line"></div>
            <div className="hamburger-line"></div>
            <div className="hamburger-line"></div>
          </div>

          {/* Î™®Î∞îÏùº Î©îÎâ¥ Ïò§Î≤ÑÎ†àÏù¥ */}
          {showMobileMenu && (
            <div className="mobile-nav-overlay">
              <div className="mobile-nav-close" onClick={() => setShowMobileMenu(false)}>‚úï</div>
              <div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>
                {[
                  { key: 'dashboard', icon: 'üìä', label: 'ÎåÄÏãúÎ≥¥Îìú' },
                  { key: 'tasks', icon: '‚úÖ', label: 'Í≥ºÏ†ú' },
                  { key: 'teaching', icon: 'üë®‚Äçüè´', label: 'ÏàòÏóÖÍ¥ÄÎ¶¨' },
                  { key: 'behaviorAnalytics', icon: 'üìà', label: 'ÌñâÎèô Í∑∏ÎûòÌîÑ' },
                  { key: 'focus', icon: '‚è±Ô∏è', label: 'ÏßëÏ§ë' },
                  { key: 'points', icon: 'ü™ô', label: 'Ìè¨Ïù∏Ìä∏' },
                  { key: 'schedule', icon: 'üöó', label: 'ÏùºÏ†ï' },
                  { key: 'calendar', icon: 'üìÖ', label: 'Ï∫òÎ¶∞Îçî' },
                  { key: 'analytics', icon: 'üìà', label: 'ÌÜµÍ≥Ñ' },
                ].map(item => (
                  <button
                    key={item.key}
                    style={{
                      ...styles.navBtn,
                      padding: 20,
                      fontSize: 16,
                      background: view === item.key ? 'linear-gradient(135deg, #6366f1 0%, #4f46e5 100%)' : styles.navBtn.background,
                      boxShadow: view === item.key ? '0 4px 12px rgba(99, 102, 241, 0.4)' : 'none',
                    }}
                    onClick={() => { setView(item.key); setShowMobileMenu(false); }}
                  >
                    {item.icon} {item.label}
                  </button>
                ))}
              </div>
            </div>
          )}

          {/* Îç∞Ïä§ÌÅ¨ÌÜ± ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò */}
          <div style={styles.nav} className="desktop-nav">
            {[
              { key: 'dashboard', icon: 'üìä', label: 'ÎåÄÏãúÎ≥¥Îìú' },
              { key: 'tasks', icon: '‚úÖ', label: 'Í≥ºÏ†ú' },
              { key: 'teaching', icon: 'üë®‚Äçüè´', label: 'ÏàòÏóÖÍ¥ÄÎ¶¨' },
              { key: 'behaviorAnalytics', icon: 'üìà', label: 'ÌñâÎèô Í∑∏ÎûòÌîÑ' },
              { key: 'focus', icon: '‚è±Ô∏è', label: 'ÏßëÏ§ë' },
              { key: 'points', icon: 'ü™ô', label: 'Ìè¨Ïù∏Ìä∏' },
              { key: 'schedule', icon: 'üöó', label: 'ÏùºÏ†ï' },
              { key: 'calendar', icon: 'üìÖ', label: 'Ï∫òÎ¶∞Îçî' },
            ].map(item => (
              <button
                key={item.key}
                style={{
                  ...styles.navBtn,
                  background: view === item.key ? 'linear-gradient(135deg, #6366f1 0%, #4f46e5 100%)' : styles.navBtn.background,
                  boxShadow: view === item.key ? '0 4px 12px rgba(99, 102, 241, 0.4)' : 'none',
                  transform: view === item.key ? 'scale(1.05)' : 'scale(1)',
                }}
                onClick={() => setView(item.key)}
              >
                {item.icon} {item.label}
              </button>
            ))}
            <button
              style={{
                ...styles.navBtn,
                background: showSearch ? 'rgba(59, 130, 246, 0.3)' : styles.navBtn.background,
              }}
              onClick={() => setShowSearch(!showSearch)}
            >
              üîç Í≤ÄÏÉâ (Ctrl+K)
            </button>
          </div>

          {/* ÌïòÎã® ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò (Î™®Î∞îÏùº) */}
          <div className="bottom-nav">
            <div className="bottom-nav-grid">
              {[
                { key: 'dashboard', icon: 'üìä', label: 'Ìôà' },
                { key: 'tasks', icon: '‚úÖ', label: 'Í≥ºÏ†ú' },
                { key: 'teaching', icon: 'üë®‚Äçüè´', label: 'ÏàòÏóÖ' },
                { key: 'schedule', icon: 'üöó', label: 'ÏùºÏ†ï' },
              ].map(item => (
                <button
                  key={item.key}
                  className={`bottom-nav-btn ${view === item.key ? 'active' : ''}`}
                  onClick={() => setView(item.key)}
                >
                  <span>{item.icon}</span>
                  <div>{item.label}</div>
                </button>
              ))}
            </div>
          </div>

          {/* ÎåÄÏãúÎ≥¥Îìú */}
          {view === 'dashboard' && (
            <div style={styles.card} className="animate-in">
              <h2 style={styles.h2} className="section-title">üìä ÎåÄÏãúÎ≥¥Îìú</h2>
              <p style={{ color: 'rgba(255,255,255,0.7)', fontSize: 14, marginBottom: 24 }}>
                Ï†ÑÏ≤¥ ÏãúÏä§ÌÖú ÌòÑÌô©ÏùÑ ÌïúÎààÏóê ÌôïÏù∏ÌïòÏÑ∏Ïöî.
              </p>

              {/* Ï£ºÏöî ÌÜµÍ≥Ñ */}
              <div style={{ marginBottom: 30 }}>
                <h3 style={{ fontSize: 18, fontWeight: 700, color: 'white', marginBottom: 16 }}>
                  üìà Ï£ºÏöî ÌÜµÍ≥Ñ
                </h3>
                <div className="stat-grid">
                  {[
                    { label: 'Î≥¥Ïú† Ìè¨Ïù∏Ìä∏', value: ((state.points || 0).toLocaleString()) + 'P', icon: 'ü™ô', color: '#fbbf24', onClick: () => setView('points') },
                    { label: 'Ï†ÑÏ≤¥ ÏàòÏóÖ', value: (state.lessons || []).length, icon: 'üë®‚Äçüè´', color: '#8b5cf6', onClick: () => setView('teaching') },
                    { label: 'ÌñâÎèô Í∏∞Î°ù', value: (state.behaviorLog || []).length, icon: 'üìã', color: '#3b82f6', onClick: () => setView('behaviorAnalytics') },
                    { label: 'ÏßëÏ§ë ÏÑ∏ÏÖò', value: (state.focusHistory || []).length, icon: '‚è±Ô∏è', color: '#10b981', onClick: () => setView('focus') },
                    { label: 'Ï†ÑÏ≤¥ Í≥ºÏ†ú', value: stats.total || 0, icon: '‚úÖ', color: '#6366f1', onClick: () => setView('tasks') },
                    { label: 'ÏôÑÎ£å Í≥ºÏ†ú', value: stats.completed || 0, icon: '‚úîÔ∏è', color: '#22c55e', onClick: () => setView('tasks') },
                  ].map((stat, i) => (
                    <div
                      key={i}
                      className="stat-card"
                      style={{
                        padding: 20,
                        borderRadius: 12,
                        background: `linear-gradient(135deg, ${stat.color}20 0%, ${stat.color}10 100%)`,
                        border: `1px solid ${stat.color}40`,
                        textAlign: 'center',
                      }}
                      onClick={stat.onClick}
                    >
                      <div style={{ fontSize: 32, marginBottom: 8 }}>{stat.icon}</div>
                      <div style={{ fontSize: 28, fontWeight: 900, color: stat.color, marginBottom: 4 }}>
                        {stat.value}
                      </div>
                      <div style={{ fontSize: 12, color: 'rgba(255,255,255,0.7)' }}>
                        {stat.label}
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              {/* Îπ†Î•∏ Ïã§Ìñâ */}
              <div style={{ marginBottom: 30 }}>
                <h3 style={{ fontSize: 18, fontWeight: 700, color: 'white', marginBottom: 16 }}>
                  ‚ö° Îπ†Î•∏ Ïã§Ìñâ
                </h3>
                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))', gap: 12 }}>
                  {[
                    { label: 'ÏÉà Í≥ºÏ†ú Ï∂îÍ∞Ä', icon: '‚ûï', color: '#6366f1', onClick: () => { setView('tasks'); setTimeout(addTask, 100); } },
                    { label: 'ÏàòÏóÖ Ï∂îÍ∞Ä', icon: 'üë®‚Äçüè´', color: '#8b5cf6', onClick: () => setView('teaching') },
                    { label: 'ÏßëÏ§ë ÏãúÏûë', icon: '‚è±Ô∏è', color: '#10b981', onClick: () => { setView('focus'); } },
                    { label: 'ÏùºÏ†ï Ï∂îÍ∞Ä', icon: 'üöó', color: '#f59e0b', onClick: () => setView('schedule') },
                  ].map((action, i) => (
                    <button
                      key={i}
                      style={{
                        padding: '16px 12px',
                        borderRadius: 10,
                        background: `linear-gradient(135deg, ${action.color}30 0%, ${action.color}20 100%)`,
                        border: `1px solid ${action.color}50`,
                        color: 'white',
                        fontSize: 14,
                        fontWeight: 700,
                        cursor: 'pointer',
                        transition: 'all 0.2s',
                        display: 'flex',
                        flexDirection: 'column',
                        alignItems: 'center',
                        gap: 8,
                      }}
                      onClick={action.onClick}
                    >
                      <span style={{ fontSize: 24 }}>{action.icon}</span>
                      <span>{action.label}</span>
                    </button>
                  ))}
                </div>
              </div>

              {/* Ïò§ÎäòÏùò ÏàòÏóÖ */}
              {(() => {
                if (!state.lessons || state.lessons.length === 0) return null;

                const today = new Date();
                const todayStr = today.toLocaleDateString('ko-KR');
                const todayLessons = state.lessons.filter(l => l && l.date && new Date(l.date).toLocaleDateString('ko-KR') === todayStr);

                return todayLessons.length > 0 && (
                  <div style={{ marginBottom: 30 }}>
                    <h3 style={{ fontSize: 18, fontWeight: 700, color: 'white', marginBottom: 16 }}>
                      üìö Ïò§ÎäòÏùò ÏàòÏóÖ ({todayLessons.length}Í∞ú)
                    </h3>
                    <div style={{ display: 'grid', gap: 12 }}>
                      {todayLessons.slice(0, 5).map(lesson => (
                        <div
                          key={lesson.id}
                          style={{
                            padding: 16,
                            background: 'rgba(139, 92, 246, 0.2)',
                            border: '1px solid rgba(139, 92, 246, 0.3)',
                            borderRadius: 10,
                          }}
                        >
                          <div style={{ fontSize: 16, fontWeight: 700, color: '#c4b5fd', marginBottom: 4 }}>
                            {lesson.period || 'ÎØ∏Ï†ï'} - {lesson.subject || 'Ï†úÎ™© ÏóÜÏùå'}
                          </div>
                          <div style={{ fontSize: 13, color: 'rgba(255,255,255,0.7)' }}>
                            {lesson.topic || 'Ï£ºÏ†ú ÎØ∏ÏûÖÎ†•'}
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                );
              })()}

              {/* Îã§Í∞ÄÏò§Îäî ÏùºÏ†ï */}
              {state.schedules && state.schedules.length > 0 && (
                <div style={{ marginBottom: 30 }}>
                  <h3 style={{ fontSize: 18, fontWeight: 700, color: 'white', marginBottom: 16 }}>
                    ‚è∞ Îã§Í∞ÄÏò§Îäî ÏùºÏ†ï
                  </h3>
                  {state.schedules
                    .filter(s => s && s.arrivalTs && (s.arrivalTs - (s.departBeforeMin || 30) * 60 * 1000 > nowMs()))
                    .sort((a, b) => a.arrivalTs - b.arrivalTs)
                    .slice(0, 3)
                    .map(sch => (
                      <CountdownBar
                        key={sch.id}
                        schedule={sch}
                        now={nowMs() + tick * 1000}
                        onAlert={handleScheduleAlert}
                      />
                    ))}
                </div>
              )}

              {/* ÏÑ±Í≥º ÏöîÏïΩ */}
              <div>
                <h3 style={{ fontSize: 18, fontWeight: 700, color: 'white', marginBottom: 16 }}>
                  üéØ Ïù¥Î≤à Ï£º ÏÑ±Í≥º
                </h3>
                <div style={{
                  padding: 20,
                  background: 'rgba(0,0,0,0.2)',
                  borderRadius: 12,
                  border: '1px solid rgba(255,255,255,0.1)',
                }}>
                  <div style={{ display: 'grid', gap: 12, fontSize: 14, color: 'rgba(255,255,255,0.8)' }}>
                    <div>
                      ‚Ä¢ ÏßëÏ§ë ÏÑ±Í≥µ ÏÑ∏ÏÖò: {(state.focusHistory || []).filter(f => f && f.success).length}Ìöå
                    </div>
                    <div>
                      ‚Ä¢ ÏôÑÎ£åÎêú Í≥ºÏ†ú: {stats.completed || 0}Í∞ú
                    </div>
                    <div>
                      ‚Ä¢ ÏßÑÌñâ Ï§ëÏù∏ Í≥ºÏ†ú: {(stats.total || 0) - (stats.completed || 0)}Í∞ú
                    </div>
                    <div style={{ color: '#fbbf24', fontWeight: 700, marginTop: 8 }}>
                      Ï¥ù ÌöçÎìù Ìè¨Ïù∏Ìä∏: {(state.points || 0).toLocaleString()}P
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Í≥ºÏ†ú Í¥ÄÎ¶¨ (Ï†ëÍ∏∞/ÌéºÏπòÍ∏∞ + ÏûêÎèô ÏßÑÌñâÎ•†) */}
          {view === 'tasks' && (
            <div style={styles.card} className="animate-in">
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 20, flexWrap: 'wrap', gap: 12 }}>
                <h2 style={styles.h2} className="section-title">‚úÖ Í≥ºÏ†ú Í¥ÄÎ¶¨</h2>
                <div style={{ display: 'flex', gap: 8, alignItems: 'center' }}>
                  <select
                    value={state.taskSortBy}
                    onChange={(e) => setState(p => ({ ...p, taskSortBy: e.target.value }))}
                    style={{
                      padding: '10px 14px',
                      borderRadius: 8,
                      background: 'rgba(255,255,255,0.1)',
                      color: 'white',
                      border: '1px solid rgba(255,255,255,0.2)',
                      fontSize: 13,
                      fontWeight: 700,
                      cursor: 'pointer',
                    }}
                  >
                    <option value="deadline">ÎßàÍ∞êÏùºÏàú</option>
                    <option value="priority">Ïö∞ÏÑ†ÏàúÏúÑÏàú</option>
                    <option value="name">Ïù¥Î¶ÑÏàú</option>
                    <option value="createdAt">ÏµúÏã†Ïàú</option>
                  </select>
                  <button style={styles.btn} onClick={addTask}>
                    ‚ûï ÏÉà Í≥ºÏ†ú Ï∂îÍ∞Ä
                  </button>
                </div>
              </div>

              {filteredTasks.length === 0 && (
                <div style={{ textAlign: 'center', padding: 40, color: 'rgba(255,255,255,0.5)' }}>
                  Îì±Î°ùÎêú Í≥ºÏ†úÍ∞Ä ÏóÜÏäµÎãàÎã§. ÏÉà Í≥ºÏ†úÎ•º Ï∂îÍ∞ÄÌï¥Î≥¥ÏÑ∏Ïöî!
                </div>
              )}

              {filteredTasks.map((task) => {
                const autoProgress = calculateAutoProgress(task);
                const isCollapsed = state.collapsedItems[task.id];

                return (
                  <div
                    key={task.id}
                    style={{
                      padding: 20,
                      borderRadius: 16,
                      background: 'rgba(255,255,255,0.05)',
                      border: '1px solid rgba(255,255,255,0.1)',
                      marginBottom: 16,
                      transition: 'all 0.3s',
                    }}
                  >
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: isCollapsed ? 0 : 16 }}>
                      <div style={{ flex: 1 }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: 10, marginBottom: 8 }}>
                          <span style={{ fontSize: 24 }}>{CATEGORIES[task.category]?.icon}</span>
                          <input
                            className="editable-input"
                            value={task.title}
                            onChange={(e) => updateTask(task.id, { title: e.target.value })}
                            style={{ fontSize: 18, fontWeight: 700 }}
                          />
                          <span className="auto-progress-badge">
                            {autoProgress}%
                          </span>
                        </div>
                      </div>
                      <div style={{ display: 'flex', gap: 8 }}>
                        <button
                          className="collapse-toggle"
                          onClick={() => toggleCollapse(task.id)}
                        >
                          {isCollapsed ? '‚ñº ÌéºÏπòÍ∏∞' : '‚ñ≤ Ï†ëÍ∏∞'}
                        </button>
                        <button 
                          style={{ ...styles.btn2, padding: '8px 12px', background: 'rgba(59, 130, 246, 0.3)' }}
                          onClick={() => addStep(task.id)}
                        >
                          ‚ûï Îã®Í≥Ñ
                        </button>
                        <button 
                          style={{ ...styles.btn2, padding: '8px 12px', background: 'rgba(239, 68, 68, 0.3)' }}
                          onClick={() => deleteTask(task.id)}
                        >
                          üóëÔ∏è
                        </button>
                      </div>
                    </div>

                    <div className={`collapsible ${isCollapsed ? 'collapsed' : ''}`} style={{ maxHeight: isCollapsed ? 0 : '2000px' }}>
                      <div style={{ marginBottom: 12 }}>
                        <div style={{ fontSize: 12, color: 'rgba(255,255,255,0.7)', marginBottom: 6, fontWeight: 700 }}>
                          ÏßÑÌñâÎ•†: {autoProgress}% {task.steps?.length > 0 && `(${task.steps.filter(s => s.done).length}/${task.steps.length} ÏôÑÎ£å)`}
                        </div>
                        <div style={{
                          height: 10,
                          background: 'rgba(0,0,0,0.3)',
                          borderRadius: 5,
                          overflow: 'hidden',
                          border: '1px solid rgba(255,255,255,0.1)',
                        }}>
                          <div style={{
                            height: '100%',
                            width: `${autoProgress}%`,
                            background: autoProgress === 100 ? 'linear-gradient(90deg, #10b981, #059669)' : 'linear-gradient(90deg, #3b82f6, #8b5cf6)',
                            transition: 'width 0.5s cubic-bezier(0.4, 0, 0.2, 1)',
                            boxShadow: autoProgress > 0 ? '0 0 10px rgba(59, 130, 246, 0.5)' : 'none',
                          }} />
                        </div>
                      </div>

                      <div style={{ display: 'flex', gap: 8, marginBottom: 12, flexWrap: 'wrap' }}>
                        <select
                          value={task.category}
                          onChange={(e) => updateTask(task.id, { category: e.target.value })}
                          style={{
                            padding: '8px 12px',
                            borderRadius: 8,
                            background: CATEGORIES[task.category]?.color,
                            color: 'white',
                            border: 'none',
                            fontSize: 13,
                            fontWeight: 700,
                            cursor: 'pointer',
                          }}
                        >
                          {Object.entries(CATEGORIES).map(([key, cat]) => (
                            <option key={key} value={key}>{cat.icon} {cat.label}</option>
                          ))}
                        </select>

                        <select
                          value={task.priority}
                          onChange={(e) => updateTask(task.id, { priority: e.target.value })}
                          style={{
                            padding: '8px 12px',
                            borderRadius: 8,
                            background: 'rgba(255,255,255,0.1)',
                            color: 'white',
                            border: '1px solid rgba(255,255,255,0.2)',
                            fontSize: 13,
                            fontWeight: 700,
                            cursor: 'pointer',
                          }}
                        >
                          {Object.entries(PRIORITIES).map(([key, pri]) => (
                            <option key={key} value={key}>{pri.icon} {pri.label}</option>
                          ))}
                        </select>
                      </div>

                      {/* ÏÉà ÌïÑÎìú: ÎßàÍ∞êÏùºÏãú, Îã¥ÎãπÏûê, ÏÑ§Î™Ö */}
                      <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12, marginBottom: 12 }}>
                        <div>
                          <label style={{ display: 'block', fontSize: 12, color: 'rgba(255,255,255,0.7)', marginBottom: 6, fontWeight: 700 }}>
                            ÎßàÍ∞êÏùºÏãú
                          </label>
                          <input
                            type="datetime-local"
                            value={task.deadline ? toLocalDatetimeValue(task.deadline) : ''}
                            onChange={(e) => updateTask(task.id, { deadline: fromLocalDatetimeValue(e.target.value) })}
                            style={{
                              width: '100%',
                              padding: '8px 12px',
                              borderRadius: 8,
                              background: 'rgba(255,255,255,0.1)',
                              color: 'white',
                              border: '1px solid rgba(255,255,255,0.2)',
                              fontSize: 13,
                            }}
                          />
                          {task.deadline && nowMs() < task.deadline && (() => {
                            const diff = task.deadline - nowMs();
                            const days = Math.floor(diff / (24 * 60 * 60 * 1000));
                            const hours = Math.floor((diff % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000));
                            const minutes = Math.floor((diff % (60 * 60 * 1000)) / (60 * 1000));
                            return (
                              <div style={{
                                marginTop: 6,
                                fontSize: 11,
                                color: diff < 24 * 60 * 60 * 1000 ? '#ef4444' : '#10b981',
                                fontWeight: 700,
                              }}>
                                ÎÇ®ÏùÄ ÏãúÍ∞Ñ: {days}Ïùº {hours}ÏãúÍ∞Ñ {minutes}Î∂Ñ
                              </div>
                            );
                          })()}
                          {task.deadline && nowMs() >= task.deadline && (
                            <div style={{ marginTop: 6, fontSize: 11, color: '#ef4444', fontWeight: 700 }}>
                              ‚ö†Ô∏è ÎßàÍ∞ê ÏßÄÎÇ®
                            </div>
                          )}
                        </div>
                        <div>
                          <label style={{ display: 'block', fontSize: 12, color: 'rgba(255,255,255,0.7)', marginBottom: 6, fontWeight: 700 }}>
                            Îã¥ÎãπÏûê
                          </label>
                          <input
                            type="text"
                            value={task.assignee || ''}
                            onChange={(e) => updateTask(task.id, { assignee: e.target.value })}
                            placeholder="Îã¥ÎãπÏûê Ïù¥Î¶Ñ"
                            style={{
                              width: '100%',
                              padding: '8px 12px',
                              borderRadius: 8,
                              background: 'rgba(255,255,255,0.1)',
                              color: 'white',
                              border: '1px solid rgba(255,255,255,0.2)',
                              fontSize: 13,
                            }}
                          />
                        </div>
                      </div>

                      <div style={{ marginBottom: 12 }}>
                        <label style={{ display: 'block', fontSize: 12, color: 'rgba(255,255,255,0.7)', marginBottom: 6, fontWeight: 700 }}>
                          ÏÑ§Î™Ö
                        </label>
                        <textarea
                          value={task.description || ''}
                          onChange={(e) => updateTask(task.id, { description: e.target.value })}
                          placeholder="Í≥ºÏ†ú ÏÑ§Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."
                          rows={3}
                          style={{
                            width: '100%',
                            padding: '8px 12px',
                            borderRadius: 8,
                            background: 'rgba(255,255,255,0.1)',
                            color: 'white',
                            border: '1px solid rgba(255,255,255,0.2)',
                            fontSize: 13,
                            resize: 'vertical',
                            fontFamily: 'inherit',
                          }}
                        />
                      </div>

                      {task.steps && task.steps.length > 0 && (
                        <div>
                          <div style={{ fontSize: 14, fontWeight: 700, color: 'white', marginBottom: 8 }}>
                            üìù ÏÑ∏Î∂Ä Îã®Í≥Ñ ({task.steps.filter(s => s.done).length}/{task.steps.length})
                          </div>
                          {task.steps.map((step, stepIdx) => (
                            <div
                              key={step.id}
                              style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: 8,
                                marginBottom: 8,
                                padding: 10,
                                background: step.done ? 'rgba(16, 185, 129, 0.1)' : 'rgba(0,0,0,0.2)',
                                borderRadius: 8,
                                border: step.done ? '1px solid rgba(16, 185, 129, 0.3)' : '1px solid rgba(255,255,255,0.1)',
                                transition: 'all 0.3s',
                              }}
                            >
                              <input
                                type="checkbox"
                                checked={step.done}
                                onChange={() => {
                                  toggleStep(task.id, step.id);
                                  // Ï≤¥ÌÅ¨ ÌõÑ ÏôÑÎ£å Ïó¨Î∂Ä ÌôïÏù∏ (ÏïΩÍ∞ÑÏùò ÏßÄÏó∞ÏùÑ ÎëêÏñ¥ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ ÎåÄÍ∏∞)
                                  setTimeout(() => completeTask(task.id), 100);
                                }}
                                style={{ width: 10, height: 10, cursor: 'pointer', minWidth: 10, minHeight: 10 }}
                              />
                              <span style={{
                                flex: 1,
                                textDecoration: step.done ? 'line-through' : 'none',
                                opacity: step.done ? 0.6 : 1,
                                fontSize: 13,
                              }}>
                                {step.text}
                              </span>
                              <div style={{ display: 'flex', gap: 4 }}>
                                <button
                                  onClick={() => moveStepUp(task.id, step.id)}
                                  disabled={stepIdx === 0}
                                  style={{
                                    padding: '4px 8px',
                                    background: stepIdx === 0 ? 'rgba(255,255,255,0.05)' : 'rgba(59, 130, 246, 0.2)',
                                    border: '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: 6,
                                    color: stepIdx === 0 ? 'rgba(255,255,255,0.3)' : 'white',
                                    fontSize: 11,
                                    cursor: stepIdx === 0 ? 'not-allowed' : 'pointer',
                                    fontWeight: 700,
                                  }}
                                  title="ÏúÑÎ°ú Ïù¥Îèô"
                                >
                                  ‚ñ≤
                                </button>
                                <button
                                  onClick={() => moveStepDown(task.id, step.id)}
                                  disabled={stepIdx === task.steps.length - 1}
                                  style={{
                                    padding: '4px 8px',
                                    background: stepIdx === task.steps.length - 1 ? 'rgba(255,255,255,0.05)' : 'rgba(59, 130, 246, 0.2)',
                                    border: '1px solid rgba(255,255,255,0.1)',
                                    borderRadius: 6,
                                    color: stepIdx === task.steps.length - 1 ? 'rgba(255,255,255,0.3)' : 'white',
                                    fontSize: 11,
                                    cursor: stepIdx === task.steps.length - 1 ? 'not-allowed' : 'pointer',
                                    fontWeight: 700,
                                  }}
                                  title="ÏïÑÎûòÎ°ú Ïù¥Îèô"
                                >
                                  ‚ñº
                                </button>
                                <button
                                  onClick={() => editStep(task.id, step.id)}
                                  style={{
                                    padding: '4px 8px',
                                    background: 'rgba(251, 191, 36, 0.2)',
                                    border: '1px solid rgba(251, 191, 36, 0.3)',
                                    borderRadius: 6,
                                    color: 'white',
                                    fontSize: 11,
                                    cursor: 'pointer',
                                    fontWeight: 700,
                                  }}
                                  title="ÏàòÏ†ï"
                                >
                                  ‚úèÔ∏è
                                </button>
                                <button
                                  onClick={() => deleteStep(task.id, step.id)}
                                  style={{
                                    padding: '4px 8px',
                                    background: 'rgba(239, 68, 68, 0.2)',
                                    border: '1px solid rgba(239, 68, 68, 0.3)',
                                    borderRadius: 6,
                                    color: 'white',
                                    fontSize: 11,
                                    cursor: 'pointer',
                                    fontWeight: 700,
                                  }}
                                  title="ÏÇ≠Ï†ú"
                                >
                                  üóëÔ∏è
                                </button>
                              </div>
                              {step.done && <span style={{ fontSize: 16 }}>‚úÖ</span>}
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
          )}

          {/* ÏàòÏóÖ Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú */}
          {view === 'teaching' && (
            <div style={styles.card} className="animate-in">
              <h2 style={styles.h2} className="section-title">üë®‚Äçüè´ ÏàòÏóÖ Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú</h2>
              <p style={{ color: 'rgba(255,255,255,0.7)', fontSize: 14, marginBottom: 20 }}>
                Ï£ºÍ∞Ñ Ï∫òÎ¶∞ÎçîÏóêÏÑú ÎÇ†ÏßúÎ≥Ñ ÏàòÏóÖÏùÑ Í¥ÄÎ¶¨ÌïòÍ≥†, Î∞òÎ≥µ ÏàòÏóÖÏùÑ ÏÜêÏâΩÍ≤å Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî.
              </p>

              <div style={{ marginBottom: 20, display: 'flex', gap: 10, flexWrap: 'wrap', alignItems: 'center' }}>
                <button
                  style={styles.btn}
                  onClick={() => setEditingLesson({ date: lessonWeekStart.getTime(), period: '1ÍµêÏãú' })}
                >
                  ‚ûï ÏàòÏóÖ Ï∂îÍ∞Ä
                </button>
                <button
                  style={{ ...styles.btn, background: 'linear-gradient(135deg, #10b981, #059669)' }}
                  onClick={exportLessonsAndEvalsCSV}
                >
                  üíæ ÏàòÏóÖ Î∞è ÌèâÍ∞Ä CSV Ï†ÄÏû•
                </button>
                <label className="file-input-label">
                  üì• CSV Î∂àÎü¨Ïò§Í∏∞
                  <input type="file" accept=".csv" onChange={importLessonsCSV} />
                </label>
              </div>

              <div className="calendar-header" style={{ marginBottom: 16 }}>
                <button
                  style={{ ...styles.btn2, padding: '10px 16px' }}
                  onClick={() => setLessonWeekStart(addDays(lessonWeekStart, -7))}
                >
                  ‚óÄ Ïù¥Ï†Ñ Ï£º
                </button>
                <div style={{ fontSize: 18, fontWeight: 800, color: 'white' }}>
                  {getWeekLabel(lessonWeekStart)}
                </div>
                <button
                  style={{ ...styles.btn2, padding: '10px 16px' }}
                  onClick={() => setLessonWeekStart(addDays(lessonWeekStart, 7))}
                >
                  Îã§Ïùå Ï£º ‚ñ∂
                </button>
              </div>

              {/* Ï£ºÍ∞Ñ ÏàòÏóÖÌëú */}
              <div className="timetable">
                <div className="timetable-header">ÍµêÏãú</div>
                {lessonWeekDates.map((dayDate) => (
                  <div key={dayDate.toISOString()} className="timetable-header">
                    <div>{getDayLabel(dayDate)}ÏöîÏùº</div>
                    <div style={{ fontSize: 11, marginTop: 4 }}>
                      {dayDate.toLocaleDateString('ko-KR', { month: 'numeric', day: 'numeric' })}
                    </div>
                  </div>
                ))}

                {PERIODS.map((period) => (
                  <React.Fragment key={period}>
                    <div className="timetable-cell" style={{ fontWeight: 900, background: 'rgba(59, 130, 246, 0.1)', display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
                      {period}
                    </div>
                    {lessonWeekDates.map((dayDate) => {
                      const lessons = state.lessons.filter(l => {
                        if (l.date) return isSameDay(l.date, dayDate) && l.period === period;
                        return l.dayOfWeek === getDayLabel(dayDate) && l.period === period;
                      });

                      return (
                        <div
                          key={`${dayDate.toISOString()}-${period}`}
                          className="timetable-cell"
                          onClick={() => setEditingLesson({ date: dayDate.getTime(), period })}
                        >
                          {lessons.length === 0 ? (
                            <div style={{ textAlign: 'center', color: 'rgba(255,255,255,0.3)', fontSize: 11 }}>
                              + ÏàòÏóÖ Ï∂îÍ∞Ä
                            </div>
                          ) : (
                            lessons.map(lesson => {
                              const subjectColor = lesson.subject && SUBJECTS[lesson.subject]
                                ? SUBJECTS[lesson.subject].color
                                : '#8b5cf6';
                              return (
                                <div
                                  key={lesson.id}
                                  className="lesson-card"
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    setEditingLesson(lesson);
                                  }}
                                  style={{
                                    background: `linear-gradient(135deg, ${subjectColor}50, ${subjectColor}30)`,
                                    border: `1px solid ${subjectColor}80`,
                                  }}
                                >
                                  <div className="lesson-card-title">{lesson.subject}</div>
                                  <div className="lesson-card-subtitle">
                                    {lesson.topic || 'Ï†úÏû¨ ÎØ∏ÏûÖÎ†•'}
                                  </div>
                                  <div style={{ fontSize: 9, marginTop: 4, color: 'rgba(255,255,255,0.6)' }}>
                                    {lesson.goal ? `Î™©Ìëú: ${lesson.goal.slice(0, 20)}${lesson.goal.length > 20 ? '...' : ''}` : ''}
                                  </div>
                                </div>
                              );
                            })
                          )}
                        </div>
                      );
                    })}
                  </React.Fragment>
                ))}
              </div>

            </div>
          )}

          {/* ÏßëÏ§ë ÌÉÄÏù¥Î®∏ */}
          {view === 'focus' && (
            <div style={styles.card} className="animate-in">
              <h2 style={styles.h2} className="section-title">‚è±Ô∏è ÏßëÏ§ë ÌÉÄÏù¥Î®∏</h2>
              <p style={{ color: 'rgba(255,255,255,0.7)', fontSize: 14, marginBottom: 16 }}>
                Í∞ÑÎã®Ìïú ÏßëÏ§ë ÌÉÄÏù¥Î®∏Î°ú ÏàòÏóÖ Ï§ÄÎπÑ, Í∏∞Î°ù ÏûëÏÑ± ÏãúÍ∞ÑÏùÑ Í¥ÄÎ¶¨ÌïòÏÑ∏Ïöî.
              </p>

              <CircularTimer remainingMs={focusStatus.remainingMs} totalMs={state.focus.durationSec * 1000} />

              <div style={{ marginTop: 20, display: 'grid', gap: 12 }}>
                <div className="form-grid">
                  <div>
                    <label style={{ fontWeight: 700, color: 'rgba(255,255,255,0.8)' }}>ÏßëÏ§ë ÏãúÍ∞Ñ(Î∂Ñ)</label>
                    <input
                      type="number"
                      min="1"
                      className="form-control"
                      value={focusDraft.durationMin}
                      onChange={(e) => setFocusDraft({ ...focusDraft, durationMin: parseInt(e.target.value) || 1 })}
                    />
                  </div>
                  <div>
                    <label style={{ fontWeight: 700, color: 'rgba(255,255,255,0.8)' }}>Î©îÎ™®</label>
                    <input
                      className="form-control"
                      value={focusDraft.note}
                      onChange={(e) => setFocusDraft({ ...focusDraft, note: e.target.value })}
                      placeholder="Ïòà: ÌñâÎèô Í∏∞Î°ù Ï†ïÎ¶¨"
                    />
                  </div>
                  <div>
                    <label style={{ fontWeight: 700, color: 'rgba(255,255,255,0.8)' }}>ÏÉÅÌÉú</label>
                    <div style={{ padding: '12px 14px', borderRadius: 10, background: 'rgba(255,255,255,0.08)', border: '1px solid rgba(255,255,255,0.15)' }}>
                      {state.focus.running ? (state.focus.paused ? 'ÏùºÏãúÏ†ïÏßÄ' : 'ÏßëÏ§ë Ï§ë') : 'ÎåÄÍ∏∞'}
                    </div>
                  </div>
                </div>

                <div style={{ display: 'flex', gap: 10, flexWrap: 'wrap' }}>
                  {!state.focus.running && (
                    <button style={styles.btn} onClick={startFocus}>
                      ‚ñ∂Ô∏è ÏãúÏûë
                    </button>
                  )}
                  {state.focus.running && !state.focus.paused && (
                    <button style={{ ...styles.btn, background: 'linear-gradient(135deg, #f59e0b, #d97706)' }} onClick={pauseFocus}>
                      ‚è∏Ô∏è ÏùºÏãúÏ†ïÏßÄ
                    </button>
                  )}
                  {state.focus.running && state.focus.paused && (
                    <button style={{ ...styles.btn, background: 'linear-gradient(135deg, #10b981, #059669)' }} onClick={resumeFocus}>
                      ‚ñ∂Ô∏è Ïû¨Í∞ú
                    </button>
                  )}
                  <button style={{ ...styles.btn2, padding: '12px 20px' }} onClick={resetFocus}>
                    üîÑ Ï¥àÍ∏∞Ìôî
                  </button>
                </div>
              </div>

              {/* ÏßëÏ§ë Í∏∞Î°ù */}
              {state.focusHistory && state.focusHistory.length > 0 && (
                <div style={{ ...styles.card, marginTop: 20 }}>
                  <h3 style={{ fontSize: 18, fontWeight: 800, color: 'white', marginBottom: 16 }}>
                    üìä ÏßëÏ§ë Í∏∞Î°ù ({state.focusHistory.length}Í±¥)
                  </h3>
                  <div style={{ display: 'grid', gap: 12 }}>
                    {state.focusHistory.slice(0, 10).map(record => (
                      <div key={record.id} style={{
                        padding: 16,
                        background: 'rgba(255,255,255,0.08)',
                        border: '1px solid rgba(255,255,255,0.15)',
                        borderRadius: 10,
                      }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: 8 }}>
                          <div>
                            <div style={{ fontSize: 14, fontWeight: 700, color: 'white', marginBottom: 4 }}>
                              {record.note || 'ÏßëÏ§ë ÏÑ∏ÏÖò'}
                            </div>
                            <div style={{ fontSize: 12, color: 'rgba(255,255,255,0.6)' }}>
                              {formatDateTime(record.completedAt)}
                            </div>
                          </div>
                          <div style={{ fontSize: 16, fontWeight: 700, color: '#a78bfa' }}>
                            {Math.round(record.duration / 60)}Î∂Ñ
                          </div>
                        </div>
                        <div style={{ display: 'flex', gap: 8, marginTop: 12 }}>
                          <button
                            style={{ ...styles.btn2, padding: '8px 16px', fontSize: 12 }}
                            onClick={() => editFocusHistory(record.id)}
                          >
                            ‚úèÔ∏è ÏàòÏ†ï
                          </button>
                          <button
                            style={{ ...styles.btn2, padding: '8px 16px', fontSize: 12, background: 'rgba(239, 68, 68, 0.3)' }}
                            onClick={() => deleteFocusHistory(record.id)}
                          >
                            üóëÔ∏è ÏÇ≠Ï†ú
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          )}

          {/* Ìè¨Ïù∏Ìä∏ Í¥ÄÎ¶¨ */}
          {view === 'points' && (
            <div style={styles.card} className="animate-in">
              <h2 style={styles.h2} className="section-title">ü™ô Ìè¨Ïù∏Ìä∏ Í¥ÄÎ¶¨</h2>
              <p style={{ color: 'rgba(255,255,255,0.7)', fontSize: 14, marginBottom: 20 }}>
                ÏßëÏ§ë ÏÑ±Í≥µ, Í≥ºÏ†ú ÏôÑÎ£å Îì±ÏúºÎ°ú Ìè¨Ïù∏Ìä∏Î•º ÌöçÎìùÌïòÍ≥† Í¥ÄÎ¶¨ÌïòÏÑ∏Ïöî.
              </p>

              {/* ÌòÑÏû¨ Ìè¨Ïù∏Ìä∏ ÌëúÏãú */}
              <div style={{
                padding: 30,
                borderRadius: 16,
                background: 'linear-gradient(135deg, rgba(251, 191, 36, 0.3), rgba(245, 158, 11, 0.3))',
                border: '2px solid rgba(251, 191, 36, 0.4)',
                marginBottom: 24,
                textAlign: 'center',
              }}>
                <div style={{ fontSize: 16, color: 'rgba(255,255,255,0.8)', marginBottom: 8 }}>Î≥¥Ïú† Ìè¨Ïù∏Ìä∏</div>
                <div style={{ fontSize: 48, fontWeight: 900, color: '#fbbf24' }}>{state.points.toLocaleString()}</div>
                <div style={{ fontSize: 14, color: 'rgba(255,255,255,0.6)', marginTop: 4 }}>P</div>
              </div>

              {/* Ìè¨Ïù∏Ìä∏ Ï°∞Ï†ï ÏÑπÏÖò */}
              <div style={{
                padding: 20,
                background: 'rgba(0,0,0,0.2)',
                borderRadius: 12,
                border: '1px solid rgba(255,255,255,0.1)',
                marginBottom: 24,
              }}>
                <h3 style={{ fontSize: 18, fontWeight: 700, color: 'white', marginBottom: 16 }}>
                  ‚öôÔ∏è Ìè¨Ïù∏Ìä∏ Ï°∞Ï†ï
                </h3>

                <div style={{ display: 'grid', gap: 16 }}>
                  <div className="form-field">
                    <label style={{ fontWeight: 700, color: 'rgba(255,255,255,0.8)' }}>Ìè¨Ïù∏Ìä∏ Î≥ÄÍ≤Ω</label>
                    <div style={{ display: 'flex', gap: 8 }}>
                      <input
                        type="number"
                        placeholder="Ìè¨Ïù∏Ìä∏ ÏûÖÎ†•"
                        id="pointsInput"
                        className="form-control"
                        style={{ flex: 1 }}
                      />
                      <button
                        style={{
                          padding: '10px 16px',
                          background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
                          border: 'none',
                          borderRadius: 8,
                          color: 'white',
                          fontSize: 13,
                          fontWeight: 700,
                          cursor: 'pointer',
                          transition: 'all 0.2s',
                        }}
                        onClick={() => {
                          const input = document.getElementById('pointsInput');
                          const value = parseInt(input.value) || 0;
                          if (value !== 0) {
                            setState(p => ({ ...p, points: p.points + value }));
                            setShowAlert({
                              title: value > 0 ? '‚úÖ Ìè¨Ïù∏Ìä∏ Ï∂îÍ∞Ä' : '‚ö†Ô∏è Ìè¨Ïù∏Ìä∏ Ï∞®Í∞ê',
                              message: `${Math.abs(value)}Ìè¨Ïù∏Ìä∏Í∞Ä ${value > 0 ? 'Ï∂îÍ∞Ä' : 'Ï∞®Í∞ê'}ÎêòÏóàÏäµÎãàÎã§.`
                            });
                            setTimeout(() => setShowAlert(null), 3000);
                            input.value = '';
                          }
                        }}
                      >
                        ‚ûï Ï∂îÍ∞Ä
                      </button>
                      <button
                        style={{
                          padding: '10px 16px',
                          background: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',
                          border: 'none',
                          borderRadius: 8,
                          color: 'white',
                          fontSize: 13,
                          fontWeight: 700,
                          cursor: 'pointer',
                          transition: 'all 0.2s',
                        }}
                        onClick={() => {
                          const input = document.getElementById('pointsInput');
                          const value = parseInt(input.value) || 0;
                          if (value !== 0) {
                            setState(p => ({ ...p, points: Math.max(0, p.points - value) }));
                            setShowAlert({
                              title: '‚ö†Ô∏è Ìè¨Ïù∏Ìä∏ Ï∞®Í∞ê',
                              message: `${value}Ìè¨Ïù∏Ìä∏Í∞Ä Ï∞®Í∞êÎêòÏóàÏäµÎãàÎã§.`
                            });
                            setTimeout(() => setShowAlert(null), 3000);
                            input.value = '';
                          }
                        }}
                      >
                        ‚ûñ Ï∞®Í∞ê
                      </button>
                    </div>
                  </div>

                  <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(120px, 1fr))', gap: 10 }}>
                    {[10, 50, 100, 500].map(amount => (
                      <button
                        key={amount}
                        style={{
                          padding: '12px',
                          background: 'rgba(251, 191, 36, 0.2)',
                          border: '1px solid rgba(251, 191, 36, 0.3)',
                          borderRadius: 8,
                          color: '#fbbf24',
                          fontSize: 14,
                          fontWeight: 700,
                          cursor: 'pointer',
                          transition: 'all 0.2s',
                        }}
                        onClick={() => {
                          setState(p => ({ ...p, points: p.points + amount }));
                          setShowAlert({
                            title: '‚úÖ Ìè¨Ïù∏Ìä∏ Ï∂îÍ∞Ä',
                            message: `${amount}Ìè¨Ïù∏Ìä∏Í∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.`
                          });
                          setTimeout(() => setShowAlert(null), 3000);
                        }}
                      >
                        +{amount}P
                      </button>
                    ))}
                  </div>
                </div>
              </div>

              {/* Ìè¨Ïù∏Ìä∏ Ïù¥Î†• */}
              <div style={{
                padding: 20,
                background: 'rgba(0,0,0,0.2)',
                borderRadius: 12,
                border: '1px solid rgba(255,255,255,0.1)',
              }}>
                <h3 style={{ fontSize: 18, fontWeight: 700, color: 'white', marginBottom: 16 }}>
                  üìä Ìè¨Ïù∏Ìä∏ ÌöçÎìù Ïù¥Î†•
                </h3>
                <div style={{ fontSize: 14, color: 'rgba(255,255,255,0.7)' }}>
                  <div style={{ marginBottom: 12 }}>
                    ‚Ä¢ ÏßëÏ§ë ÏÑ±Í≥µ: +100 Ìè¨Ïù∏Ìä∏
                  </div>
                  <div style={{ marginBottom: 12 }}>
                    ‚Ä¢ ÎßàÍ∞êÏùº Ï†Ñ Í≥ºÏ†ú ÏôÑÎ£å: +100 Ìè¨Ïù∏Ìä∏
                  </div>
                  <div style={{ color: 'rgba(255,255,255,0.5)', fontSize: 12, marginTop: 16 }}>
                    Ìè¨Ïù∏Ìä∏Îäî ÏßëÏ§ë ÌÉÄÏù¥Î®∏Î•º ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏôÑÎ£åÌïòÍ±∞ÎÇò Í≥ºÏ†úÎ•º ÎßàÍ∞êÏùº Ï†ÑÏóê ÏôÑÎ£åÌïòÎ©¥ ÏûêÎèôÏúºÎ°ú ÎàÑÏ†ÅÎê©ÎãàÎã§.
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* ÏùºÏ†ï ÏïåÎûå */}
          {view === 'schedule' && (
            <div style={styles.card} className="animate-in">
              <h2 style={styles.h2} className="section-title">üöó ÏùºÏ†ï Í¥ÄÎ¶¨ & Ï∂úÎ∞ú ÏïåÎûå</h2>
              <p style={{ color: 'rgba(255,255,255,0.7)', fontSize: 14, marginBottom: 16, padding: 12, background: 'rgba(239, 68, 68, 0.1)', borderRadius: 8, border: '1px solid rgba(239, 68, 68, 0.3)' }}>
                ‚è∞ <strong>Ï∂úÎ∞ú ÏãúÍ∞ÑÏóê ÏûêÎèôÏúºÎ°ú ÏïåÎ¶ºÏù¥ Ïö∏Î¶ΩÎãàÎã§!</strong> ÏùºÏ†ï Ï∂îÍ∞Ä ÌõÑ Ï∂úÎ∞ú Ï†Ñ ÏïåÎ¶ºÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî.
              </p>

              <div style={{ display: 'grid', gap: 12, marginBottom: 20 }}>
                <div className="form-field">
                  <label style={{ fontWeight: 700, color: 'rgba(255,255,255,0.8)' }}>ÏùºÏ†ï Ïù¥Î¶Ñ *</label>
                  <input
                    className="form-control"
                    value={scheduleDraft.name}
                    onChange={(e) => setScheduleDraft({ ...scheduleDraft, name: e.target.value })}
                    placeholder="Ïòà: ÏÉÅÎã¥ ÏùºÏ†ï, ÌïôÍµê ÌöåÏùò"
                  />
                </div>
                <div className="form-field">
                  <label style={{ fontWeight: 700, color: 'rgba(255,255,255,0.8)' }}>ÎèÑÏ∞© ÏãúÍ∞Ñ *</label>
                  <input
                    type="datetime-local"
                    className="form-control"
                    value={scheduleDraft.arrivalTs}
                    onChange={(e) => setScheduleDraft({ ...scheduleDraft, arrivalTs: e.target.value })}
                  />
                </div>
                <div className="form-grid">
                  <div>
                    <label style={{ fontWeight: 700, color: 'rgba(255,255,255,0.8)' }}>Ï∂úÎ∞ú Ï†Ñ ÏïåÎ¶º(Î∂Ñ)</label>
                    <input
                      type="number"
                      min="0"
                      className="form-control"
                      value={scheduleDraft.departBeforeMin}
                      onChange={(e) => setScheduleDraft({ ...scheduleDraft, departBeforeMin: e.target.value })}
                    />
                  </div>
                  <div>
                    <label style={{ fontWeight: 700, color: 'rgba(255,255,255,0.8)' }}>Ïû•ÏÜå</label>
                    <input
                      className="form-control"
                      value={scheduleDraft.location}
                      onChange={(e) => setScheduleDraft({ ...scheduleDraft, location: e.target.value })}
                      placeholder="Ïòà: ÍµêÎ¨¥Ïã§"
                    />
                  </div>
                  <div>
                    <label style={{ fontWeight: 700, color: 'rgba(255,255,255,0.8)' }}>Î©îÎ™®</label>
                    <input
                      className="form-control"
                      value={scheduleDraft.note}
                      onChange={(e) => setScheduleDraft({ ...scheduleDraft, note: e.target.value })}
                      placeholder="Ï§ÄÎπÑÎ¨º Îì±"
                    />
                  </div>
                </div>
                <button style={styles.btn} onClick={addSchedule}>
                  ‚ûï ÏùºÏ†ï Ï∂îÍ∞Ä
                </button>
              </div>

              {state.schedules.length === 0 && (
                <div style={{ textAlign: 'center', padding: 40, color: 'rgba(255,255,255,0.5)' }}>
                  Îì±Î°ùÎêú ÏùºÏ†ïÏù¥ ÏóÜÏäµÎãàÎã§.
                </div>
              )}

              {state.schedules
                .slice()
                .sort((a, b) => a.arrivalTs - b.arrivalTs)
                .map(sch => (
                  <div key={sch.id} style={{ marginBottom: 16 }}>
                    <CountdownBar 
                      schedule={sch} 
                      now={nowMs() + tick * 1000}
                      onAlert={handleScheduleAlert}
                    />
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', gap: 10, marginTop: 8, paddingLeft: 8 }}>
                      <div style={{ fontSize: 12, color: 'rgba(255,255,255,0.7)' }}>
                        {sch.location ? `üìç ${sch.location}` : 'üìç ÏúÑÏπò ÎØ∏ÏûÖÎ†•'} {sch.note ? `‚Ä¢ ${sch.note}` : ''}
                      </div>
                      <div style={{ display: 'flex', gap: 8 }}>
                        <button
                          style={{ ...styles.btn, padding: '8px 16px', fontSize: 12, background: 'linear-gradient(135deg, #10b981, #059669)' }}
                          onClick={() => completeScheduleArrival(sch)}
                        >
                          ‚úÖ ÎèÑÏ∞© ÏôÑÎ£å
                        </button>
                        <button
                          style={{ ...styles.btn2, padding: '8px 16px', fontSize: 12, background: 'rgba(239, 68, 68, 0.3)' }}
                          onClick={() => deleteSchedule(sch.id)}
                        >
                          ÏÇ≠Ï†ú
                        </button>
                      </div>
                    </div>
                  </div>
                ))}

              {/* ÏùºÏ†ï ÎèÑÏ∞© Í∏∞Î°ù */}
              {state.scheduleHistory && state.scheduleHistory.length > 0 && (
                <div style={{ ...styles.card, marginTop: 20 }}>
                  <h3 style={{ fontSize: 18, fontWeight: 800, color: 'white', marginBottom: 16 }}>
                    üìä ÏùºÏ†ï ÎèÑÏ∞© Í∏∞Î°ù ({state.scheduleHistory.length}Í±¥)
                  </h3>
                  <div style={{ display: 'grid', gap: 12 }}>
                    {state.scheduleHistory.slice(0, 10).map(record => (
                      <div key={record.id} style={{
                        padding: 16,
                        background: 'rgba(255,255,255,0.08)',
                        border: '1px solid rgba(255,255,255,0.15)',
                        borderRadius: 10,
                      }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start', marginBottom: 8 }}>
                          <div>
                            <div style={{ fontSize: 14, fontWeight: 700, color: 'white', marginBottom: 4 }}>
                              {record.scheduleName}
                            </div>
                            <div style={{ fontSize: 12, color: 'rgba(255,255,255,0.6)' }}>
                              ÎèÑÏ∞©: {formatDateTime(record.arrivalTime)}
                            </div>
                            {record.location && (
                              <div style={{ fontSize: 12, color: 'rgba(255,255,255,0.6)', marginTop: 2 }}>
                                üìç {record.location}
                              </div>
                            )}
                          </div>
                          <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'end', gap: 4 }}>
                            <span style={{
                              padding: '4px 12px',
                              borderRadius: 6,
                              fontSize: 12,
                              fontWeight: 700,
                              background: record.onTime ? 'rgba(16, 185, 129, 0.3)' : 'rgba(239, 68, 68, 0.3)',
                              color: record.onTime ? '#6ee7b7' : '#fca5a5',
                            }}>
                              {record.onTime ? '‚úÖ Ï†ïÏãú' : '‚è∞ Îä¶Ïùå'}
                            </span>
                            <div style={{ fontSize: 14, fontWeight: 700, color: '#fbbf24' }}>
                              +{record.points} P
                            </div>
                          </div>
                        </div>
                        <div style={{ display: 'flex', gap: 8, marginTop: 12 }}>
                          <button
                            style={{ ...styles.btn2, padding: '8px 16px', fontSize: 12 }}
                            onClick={() => editScheduleHistory(record.id)}
                          >
                            ‚úèÔ∏è ÏàòÏ†ï
                          </button>
                          <button
                            style={{ ...styles.btn2, padding: '8px 16px', fontSize: 12, background: 'rgba(239, 68, 68, 0.3)' }}
                            onClick={() => deleteScheduleHistory(record.id)}
                          >
                            üóëÔ∏è ÏÇ≠Ï†ú
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          )}

          {/* Ï∫òÎ¶∞Îçî */}
          {view === 'calendar' && (
            <div style={styles.card} className="animate-in">
              <h2 style={styles.h2} className="section-title">üìÖ ÏõîÎ≥Ñ Ï∫òÎ¶∞Îçî</h2>
              <Calendar tasks={state.tasks} schedules={state.schedules} lessons={state.lessons} />
            </div>
          )}

          {/* PBS ÌñâÎèôÏßÄÏõê (ÌñâÎèô Ìä∏ÎûòÌÇπ) */}
          {view === 'behavior' && (
            <div style={styles.card} className="animate-in">
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 20, flexWrap: 'wrap', gap: 10 }}>
                <h2 style={styles.h2} className="section-title">üéØ PBS Ï£ºÍ∞Ñ ÌñâÎèô Î∂ÑÌè¨ Í∏∞Î°ùÏßÄ</h2>
                <div style={{ display: 'flex', gap: 10, flexWrap: 'wrap' }}>
                  <button
                    style={styles.btn}
                    onClick={() => setEditingBehavior({ behaviorType: 'TARGET', frequency: 1, intensity: 1, duration: 0 })}
                  >
                    ‚ûï ÌñâÎèô Í∏∞Î°ù Ï∂îÍ∞Ä
                  </button>
                  <button
                    style={{ ...styles.btn, background: 'linear-gradient(135deg, #10b981, #059669)' }}
                    onClick={() => exportBehaviorLogCSV(state.behaviorLog)}
                  >
                    üíæ CSV ÎÇ¥Î≥¥ÎÇ¥Í∏∞
                  </button>
                </div>
              </div>

              <div className="calendar-header" style={{ marginBottom: 16 }}>
                <button
                  style={{ ...styles.btn2, padding: '10px 16px' }}
                  onClick={() => setBehaviorWeekStart(addDays(behaviorWeekStart, -7))}
                >
                  ‚óÄ Ïù¥Ï†Ñ Ï£º
                </button>
                <div style={{ fontSize: 18, fontWeight: 800, color: 'white' }}>
                  {behaviorWeekStart.toLocaleDateString('ko-KR', { month: 'long', day: 'numeric' })} Ï£ºÍ∞Ñ
                </div>
                <button
                  style={{ ...styles.btn2, padding: '10px 16px' }}
                  onClick={() => setBehaviorWeekStart(addDays(behaviorWeekStart, 7))}
                >
                  Îã§Ïùå Ï£º ‚ñ∂
                </button>
              </div>

              <div className="chart-actions" style={{ marginBottom: 16 }}>
                <select
                  value={behaviorWeekStudent}
                  onChange={(e) => setBehaviorWeekStudent(e.target.value)}
                  className="form-select"
                >
                  <option value="ALL">Ï†ÑÏ≤¥ ÌïôÏÉù</option>
                  {behaviorStudents.map(student => (
                    <option key={student} value={student}>{student}</option>
                  ))}
                </select>
              </div>

              <p style={{ color: 'rgba(255,255,255,0.7)', fontSize: 14, marginBottom: 20, padding: 12, background: 'rgba(139, 92, 246, 0.1)', borderRadius: 8, border: '1px solid rgba(139, 92, 246, 0.3)' }}>
                üìä <strong>Ï£ºÍ∞Ñ Î∂ÑÌè¨ Í∏∞Î°ùÏßÄ:</strong> ÏöîÏùºÎ≥Ñ ÌñâÎèô Î∞úÏÉù Î∂ÑÌè¨Î•º ÌïúÎààÏóê ÌôïÏù∏ÌïòÍ≥†, ABC Í∏∞Î°ùÏúºÎ°ú Ïó∞Í≤∞Ìï©ÎãàÎã§.
              </p>

              <div style={{ display: 'grid', gap: 12 }}>
                {behaviorWeekDates.map((dayDate) => {
                  const dayLogs = weeklyBehaviorLogs.filter(log => isSameDay(log.timestamp, dayDate));
                  const typeCounts = {};
                  dayLogs.forEach(log => {
                    const label = BEHAVIOR_TYPES[log.behaviorType]?.label || log.behaviorType;
                    typeCounts[label] = (typeCounts[label] || 0) + 1;
                  });

                  return (
                    <div
                      key={dayDate.toISOString()}
                      style={{
                        padding: 16,
                        borderRadius: 14,
                        background: 'rgba(255,255,255,0.05)',
                        border: '1px solid rgba(255,255,255,0.1)',
                      }}
                    >
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 10 }}>
                        <div style={{ fontSize: 16, fontWeight: 800, color: 'white' }}>
                          {getDayLabel(dayDate)}ÏöîÏùº ¬∑ {dayDate.toLocaleDateString('ko-KR', { month: 'numeric', day: 'numeric' })}
                        </div>
                        <div style={{ fontSize: 12, color: 'rgba(255,255,255,0.6)' }}>
                          Ï¥ù {dayLogs.length}Í±¥
                        </div>
                      </div>

                      <div style={{ display: 'flex', flexWrap: 'wrap', gap: 8, marginBottom: 12 }}>
                        {Object.entries(BEHAVIOR_TYPES).map(([key, type]) => (
                          <div
                            key={key}
                            style={{
                              padding: '6px 10px',
                              borderRadius: 999,
                              border: `1px solid ${type.color}55`,
                              background: `${type.color}20`,
                              fontSize: 12,
                              color: 'white',
                              fontWeight: 700,
                            }}
                          >
                            {type.icon} {type.label} ¬∑ {typeCounts[type.label] || 0}
                          </div>
                        ))}
                      </div>

                      {dayLogs.length === 0 ? (
                        <div style={{ fontSize: 13, color: 'rgba(255,255,255,0.5)' }}>
                          Í∏∞Î°ùÎêú ÌñâÎèôÏù¥ ÏóÜÏäµÎãàÎã§.
                        </div>
                      ) : (
                        <div style={{ display: 'grid', gap: 8 }}>
                          {dayLogs.map(log => (
                            <div
                              key={log.id}
                              style={{
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center',
                                padding: '10px 12px',
                                borderRadius: 10,
                                background: 'rgba(0,0,0,0.2)',
                              }}
                            >
                              <div>
                                <div style={{ fontSize: 13, fontWeight: 700, color: 'white' }}>
                                  {log.studentName} ¬∑ {log.behavior}
                                </div>
                                <div style={{ fontSize: 11, color: 'rgba(255,255,255,0.6)' }}>
                                  {BEHAVIOR_TYPES[log.behaviorType]?.label} ¬∑ {log.antecedent || 'ÏÑ†ÌñâÏÇ¨Í±¥ ÎØ∏ÏûÖÎ†•'}
                                </div>
                              </div>
                              <div style={{ display: 'flex', gap: 6 }}>
                                <button
                                  style={{ ...styles.btn2, padding: '6px 10px', background: 'rgba(59, 130, 246, 0.3)' }}
                                  onClick={() => setEditingBehavior(log)}
                                >
                                  ÏàòÏ†ï
                                </button>
                                <button
                                  style={{ ...styles.btn2, padding: '6px 10px', background: 'rgba(239, 68, 68, 0.3)' }}
                                  onClick={() => deleteBehaviorLog(log.id)}
                                >
                                  ÏÇ≠Ï†ú
                                </button>
                              </div>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            </div>
          )}

          {/* ÌñâÎèô Í∑∏ÎûòÌîÑ / Î∂ÑÏÑù */}
          {view === 'behaviorAnalytics' && (
            <div style={styles.card} className="animate-in">
              <h2 style={styles.h2} className="section-title">üìà ÌñâÎèô Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑù Î∞è ÏãúÍ∞ÅÌôî</h2>

              <div className="chart-actions" style={{ marginBottom: 20 }}>
                <select
                  value={behaviorFilter.chartType}
                  onChange={(e) => setBehaviorFilter({ ...behaviorFilter, chartType: e.target.value })}
                  className="form-select"
                >
                  <option value="daily">ÏùºÎ≥Ñ ÌñâÎèô Î∞úÏÉù ÎπàÎèÑ</option>
                  <option value="weekly">Ï£ºÎ≥Ñ ÌñâÎèô Î∞úÏÉù ÎπàÎèÑ</option>
                  <option value="dayOfWeek">ÏöîÏùºÎ≥Ñ ÌñâÎèô Î∞úÏÉù Î∂ÑÌè¨</option>
                  <option value="period">ÍµêÏãúÎ≥Ñ ÌñâÎèô Î∞úÏÉù Î∂ÑÌè¨</option>
                  <option value="weeklyGoalAchievement">Ï£ºÎ≥Ñ ÏàòÏóÖÎ™©Ìëú ÎèÑÎã¨ ÎπàÎèÑ (3~5Ï†ê)</option>
                  <option value="weeklyEvalFreq">Ï£ºÎ≥Ñ ÌñâÎèôÎ∞úÏÉù ÎπàÎèÑ (1~5Ï†ê)</option>
                  <option value="dailyEvalFreq">ÏùºÎ≥Ñ ÌñâÎèôÎ∞úÏÉù ÎπàÎèÑ (1~5Ï†ê)</option>
                </select>
                <select
                  value={behaviorFilter.dateRange}
                  onChange={(e) => setBehaviorFilter({ ...behaviorFilter, dateRange: parseInt(e.target.value) })}
                  className="form-select"
                >
                  <option value={7}>ÏµúÍ∑º 7Ïùº</option>
                  <option value={30}>ÏµúÍ∑º 30Ïùº</option>
                  <option value={90}>ÏµúÍ∑º 90Ïùº</option>
                  <option value="march1">({new Date().getFullYear()}ÎÖÑ) 3Ïõî 1Ïùº ~ ÌòÑÏû¨</option>
                </select>
                <select
                  value={behaviorFilter.student}
                  onChange={(e) => setBehaviorFilter({ ...behaviorFilter, student: e.target.value })}
                  className="form-select"
                >
                  <option value="ALL">Ï†ÑÏ≤¥ ÌïôÏÉù</option>
                  {behaviorStudents.map(student => (
                    <option key={student} value={student}>{student}</option>
                  ))}
                </select>

                <button
                  style={{ ...styles.btn2, background: 'rgba(16, 185, 129, 0.3)' }}
                  onClick={() => exportChartAsPNG('behaviorLineChart', 'ÌñâÎèôÎπàÎèÑÏ∞®Ìä∏.png')}
                >
                  üìä Ï∞®Ìä∏ PNG Ï†ÄÏû•
                </button>
              </div>

              {state.behaviorLog.length === 0 ? (
                <div style={{ textAlign: 'center', padding: 60, color: 'rgba(255,255,255,0.5)' }}>
                  Î∂ÑÏÑùÌï† ÌñâÎèô Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§. ÌñâÎèô Í∏∞Î°ùÏùÑ Ï∂îÍ∞ÄÌï¥Ï£ºÏÑ∏Ïöî.
                </div>
              ) : filteredBehaviorLog.length === 0 ? (
                <div style={{ textAlign: 'center', padding: 60, color: 'rgba(255,255,255,0.5)' }}>
                  ÏÑ†ÌÉùÌïú Ï°∞Í±¥Ïóê Ìï¥ÎãπÌïòÎäî ÌñâÎèô Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.
                </div>
              ) : (
                <div>
                  {/* ÌÜµÍ≥Ñ ÏöîÏïΩ */}
                  <div style={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))',
                    gap: 16,
                    marginBottom: 30,
                  }}>
                    {(() => {
                      const byType = {};
                      filteredBehaviorLog.forEach(b => {
                        const type = BEHAVIOR_TYPES[b.behaviorType]?.label || b.behaviorType;
                        byType[type] = (byType[type] || 0) + 1;
                      });

                      const sorted = Object.entries(byType).sort((a, b) => b[1] - a[1]);
                      const mostCommon = sorted.length > 0 ? sorted[0] : null;

                      return (
                        <>
                          <div style={{
                            padding: 20,
                            borderRadius: 12,
                            background: 'linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(99, 102, 241, 0.3))',
                            border: '1px solid rgba(59, 130, 246, 0.4)',
                            textAlign: 'center',
                          }}>
                            <div style={{ fontSize: 32, fontWeight: 900, color: '#60a5fa' }}>{filteredBehaviorLog.length}</div>
                            <div style={{ fontSize: 13, color: 'rgba(255,255,255,0.8)' }}>Ï¥ù Í∏∞Î°ù Ïàò</div>
                          </div>
                          <div style={{
                            padding: 20,
                            borderRadius: 12,
                            background: 'linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(5, 150, 105, 0.3))',
                            border: '1px solid rgba(16, 185, 129, 0.4)',
                            textAlign: 'center',
                          }}>
                            <div style={{ fontSize: 32, fontWeight: 900, color: '#10b981' }}>
                              {(() => {
                                if (filteredBehaviorLog.length === 0) return 0;
                                const dayCount = behaviorFilter.dateRange === 'march1'
                                  ? Math.ceil((Date.now() - new Date(new Date().getFullYear(), 2, 1).getTime()) / (24 * 60 * 60 * 1000))
                                  : behaviorFilter.dateRange;
                                return (filteredBehaviorLog.length / dayCount).toFixed(1);
                              })()}
                            </div>
                            <div style={{ fontSize: 13, color: 'rgba(255,255,255,0.8)' }}>ÏùºÌèâÍ∑† Î∞úÏÉù</div>
                          </div>
                          <div style={{
                            padding: 20,
                            borderRadius: 12,
                            background: 'linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(124, 58, 237, 0.3))',
                            border: '1px solid rgba(139, 92, 246, 0.4)',
                            textAlign: 'center',
                          }}>
                            <div style={{ fontSize: 16, fontWeight: 900, color: '#a78bfa' }}>
                              {mostCommon ? mostCommon[0] : '-'}
                            </div>
                            <div style={{ fontSize: 13, color: 'rgba(255,255,255,0.8)' }}>ÏµúÎã§ Î∞úÏÉù</div>
                          </div>
                        </>
                      );
                    })()}
                  </div>

                  {/* Ï∞®Ìä∏: ÏÑ†ÌÉùÎêú Ïú†Ìòï */}
                  <div className="chart-container">
                    <h3 style={{ fontSize: 16, fontWeight: 700, color: 'white', marginBottom: 16 }}>
                      üìä {
                        behaviorFilter.chartType === 'daily' ? 'ÏùºÎ≥Ñ ÌñâÎèô Î∞úÏÉù ÎπàÎèÑ' :
                        behaviorFilter.chartType === 'weekly' ? 'Ï£ºÎ≥Ñ ÌñâÎèô Î∞úÏÉù ÎπàÎèÑ' :
                        behaviorFilter.chartType === 'dayOfWeek' ? 'ÏöîÏùºÎ≥Ñ ÌñâÎèô Î∞úÏÉù Î∂ÑÌè¨' :
                        behaviorFilter.chartType === 'period' ? 'ÍµêÏãúÎ≥Ñ ÌñâÎèô Î∞úÏÉù Î∂ÑÌè¨' :
                        behaviorFilter.chartType === 'weeklyGoalAchievement' ? 'Ï£ºÎ≥Ñ ÏàòÏóÖÎ™©Ìëú ÎèÑÎã¨ ÎπàÎèÑ (3~5Ï†ê)' :
                        behaviorFilter.chartType === 'weeklyEvalFreq' ? 'Ï£ºÎ≥Ñ ÌñâÎèôÎ∞úÏÉù ÎπàÎèÑ (1~5Ï†ê)' :
                        behaviorFilter.chartType === 'dailyEvalFreq' ? 'ÏùºÎ≥Ñ ÌñâÎèôÎ∞úÏÉù ÎπàÎèÑ (1~5Ï†ê)' :
                        'Ï∞®Ìä∏'
                      } (ÌïôÏÉùÎ≥Ñ Ï∂îÏù¥)
                    </h3>
                    <canvas id="behaviorLineChart"></canvas>
                  </div>

                </div>
              )}
            </div>
          )}


          {/* ÏàòÏóÖ Ìé∏Ïßë Î™®Îã¨ */}
          {editingLesson && (
            <div className="modal-overlay" onClick={() => setEditingLesson(null)}>
              <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                <h2 style={{ fontSize: 22, fontWeight: 800, color: 'white', marginBottom: 20 }}>
                  {editingLesson.id ? '‚úèÔ∏è ÏàòÏóÖ ÏàòÏ†ï' : '‚ûï ÏàòÏóÖ Ï∂îÍ∞Ä'}
                </h2>

                <div className="form-field">
                  <label style={{ display: 'block', color: 'rgba(255,255,255,0.8)', marginBottom: 6, fontWeight: 700 }}>ÎÇ†Ïßú</label>
                  <input
                    type="date"
                    value={editingLesson.date ? toLocalDateValue(editingLesson.date) : ''}
                    onChange={(e) => setEditingLesson({ ...editingLesson, date: e.target.value ? new Date(e.target.value).getTime() : null })}
                    className="form-control"
                  />
                </div>

                <div className="form-field">
                  <label style={{ display: 'block', color: 'rgba(255,255,255,0.8)', marginBottom: 6, fontWeight: 700 }}>ÍµêÏãú</label>
                  <select
                    value={editingLesson.period || '1ÍµêÏãú'}
                    onChange={(e) => setEditingLesson({ ...editingLesson, period: e.target.value })}
                    className="form-select"
                  >
                    {PERIODS.map(period => <option key={period} value={period}>{period}</option>)}
                  </select>
                </div>

                <div className="form-field">
                  <label style={{ display: 'block', color: 'rgba(255,255,255,0.8)', marginBottom: 6, fontWeight: 700 }}>Í≥ºÎ™©Î™Ö *</label>
                  <select
                    value={editingLesson.subject || ''}
                    onChange={(e) => setEditingLesson({ ...editingLesson, subject: e.target.value })}
                    className="form-select"
                    style={{
                      background: editingLesson.subject && SUBJECTS[editingLesson.subject]
                        ? SUBJECTS[editingLesson.subject].color
                        : 'rgba(255,255,255,0.1)',
                      color: 'white',
                    }}
                  >
                    <option value="" style={{ background: '#1e293b', color: 'white' }}>Í≥ºÎ™©ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                    {Object.entries(SUBJECTS).map(([subj, data]) => (
                      <option key={subj} value={subj} style={{ background: '#1e293b', color: 'white' }}>
                        {data.label}
                      </option>
                    ))}
                  </select>
                </div>

                <div className="form-field">
                  <label style={{ display: 'block', color: 'rgba(255,255,255,0.8)', marginBottom: 6, fontWeight: 700 }}>Ï†úÏû¨/Îã®Ïõê</label>
                  <input
                    type="text"
                    placeholder="Ïòà: ÎçßÏÖàÍ≥º Î∫ÑÏÖà, Í∞êÏ†ï ÌëúÌòÑÌïòÍ∏∞"
                    value={editingLesson.topic || ''}
                    onChange={(e) => setEditingLesson({ ...editingLesson, topic: e.target.value })}
                    className="form-control"
                  />
                </div>

                <div className="form-field">
                  <label style={{ display: 'block', color: 'rgba(255,255,255,0.8)', marginBottom: 6, fontWeight: 700 }}>Î™©Ìëú</label>
                  <textarea
                    placeholder="Ïòà: ÌïôÏÉùÏùÄ 10 Ïù¥ÌïòÏùò ÏàòÎ•º ÎçîÌïòÍ≥† Î∫Ñ Ïàò ÏûàÎã§."
                    value={editingLesson.goal || ''}
                    onChange={(e) => setEditingLesson({ ...editingLesson, goal: e.target.value })}
                    rows={3}
                    className="form-textarea"
                  />
                </div>

                <div className="form-field">
                  <label style={{ display: 'block', color: 'rgba(255,255,255,0.8)', marginBottom: 6, fontWeight: 700 }}>ÌôúÎèô</label>
                  <textarea
                    placeholder="Ïòà: 1. Ïà´Ïûê Ïπ¥ÎìúÎ°ú Í≤åÏûÑÌïòÍ∏∞ 2. ÏõåÌÅ¨ÏãúÌä∏ ÌôúÎèô 3. ÎßàÎ¨¥Î¶¨ ÌôúÎèô"
                    value={editingLesson.activity || ''}
                    onChange={(e) => setEditingLesson({ ...editingLesson, activity: e.target.value })}
                    rows={4}
                    className="form-textarea"
                  />
                </div>

                {!editingLesson.id && (
                  <div className="form-field">
                    <label style={{ display: 'flex', alignItems: 'center', gap: 8, color: 'rgba(255,255,255,0.8)', fontWeight: 700 }}>
                      <input
                        type="checkbox"
                        checked={editingLesson.repeatWeekly || false}
                        onChange={(e) => setEditingLesson({ ...editingLesson, repeatWeekly: e.target.checked })}
                      />
                      ÏÑ†ÌÉùÌïú Í∏∞Í∞Ñ ÎèôÏïà Îß§Ï£º ÏàòÏóÖÏúºÎ°ú Ï∂îÍ∞Ä
                    </label>
                    {editingLesson.repeatWeekly && (
                      <input
                        type="date"
                        value={editingLesson.repeatUntil || ''}
                        onChange={(e) => setEditingLesson({ ...editingLesson, repeatUntil: e.target.value })}
                        className="form-control"
                      />
                    )}
                  </div>
                )}

                {/* ÌïôÏÉù ÌèâÍ∞Ä ÏÑπÏÖò (ÏàòÏóÖ ÏàòÏ†ï ÏãúÏóêÎßå ÌëúÏãú) */}
                {editingLesson.id && (
                  <div style={{ marginTop: 24, padding: 16, background: 'rgba(0,0,0,0.2)', borderRadius: 12, border: '1px solid rgba(255,255,255,0.1)' }}>
                    <h3 style={{ fontSize: 16, fontWeight: 700, color: 'white', marginBottom: 12 }}>
                      üìä ÌïôÏÉùÎ≥Ñ ÏàòÏóÖÎ™©Ìëú ÌèâÍ∞Ä
                    </h3>
                    <p style={{ fontSize: 12, color: 'rgba(255,255,255,0.7)', marginBottom: 12 }}>
                      ÌèâÍ∞Ä Ï≤ôÎèÑ: 0(Í≤∞ÏÑù) / 1(ÎØ∏Ï∞∏Ïó¨) / 2(ÎØ∏ÎèÑÎã¨) / 3(ÏµúÎåÄÏ¥âÍµ¨) / 4(ÏùºÎ∂ÄÏ¥âÍµ¨) / 5(Î™©ÌëúÎã¨ÏÑ±)
                    </p>
                    <div className="student-eval-grid">
                      <div className="eval-cell" style={{ fontWeight: 900, background: 'rgba(139, 92, 246, 0.3)', color: '#c4b5fd' }}>ÌïôÏÉù</div>
                      {[0, 1, 2, 3, 4, 5].map(score => (
                        <div key={score} className="eval-cell" style={{ fontWeight: 900, background: 'rgba(139, 92, 246, 0.3)', color: '#c4b5fd' }}>
                          <div>{score}Ï†ê</div>
                          <div style={{ fontSize: 9, marginTop: 2 }}>{EVAL_SCORES[score].label}</div>
                        </div>
                      ))}
                      {[1, 2, 3, 4, 5, 6, 7].map(studentNum => {
                        const studentId = `ÌïôÏÉù${studentNum}`;
                        const evalKey = `${editingLesson.id}-${studentId}`;
                        const currentScore = state.studentEvals[evalKey]?.score;
                        return (
                          <React.Fragment key={studentNum}>
                            <div className="eval-cell" style={{ fontWeight: 700, background: 'rgba(59, 130, 246, 0.1)' }}>
                              {studentId}
                            </div>
                            {[0, 1, 2, 3, 4, 5].map(score => (
                              <div
                                key={score}
                                className={`eval-cell eval-score-${score} ${currentScore === score ? 'selected' : ''}`}
                                onClick={() => saveStudentEval(editingLesson.id, studentId, score)}
                                style={{
                                  cursor: 'pointer',
                                  fontWeight: currentScore === score ? 900 : 600,
                                }}
                              >
                                {currentScore === score ? '‚úì' : '-'}
                              </div>
                            ))}
                          </React.Fragment>
                        );
                      })}
                    </div>
                  </div>
                )}

                {/* PBS ÌñâÎèô Í∏∞Î°ù ÏÑπÏÖò (ÏàòÏóÖ ÏàòÏ†ï ÏãúÏóêÎßå ÌëúÏãú) */}
                {editingLesson.id && (
                  <div style={{ marginTop: 16, padding: 16, background: 'rgba(0,0,0,0.2)', borderRadius: 12, border: '1px solid rgba(255,255,255,0.1)' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 12 }}>
                      <h3 style={{ fontSize: 16, fontWeight: 700, color: 'white' }}>
                        üéØ PBS ÌñâÎèô Í∏∞Î°ù
                      </h3>
                      <button
                        style={{ ...styles.btn2, padding: '8px 12px', background: 'rgba(59, 130, 246, 0.3)' }}
                        onClick={() => {
                          const lessonDate = editingLesson.date ? new Date(editingLesson.date) : new Date();
                          setEditingBehavior({
                            timestamp: lessonDate.getTime(),
                            lessonId: editingLesson.id,
                            studentName: '',
                            behaviorType: 'POSITIVE',
                            antecedent: '',
                            behavior: '',
                            consequence: '',
                            frequency: 1,
                            intensity: 1,
                            duration: 0,
                            interventionNote: ''
                          });
                        }}
                      >
                        ‚ûï ÌñâÎèô Í∏∞Î°ù Ï∂îÍ∞Ä
                      </button>
                    </div>
                    <div style={{ maxHeight: 200, overflowY: 'auto' }}>
                      {(() => {
                        const lessonBehaviors = state.behaviorLog.filter(b => b.lessonId === editingLesson.id);
                        return lessonBehaviors.length === 0 ? (
                          <div style={{ textAlign: 'center', padding: 20, color: 'rgba(255,255,255,0.5)', fontSize: 12 }}>
                            Ïù¥ ÏàòÏóÖÏóê ÎåÄÌïú ÌñâÎèô Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§.
                          </div>
                        ) : (
                          <div style={{ display: 'grid', gap: 8 }}>
                            {lessonBehaviors.map(log => (
                              <div
                                key={log.id}
                                style={{
                                  padding: 10,
                                  background: 'rgba(0,0,0,0.2)',
                                  borderRadius: 8,
                                  border: '1px solid rgba(255,255,255,0.1)',
                                  fontSize: 12,
                                }}
                              >
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'start' }}>
                                  <div style={{ flex: 1 }}>
                                    <div style={{ fontWeight: 700, color: BEHAVIOR_TYPES[log.behaviorType]?.color }}>
                                      {BEHAVIOR_TYPES[log.behaviorType]?.icon} {log.studentName}
                                    </div>
                                    <div style={{ color: 'rgba(255,255,255,0.8)', marginTop: 2 }}>
                                      {log.behavior || 'ÌñâÎèô ÎØ∏ÏûÖÎ†•'}
                                    </div>
                                    <div style={{ color: 'rgba(255,255,255,0.6)', fontSize: 10, marginTop: 2 }}>
                                      {log.antecedent || 'ÏÑ†ÌñâÏÇ¨Í±¥ ÎØ∏ÏûÖÎ†•'} ‚Üí {log.consequence || 'ÌõÑÏÜçÍ≤∞Í≥º ÎØ∏ÏûÖÎ†•'}
                                    </div>
                                  </div>
                                  <div style={{ display: 'flex', gap: 4 }}>
                                    <button
                                      style={{ ...styles.btn2, padding: '4px 8px', fontSize: 10, background: 'rgba(251, 191, 36, 0.2)' }}
                                      onClick={() => setEditingBehavior(log)}
                                    >
                                      ‚úèÔ∏è
                                    </button>
                                    <button
                                      style={{ ...styles.btn2, padding: '4px 8px', fontSize: 10, background: 'rgba(239, 68, 68, 0.2)' }}
                                      onClick={() => {
                                        if (confirm('Ïù¥ ÌñâÎèô Í∏∞Î°ùÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                                          setState(p => ({
                                            ...p,
                                            behaviorLog: p.behaviorLog.filter(b => b.id !== log.id)
                                          }));
                                        }
                                      }}
                                    >
                                      üóëÔ∏è
                                    </button>
                                  </div>
                                </div>
                              </div>
                            ))}
                          </div>
                        );
                      })()}
                    </div>
                  </div>
                )}

                <div style={{ display: 'flex', gap: 10, marginTop: 20 }}>
                  <button
                    style={{ ...styles.btn, flex: 1 }}
                    onClick={() => {
                      if (!editingLesson.subject || !editingLesson.date) {
                        alert('Í≥ºÎ™©Î™ÖÍ≥º ÎÇ†ÏßúÎäî ÌïÑÏàòÏûÖÎãàÎã§.');
                        return;
                      }
                      saveLesson(editingLesson);
                    }}
                  >
                    üíæ Ï†ÄÏû•
                  </button>
                  {editingLesson.id && (
                    <button
                      style={{ ...styles.btn, background: 'linear-gradient(135deg, #ef4444, #dc2626)' }}
                      onClick={() => {
                        deleteLesson(editingLesson.id);
                        setEditingLesson(null);
                      }}
                    >
                      üóëÔ∏è ÏÇ≠Ï†ú
                    </button>
                  )}
                  <button
                    style={{ ...styles.btn2, padding: '12px 20px' }}
                    onClick={() => setEditingLesson(null)}
                  >
                    Ï∑®ÏÜå
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* ÏßëÏ§ë Í∏∞Î°ù Ìé∏Ïßë Î™®Îã¨ */}
          {editingFocusHistory && (
            <div className="modal-overlay" onClick={() => setEditingFocusHistory(null)}>
              <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                <h2 style={{ fontSize: 22, fontWeight: 800, color: 'white', marginBottom: 20 }}>
                  ‚úèÔ∏è ÏßëÏ§ë Í∏∞Î°ù ÏàòÏ†ï
                </h2>

                <div className="form-field">
                  <label style={{ display: 'block', color: 'rgba(255,255,255,0.8)', marginBottom: 6, fontWeight: 700 }}>
                    Î©îÎ™®
                  </label>
                  <input
                    type="text"
                    placeholder="ÏßëÏ§ë ÌôúÎèô Î©îÎ™®"
                    value={editingFocusHistory.note || ''}
                    onChange={(e) => setEditingFocusHistory({ ...editingFocusHistory, note: e.target.value })}
                    className="form-control"
                  />
                </div>

                <div className="form-field">
                  <label style={{ display: 'block', color: 'rgba(255,255,255,0.8)', marginBottom: 6, fontWeight: 700 }}>
                    ÏßëÏ§ë ÏãúÍ∞Ñ (Î∂Ñ)
                  </label>
                  <input
                    type="number"
                    min="1"
                    placeholder="ÏßëÏ§ë ÏãúÍ∞Ñ"
                    value={editingFocusHistory.durationMin || ''}
                    onChange={(e) => setEditingFocusHistory({ ...editingFocusHistory, durationMin: parseInt(e.target.value) || 1 })}
                    className="form-control"
                  />
                </div>

                <div style={{ display: 'flex', gap: 10, marginTop: 20 }}>
                  <button style={styles.btn} onClick={saveFocusHistory}>
                    üíæ Ï†ÄÏû•
                  </button>
                  <button style={{ ...styles.btn2, padding: '12px 20px' }} onClick={() => setEditingFocusHistory(null)}>
                    Ï∑®ÏÜå
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* ÏßëÏ§ë ÏôÑÎ£å Î™®Îã¨ */}
          {showFocusComplete && (
            <div className="modal-overlay" onClick={() => {}}>
              <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{ maxWidth: 500 }}>
                <h2 style={{ fontSize: 24, fontWeight: 800, color: 'white', marginBottom: 16, textAlign: 'center' }}>
                  ‚è±Ô∏è ÏßëÏ§ë ÏãúÍ∞Ñ Ï¢ÖÎ£å
                </h2>
                <p style={{ fontSize: 16, color: 'rgba(255,255,255,0.8)', marginBottom: 24, textAlign: 'center' }}>
                  ÏßëÏ§ë ÏãúÍ∞ÑÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§!<br />
                  ÏßëÏ§ëÏóê ÏÑ±Í≥µÌïòÏÖ®ÎÇòÏöî?
                </p>

                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 16, marginTop: 24 }}>
                  <button
                    style={{
                      padding: '20px',
                      background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
                      border: 'none',
                      borderRadius: 12,
                      color: 'white',
                      fontSize: 18,
                      fontWeight: 700,
                      cursor: 'pointer',
                      boxShadow: '0 4px 12px rgba(16, 185, 129, 0.3)',
                      transition: 'all 0.3s',
                    }}
                    onClick={() => completeFocusSession(true)}
                    onMouseEnter={(e) => e.target.style.transform = 'translateY(-2px)'}
                    onMouseLeave={(e) => e.target.style.transform = 'translateY(0)'}
                  >
                    ‚úÖ ÏÑ±Í≥µ<br />
                    <span style={{ fontSize: 12, fontWeight: 400 }}>+100 Ìè¨Ïù∏Ìä∏</span>
                  </button>
                  <button
                    style={{
                      padding: '20px',
                      background: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',
                      border: 'none',
                      borderRadius: 12,
                      color: 'white',
                      fontSize: 18,
                      fontWeight: 700,
                      cursor: 'pointer',
                      boxShadow: '0 4px 12px rgba(239, 68, 68, 0.3)',
                      transition: 'all 0.3s',
                    }}
                    onClick={() => completeFocusSession(false)}
                    onMouseEnter={(e) => e.target.style.transform = 'translateY(-2px)'}
                    onMouseLeave={(e) => e.target.style.transform = 'translateY(0)'}
                  >
                    ‚ùå Ïã§Ìå®<br />
                    <span style={{ fontSize: 12, fontWeight: 400 }}>Ìè¨Ïù∏Ìä∏ ÏóÜÏùå</span>
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* ÏùºÏ†ï Í∏∞Î°ù Ìé∏Ïßë Î™®Îã¨ */}
          {editingScheduleHistory && (
            <div className="modal-overlay" onClick={() => setEditingScheduleHistory(null)}>
              <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                <h2 style={{ fontSize: 22, fontWeight: 800, color: 'white', marginBottom: 20 }}>
                  ‚úèÔ∏è ÏùºÏ†ï Í∏∞Î°ù ÏàòÏ†ï
                </h2>

                <div className="form-field">
                  <label style={{ display: 'block', color: 'rgba(255,255,255,0.8)', marginBottom: 6, fontWeight: 700 }}>
                    ÏùºÏ†ï Ïù¥Î¶Ñ
                  </label>
                  <input
                    type="text"
                    value={editingScheduleHistory.scheduleName}
                    disabled
                    className="form-control"
                    style={{ opacity: 0.6, cursor: 'not-allowed' }}
                  />
                </div>

                <div className="form-field">
                  <label style={{ display: 'block', color: 'rgba(255,255,255,0.8)', marginBottom: 6, fontWeight: 700 }}>
                    Ïã§Ï†ú ÎèÑÏ∞© ÏãúÍ∞Ñ *
                  </label>
                  <input
                    type="datetime-local"
                    value={editingScheduleHistory.arrivalTimeLocal || ''}
                    onChange={(e) => setEditingScheduleHistory({ ...editingScheduleHistory, arrivalTimeLocal: e.target.value })}
                    className="form-control"
                  />
                </div>

                <div style={{ padding: 12, background: 'rgba(59, 130, 246, 0.1)', borderRadius: 8, marginTop: 12 }}>
                  <div style={{ fontSize: 12, color: 'rgba(255,255,255,0.7)' }}>
                    ÏòàÏ†ï ÎèÑÏ∞©: {formatDateTime(editingScheduleHistory.plannedArrivalTime)}
                  </div>
                  <div style={{ fontSize: 12, color: 'rgba(255,255,255,0.5)', marginTop: 4 }}>
                    Ï†ïÏãú ÎèÑÏ∞© Ïãú 100 Ìè¨Ïù∏Ìä∏ ÌöçÎìù
                  </div>
                </div>

                <div style={{ display: 'flex', gap: 10, marginTop: 20 }}>
                  <button style={styles.btn} onClick={saveScheduleHistory}>
                    üíæ Ï†ÄÏû•
                  </button>
                  <button style={{ ...styles.btn2, padding: '12px 20px' }} onClick={() => setEditingScheduleHistory(null)}>
                    Ï∑®ÏÜå
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* ÌñâÎèô Í∏∞Î°ù Ìé∏Ïßë Î™®Îã¨ */}
          {editingBehavior && (
            <div className="modal-overlay" onClick={() => setEditingBehavior(null)}>
              <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                <h2 style={{ fontSize: 22, fontWeight: 800, color: 'white', marginBottom: 20 }}>
                  {editingBehavior.id ? '‚úèÔ∏è ÌñâÎèô Í∏∞Î°ù ÏàòÏ†ï' : '‚ûï ÌñâÎèô Í∏∞Î°ù Ï∂îÍ∞Ä'}
                </h2>

                <div className="form-field">
                  <label style={{ display: 'block', color: 'rgba(255,255,255,0.8)', marginBottom: 6, fontWeight: 700 }}>
                    ÌïôÏÉù Ïù¥Î¶Ñ *
                  </label>
                  <input
                    type="text"
                    placeholder="ÌïôÏÉù Ïù¥Î¶Ñ ÏûÖÎ†•"
                    value={editingBehavior.studentName || ''}
                    onChange={(e) => setEditingBehavior({ ...editingBehavior, studentName: e.target.value })}
                    className="form-control"
                    autoComplete="name"
                    inputMode="text"
                  />
                </div>

                <div className="form-field">
                  <label style={{ display: 'block', color: 'rgba(255,255,255,0.8)', marginBottom: 6, fontWeight: 700 }}>
                    ÌñâÎèô Ïú†Ìòï *
                  </label>
                  <select
                    value={editingBehavior.behaviorType || 'TARGET'}
                    onChange={(e) => setEditingBehavior({ ...editingBehavior, behaviorType: e.target.value })}
                    className="form-select"
                  >
                    {Object.entries(BEHAVIOR_TYPES).map(([key, type]) => (
                      <option key={key} value={key}>{type.icon} {type.label}</option>
                    ))}
                  </select>
                </div>

                <div className="form-field">
                  <label style={{ display: 'block', color: 'rgba(255,255,255,0.8)', marginBottom: 6, fontWeight: 700 }}>
                    ÏÑ†ÌñâÏÇ¨Í±¥ (Antecedent) *
                  </label>
                  <input
                    type="text"
                    placeholder="ÌñâÎèô Ï†Ñ ÏÉÅÌô© (Ïòà: Í≥ºÏ†úÏ†úÏãú, ÎòêÎûòÏÉÅÌò∏ÏûëÏö©)"
                    value={editingBehavior.antecedent || ''}
                    onChange={(e) => setEditingBehavior({ ...editingBehavior, antecedent: e.target.value })}
                    className="form-control"
                    inputMode="text"
                    list="antecedents"
                  />
                  <datalist id="antecedents">
                    {COMMON_ANTECEDENTS.map(a => <option key={a} value={a} />)}
                  </datalist>
                </div>

                <div className="form-field">
                  <label style={{ display: 'block', color: 'rgba(255,255,255,0.8)', marginBottom: 6, fontWeight: 700 }}>
                    ÌñâÎèô (Behavior) *
                  </label>
                  <input
                    type="text"
                    placeholder="Í¥ÄÏ∞∞Îêú ÌñâÎèô (Ïòà: ÏÜåÎ¶¨ÏßÄÎ•¥Í∏∞, ÏûêÎ¶¨Ïù¥ÌÉà)"
                    value={editingBehavior.behavior || ''}
                    onChange={(e) => setEditingBehavior({ ...editingBehavior, behavior: e.target.value })}
                    className="form-control"
                    inputMode="text"
                    list="behaviors"
                  />
                  <datalist id="behaviors">
                    {COMMON_BEHAVIORS.map(b => <option key={b} value={b} />)}
                  </datalist>
                  <div style={{ display: 'flex', gap: 6, flexWrap: 'wrap', marginTop: 8 }}>
                    {COMMON_BEHAVIORS.slice(0, 5).map(b => (
                      <button
                        key={b}
                        style={{ padding: '6px 12px', background: 'rgba(59, 130, 246, 0.2)', border: '1px solid rgba(59, 130, 246, 0.3)', borderRadius: 6, color: 'white', fontSize: 12, cursor: 'pointer' }}
                        onClick={() => setEditingBehavior({ ...editingBehavior, behavior: b })}
                      >
                        {b}
                      </button>
                    ))}
                  </div>
                </div>

                <div className="form-field">
                  <label style={{ display: 'block', color: 'rgba(255,255,255,0.8)', marginBottom: 6, fontWeight: 700 }}>
                    ÌõÑÏÜçÍ≤∞Í≥º (Consequence) *
                  </label>
                  <input
                    type="text"
                    placeholder="ÌñâÎèô ÌõÑ Í≤∞Í≥º (Ïòà: Í¥ÄÏã¨Ï†úÍ≥µ, ÌÜ†ÌÅ∞Ï†úÍ≥µ)"
                    value={editingBehavior.consequence || ''}
                    onChange={(e) => setEditingBehavior({ ...editingBehavior, consequence: e.target.value })}
                    className="form-control"
                    inputMode="text"
                    list="consequences"
                  />
                  <datalist id="consequences">
                    {COMMON_CONSEQUENCES.map(c => <option key={c} value={c} />)}
                  </datalist>
                </div>

                <div className="form-grid">
                  <div>
                    <label style={{ display: 'block', color: 'rgba(255,255,255,0.8)', marginBottom: 6, fontWeight: 700 }}>
                      ÎπàÎèÑ (Ìöå)
                    </label>
                    <input
                      type="number"
                      min="1"
                      value={editingBehavior.frequency || 1}
                      onChange={(e) => setEditingBehavior({ ...editingBehavior, frequency: parseInt(e.target.value) || 1 })}
                      className="form-control"
                      inputMode="numeric"
                      pattern="[0-9]*"
                    />
                  </div>
                  <div>
                    <label style={{ display: 'block', color: 'rgba(255,255,255,0.8)', marginBottom: 6, fontWeight: 700 }}>
                      Í∞ïÎèÑ (1-5)
                    </label>
                    <input
                      type="number"
                      min="1"
                      max="5"
                      value={editingBehavior.intensity || 1}
                      onChange={(e) => setEditingBehavior({ ...editingBehavior, intensity: parseInt(e.target.value) || 1 })}
                      className="form-control"
                      inputMode="numeric"
                      pattern="[0-9]*"
                    />
                  </div>
                  <div>
                    <label style={{ display: 'block', color: 'rgba(255,255,255,0.8)', marginBottom: 6, fontWeight: 700 }}>
                      ÏßÄÏÜçÏãúÍ∞Ñ (Î∂Ñ)
                    </label>
                    <input
                      type="number"
                      min="0"
                      value={editingBehavior.duration || 0}
                      onChange={(e) => setEditingBehavior({ ...editingBehavior, duration: parseInt(e.target.value) || 0 })}
                      className="form-control"
                      inputMode="numeric"
                      pattern="[0-9]*"
                    />
                  </div>
                </div>

                <div className="form-field">
                  <label style={{ display: 'block', color: 'rgba(255,255,255,0.8)', marginBottom: 6, fontWeight: 700 }}>
                    Ï§ëÏû¨ ÎÖ∏Ìä∏ (ÏÑ†ÌÉùÏÇ¨Ìï≠)
                  </label>
                  <textarea
                    placeholder="ÏÇ¨Ïö©Ìïú Ï§ëÏû¨ Ï†ÑÎûµ, Ìö®Í≥º, Ìñ•ÌõÑ Í≥ÑÌöç Îì±ÏùÑ Í∏∞Î°ùÌïòÏÑ∏Ïöî"
                    value={editingBehavior.interventionNote || ''}
                    onChange={(e) => setEditingBehavior({ ...editingBehavior, interventionNote: e.target.value })}
                    rows={4}
                    className="form-textarea"
                  />
                </div>

                <div style={{ display: 'flex', gap: 10, marginTop: 20 }}>
                  <button
                    style={{ ...styles.btn, flex: 1 }}
                    onClick={() => {
                      if (!editingBehavior.studentName || !editingBehavior.behavior || !editingBehavior.antecedent || !editingBehavior.consequence) {
                        alert('ÌïôÏÉù Ïù¥Î¶Ñ, ÏÑ†ÌñâÏÇ¨Í±¥, ÌñâÎèô, ÌõÑÏÜçÍ≤∞Í≥ºÎäî ÌïÑÏàò Ìï≠Î™©ÏûÖÎãàÎã§.');
                        return;
                      }
                      saveBehaviorLog(editingBehavior);
                    }}
                  >
                    üíæ Ï†ÄÏû•
                  </button>
                  {editingBehavior.id && (
                    <button
                      style={{ ...styles.btn, background: 'linear-gradient(135deg, #ef4444, #dc2626)' }}
                      onClick={() => {
                        deleteBehaviorLog(editingBehavior.id);
                        setEditingBehavior(null);
                      }}
                    >
                      üóëÔ∏è ÏÇ≠Ï†ú
                    </button>
                  )}
                  <button
                    style={{ ...styles.btn2, padding: '12px 20px' }}
                    onClick={() => setEditingBehavior(null)}
                  >
                    Ï∑®ÏÜå
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // Error boundary wrapper component
    class ErrorBoundary extends React.Component {
      constructor(props) {
        super(props);
        this.state = { hasError: false, error: null };
      }

      static getDerivedStateFromError(error) {
        return { hasError: true, error };
      }

      componentDidCatch(error, errorInfo) {
        console.error('React Error:', error, errorInfo);
      }

      render() {
        if (this.state.hasError) {
          return (
            <div style={{ padding: 40, background: '#1a1f3a', color: 'white', minHeight: '100vh' }}>
              <h1 style={{ color: '#ef4444' }}>‚ö†Ô∏è Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§</h1>
              <p style={{ marginTop: 20, color: 'rgba(255,255,255,0.8)' }}>
                {this.state.error?.toString()}
              </p>
              <button
                onClick={() => { localStorage.clear(); window.location.reload(); }}
                style={{ marginTop: 20, padding: '12px 24px', background: '#3b82f6', color: 'white', border: 'none', borderRadius: 8, cursor: 'pointer', fontSize: 16 }}
              >
                üîÑ Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî ÌõÑ ÏÉàÎ°úÍ≥†Ïπ®
              </button>
            </div>
          );
        }
        return this.props.children;
      }
    }

    // Render with error handling
    try {
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(
        <ErrorBoundary>
          <App />
        </ErrorBoundary>
      );
    } catch (error) {
      console.error('Failed to render:', error);
      document.getElementById('root').innerHTML = `
        <div style="padding: 40px; background: #1a1f3a; color: white; min-height: 100vh;">
          <h1 style="color: #ef4444;">‚ùå Ï¥àÍ∏∞Ìôî Ïò§Î•ò</h1>
          <p style="margin-top: 20px;">${error.toString()}</p>
          <button onclick="localStorage.clear(); window.location.reload();"
            style="margin-top: 20px; padding: 12px 24px; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
            üîÑ Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî ÌõÑ ÏÉàÎ°úÍ≥†Ïπ®
          </button>
        </div>
      `;
    }
  </script>
</body>
</html>
